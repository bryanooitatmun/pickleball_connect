{% extends 'base.html' %}

{% block extra_styles %}
/* Your existing styles */
.animate-float {
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0% {
    transform: translateY(0px);
  }

  50% {
    transform: translateY(-15px);
  }

  100% {
    transform: translateY(0px);
  }
}

.scroll-section {
  opacity: 0;
  transform: translateY(50px);
  transition: all 1s ease;
}

.scroll-section.active {
  opacity: 1;
  transform: translateY(0);
}

/* Custom CSS for scrollable modal */
.scrollable-modal {
  max-height: 80vh;
  overflow-y: auto;
}

@media (max-width: 640px) {
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }

  .text-right {
    text-align: left;
  }
}

/* Improve modal scrolling on mobile devices */
@media (max-width: 768px) {
  .scrollable-modal {
    padding: 1rem;
    margin: 1rem;
  }

  #calendar {
    font-size: 0.75rem;
  }

  #availability-grid {
    font-size: 0.75rem;
  }

  #selected-timeslots {
    max-height: 30vh;
  }
}

/* Style for the selected date in calendar */
.selected-date {
  background-color: #3b82f6 !important;
  color: white !important;
  font-weight: bold;
}

/* Smooth transition for time slot selection */
#availability-grid>div {
  transition: all 0.2s ease;
}

/* Total cost highlighting */
#current-total {
  font-size: 1.25rem;
}

/* Loading spinner */
.loader {
  border-top-color: #4158D0;
  -webkit-animation: spinner 1.5s linear infinite;
  animation: spinner 1.5s linear infinite;
}

@-webkit-keyframes spinner {
  0% {
    -webkit-transform: rotate(0deg);
  }

  100% {
    -webkit-transform: rotate(360deg);
  }
}

@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/* Tag styling */
.coach-tag {
  display: inline-block;
  background-color: #EBF5FF;
  color: #3B82F6;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-right: 0.5rem;
  margin-bottom: 0.5rem;
}

/* File upload styling */
.file-upload-container {
  border: 2px dashed #e2e8f0;
  border-radius: 0.5rem;
  padding: 1rem;
  text-align: center;
  transition: all 0.3s ease;
}

.file-upload-container:hover {
  border-color: #3B82F6;
}

.file-upload-input {
  display: none;
}

.file-upload-label {
  cursor: pointer;
  display: block;
  width: 100%;
}

.file-preview {
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.file-preview img {
  max-height: 100px;
  max-width: 100%;
  border-radius: 0.25rem;
}

.payment-steps {
  counter-reset: step-counter;
}

.payment-step {
  position: relative;
  padding-left: 2.5rem;
  margin-bottom: 1rem;
}

.payment-step::before {
  content: counter(step-counter);
  counter-increment: step-counter;
  position: absolute;
  left: 0;
  top: 0;
  width: 1.75rem;
  height: 1.75rem;
  border-radius: 50%;
  background-color: #3B82F6;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

/* Credit card styles */
.credit-card {
  background-color: white;
  border-radius: 0.75rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  overflow: hidden;
}

.credit-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
}

.credit-card-header {
  padding: 1.25rem;
  border-bottom: 1px solid #f3f4f6;
}

.credit-card-body {
  padding: 1.25rem;
}

.credit-card-footer {
  padding: 1rem;
  background-color: #f9fafb;
  border-top: 1px solid #f3f4f6;
}

.badge-discount {
  background-color: #fee2e2;
  color: #ef4444;
  border-radius: 9999px;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}

/* Step progression styling */
.step-container {
  position: relative;
  margin-bottom: 2rem;
}

.step-progress {
  display: flex;
  position: relative;
  z-index: 10;
  margin-bottom: 1.5rem;
}

.step-progress::before {
  content: '';
  position: absolute;
  top: 14px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #e5e7eb;
  z-index: -1;
}

.step-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.step-circle {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: #e5e7eb;
  color: #6b7280;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 0.5rem;
  transition: all 0.3s ease;
}

.step-text {
  font-size: 0.875rem;
  color: #6b7280;
  transition: all 0.3s ease;
}

.step-item.active .step-circle {
  background-color: #3b82f6;
  color: white;
}

.step-item.active .step-text {
  color: #3b82f6;
  font-weight: 600;
}

.step-item.completed .step-circle {
  background-color: #10b981;
  color: white;
}

.step-content {
  display: none;
  padding: 1rem 0;
  transition: all 0.3s ease;
}

.step-content.active {
  display: block;
}

/* Coach contact info card */
.contact-card {
  background-color: #f0f9ff;
  border-radius: 0.75rem;
  border-left: 4px solid #3b82f6;
  padding: 1rem;
  margin-top: 1rem;
}

/* Credits summary card */
.credits-summary {
  background-color: #f0f9ff;
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 1rem;
}

.credits-count {
  font-size: 2rem;
  font-weight: bold;
  color: #3b82f6;
}
{% endblock %}

{% block head_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
{% endblock %}

{% block content %}
  <!-- Loading Indicator -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-50 bg-opacity-75 flex items-center justify-center z-50">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
  </div>
  
  <!-- Main Content -->
  <div class="container mx-auto px-6 py-12">
    <!-- Booking Options Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">How Would You Like to Book With This Coach?</h2>
      <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">
        There are two ways to book sessions with our coaches. Choose the option that works best for you.
      </p>
      
      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Direct Booking Option -->
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 flex flex-col h-full">
          <div class="flex items-center mb-4">
            <div class="rounded-full bg-blue-500 p-3 mr-3">
              <i class="fas fa-calendar-check text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-blue-800">Book a Session Now</h3>
          </div>
          
          <div class="text-gray-700 mb-4 flex-grow">
            <p class="mb-3">Choose this option if you:</p>
            <ul class="space-y-2 pl-5 list-disc mb-4">
              <li>Are comfortable booking courts yourself</li>
              <li>Have specific dates and times in mind</li>
              <li>Prefer to schedule individual sessions</li>
            </ul>
            <p class="font-medium text-blue-700">You'll book your court first, then pay the coach.</p>
          </div>
          
          <button id="schedule-btn-main" class="block w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium text-center hover:shadow-lg transform hover:scale-105 transition-all">
            Schedule a Session
          </button>
        </div>
        
        <!-- Credits Option -->
        <div class="bg-green-50 rounded-xl p-6 border border-green-200 flex flex-col h-full">
          <div class="flex items-center mb-4">
            <div class="rounded-full bg-green-500 p-3 mr-3">
              <i class="fas fa-ticket-alt text-white text-xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-green-800">Purchase Credits</h3>
          </div>
          
          <div class="text-gray-700 mb-4 flex-grow">
            <p class="mb-3">Choose this option if you:</p>
            <ul class="space-y-2 pl-5 list-disc mb-4">
              <li>Prefer the coach to help with court booking</li>
              <li>Want more flexibility with scheduling</li>
              <li>Plan to take multiple sessions</li>
            </ul>
            <p class="font-medium text-green-700">Coach will help you find and book available courts.</p>
          </div>
          
          <button id="view-credits-btn-main" class="block w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 rounded-lg font-medium text-center hover:shadow-lg transform hover:scale-105 transition-all">
            View Credit Packages
          </button>
        </div>
      </div>
    </div>
    
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Coach Info Section -->
      <div class="lg:w-1/3">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <!-- Coach profile image -->
          <div id="coach-profile-image" class="flex justify-center mb-6">
            <!-- Profile image will be inserted here by JavaScript -->
            <div class="h-32 w-32 rounded-full bg-blue-100 flex items-center justify-center">
              <span class="text-blue-600 font-bold text-4xl">C</span>
            </div>
          </div>
          
          <!-- Coach details -->
          <h1 id="coach-name" class="text-2xl font-bold text-center mb-2">Loading...</h1>
          
          <div class="flex justify-center mb-4">
            <!-- Rating stars -->
            <div id="coach-rating" class="flex text-yellow-400">
              <!-- Rating stars will be inserted here by JavaScript -->
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
            </div>
            <span id="rating-count" class="text-gray-500 ml-2">(0 reviews)</span>
          </div>
          
          <!-- Coach stats and info -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center">
              <i class="fas fa-dollar-sign w-8 text-blue-500"></i>
              <span id="coach-rate">$0/hour</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-medal w-8 text-blue-500"></i>
              <span id="coach-dupr">DUPR Rating: 0.0</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-history w-8 text-blue-500"></i>
              <span id="coach-experience">0 Years Experience</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-check-circle w-8 text-blue-500"></i>
              <span id="coach-sessions">0 Sessions Completed</span>
            </div>
            <div id="coach-location-container" class="flex items-center hidden">
              <i class="fas fa-map-marker-alt w-8 text-blue-500"></i>
              <span id="coach-location"></span>
            </div>
          </div>
          
          <!-- Coach tags (replacing specialties) -->
          <div id="coach-tags-container" class="mb-6">
            <h3 class="font-semibold mb-2">Specialties</h3>
            <div class="flex flex-wrap">
              {% for tag in coach_tags %}
                <span class="coach-tag">{{ tag.name }}</span>
              {% else %}
                <p class="text-gray-600">No specialties listed</p>
              {% endfor %}
            </div>
          </div>
          
          <!-- Available courts -->
          <div id="coach-courts-container" class="mb-6 hidden">
            <h3 class="font-semibold mb-2">Available at</h3>
            <ul id="coach-courts" class="space-y-1">
              <!-- Courts will be inserted here by JavaScript -->
            </ul>
          </div>

          <!-- Academy affiliations -->
          <div id="coach-academy-container" class="mb-6 hidden">
            <h3 class="font-semibold mb-2">Academy Affiliations</h3>
            <ul id="coach-academies" class="space-y-1">
              <!-- Academy affiliations will be inserted here by JavaScript -->
            </ul>
          </div>
          
          <!-- Actions buttons -->
          <div class="grid grid-cols-1 gap-3">
            <button id="schedule-btn" class="block w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium text-center hover:shadow-lg transform hover:scale-105 transition-all">
              Schedule a Session
            </button>
            
            <!-- Credits button for logged in users -->
            {% if current_user.is_authenticated %}
            <button id="view-credits-btn" class="block w-full bg-white border-2 border-blue-500 text-blue-600 py-3 rounded-lg font-medium text-center hover:bg-blue-50 transition-all">
              View My Credits
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Biography and Showcase Section -->
      <div class="lg:w-2/3">
        <!-- Biography section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
          <h2 class="text-xl font-semibold mb-4">About <span id="coach-first-name">this coach</span></h2>
          <div class="text-gray-700">
            <p id="coach-bio">Loading bio information...</p>
          </div>
        </div>
        
        <!-- Image showcase section -->
        <div id="showcase-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Showcase</h2>
          <div id="showcase-images" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Showcase images will be inserted here by JavaScript -->
          </div>
        </div>
        
        <!-- Coach Credits Section -->
        <div id="coach-credits-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Available Coaching Credits</h2>
          
          <div class="mb-6 bg-green-50 p-5 rounded-lg border border-green-200">
            <h3 class="font-semibold text-green-800 mb-2 flex items-center">
              <i class="fas fa-info-circle mr-2"></i>How Credits Work
            </h3>
            <p class="text-gray-700 mb-3">Credits give you more flexibility for scheduling sessions with your coach:</p>
            
            <ul class="space-y-2 text-gray-700">
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                <span>Your coach will help find and book courts for your sessions</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                <span>Coordinate directly with your coach for the best time and location</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                <span>Save money with package discounts compared to individual sessions</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check text-green-500 mt-1 mr-2"></i>
                <span>Credits are valid for 90 days from purchase</span>
              </li>
            </ul>
          </div>
          
          <div id="coach-credits" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Coach credits will be inserted here by JavaScript -->
            <p class="text-gray-500 text-sm col-span-full">Loading credits...</p>
          </div>
        </div>
        
        <!-- Credits Summary (for logged in users) -->
        {% if current_user.is_authenticated %}
        <div id="credits-summary-container" class="bg-white rounded-xl shadow-sm p-6 mt-4 mb-8 hidden">
          <h3 class="font-semibold mb-4">Your Credits Summary</h3>
          <div id="credits-summary" class="credits-summary">
            <div class="flex items-center justify-between mb-3">
              <span class="text-gray-600">Available Credits:</span>
              <span class="credits-count" id="total-available-credits">0</span>
            </div>
            <div class="text-sm text-gray-500" id="credits-expiry-info">
              <!-- Credits expiry info will be displayed here -->
            </div>
          </div>
          
          <div id="coach-contact-info" class="contact-card hidden">
            <h4 class="font-medium text-gray-800 mb-2">Contact Coach Directly</h4>
            <p class="text-sm text-gray-600 mb-3">Use your credits by contacting the coach to schedule sessions:</p>
            <div class="space-y-2">
              <div class="flex items-center">
                <i class="fas fa-phone-alt text-blue-500 w-6"></i>
                <a href="#" id="coach-phone-link" class="text-blue-600 hover:underline ml-2">Not available</a>
              </div>
              <div class="flex items-center">
                <i class="fas fa-envelope text-blue-500 w-6"></i>
                <a href="#" id="coach-email-link" class="text-blue-600 hover:underline ml-2">Not available</a>
              </div>
              <div class="flex items-center">
                <i class="fab fa-whatsapp text-green-500 w-6"></i>
                <a href="#" id="coach-whatsapp-link" class="text-green-600 hover:underline ml-2">WhatsApp</a>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- My Credits Section (For logged in users) -->
        {% if current_user.is_authenticated %}
        <div id="my-credits-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">My Purchased Credits</h2>
          
          <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
            <h3 class="text-lg font-medium text-blue-800 mb-2">Share Your Availability</h3>
            <p class="text-gray-600 mb-3">Help your coach find suitable times for your sessions. Select days and times when you're typically available:</p>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Days I'm Usually Available</label>
                <div class="grid grid-cols-7 gap-1">
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Mon">Mon</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Tue">Tue</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Wed">Wed</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Thu">Thu</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Fri">Fri</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Sat">Sat</button>
                  <button class="my-day-btn p-1 rounded border border-gray-300 text-xs" data-day="Sun">Sun</button>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Time Preferences</label>
                <div class="grid grid-cols-3 gap-1">
                  <button class="my-time-btn p-1 rounded border border-gray-300 text-xs" data-time="Morning">Morning</button>
                  <button class="my-time-btn p-1 rounded border border-gray-300 text-xs" data-time="Afternoon">Afternoon</button>
                  <button class="my-time-btn p-1 rounded border border-gray-300 text-xs" data-time="Evening">Evening</button>
                </div>
                
                <div class="mt-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Notes for Coach</label>
                  <textarea id="my-availability-notes" class="w-full p-2 border rounded-lg text-sm" placeholder="Any specific dates or additional preferences..."></textarea>
                </div>
              </div>
            </div>
            
            <div class="mt-4 text-right">
              <button id="my-send-availability-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">
                Save Availability
              </button>
            </div>
          </div>
          
          <div id="student-credits" class="space-y-3">
            <p class="text-gray-500 text-sm">Loading your credits...</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div id="schedule-modal"
    class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-3/4 lg:w-3/4 p-6 scrollable-modal">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Schedule a Session</h2>
        <button id="close-schedule-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Booking Steps Progress -->
      <div class="step-container mb-6">
        <div class="step-progress">
          <div class="step-item active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-text">Select Court</div>
          </div>
          <div class="step-item" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-text">Select Date</div>
          </div>
          <div class="step-item" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-text">Select Time</div>
          </div>
        </div>
      </div>

      <!-- Step 1: Court Selection -->
      <div class="step-content active" data-step="1">
        <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200 mb-4">
          <label for="court-select" class="font-bold mb-2 block text-lg text-blue-800">Select a Court</label>
          <p class="mb-4 text-gray-600">Choose a court where you'd like to book your coaching session.</p>
          <select id="court-select"
            class="w-full p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
            <option value="">-- Select a court --</option>
            <!-- Court options will be populated dynamically -->
          </select>
        </div>
        
        <div class="flex justify-end">
          <button id="next-to-date" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all opacity-50 cursor-not-allowed" disabled>
            Continue to Date Selection
          </button>
        </div>
      </div>

      <!-- Step 2: Date Selection -->
      <div class="step-content" data-step="2">
        <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200 mb-4">
          <label class="font-bold mb-2 block text-lg text-blue-800">Select a Date</label>
          <p class="mb-4 text-gray-600">Choose a date for your coaching session.</p>
          
          <div id="calendar-container" class="transition-all duration-300">
            <!-- Month Navigation and Display -->
            <div class="flex justify-between items-center mb-3">
              <button id="prev-month" class="text-gray-700 hover:text-blue-600 transition-colors">&#10094;</button>
              <h3 id="current-month-year" class="text-lg font-bold"></h3>
              <button id="next-month" class="text-gray-700 hover:text-blue-600 transition-colors">&#10095;</button>
            </div>
            
            <!-- Calendar -->
            <div id="calendar" class="grid grid-cols-7 gap-1 text-sm">
              <!-- Calendar days will be dynamically populated here -->
            </div>
          </div>
        </div>
        
        <div class="flex justify-between">
          <button id="back-to-court" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors">
            Back to Court Selection
          </button>
          
          <button id="next-to-time" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all opacity-50 cursor-not-allowed" disabled>
            Continue to Time Selection
          </button>
        </div>
      </div>

      <!-- Step 3: Time Selection -->
      <div class="step-content" data-step="3">
        <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200 mb-4">
          <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-6">
            <!-- Left Column: Time Slots -->
            <div class="md:w-3/5">
              <label class="font-bold mb-2 block text-lg text-blue-800">Select Time Slots</label>
              <h3 id="selected-date" class="text-lg font-bold mb-3"></h3>
              
              <!-- Availability Legend -->
              <div class="flex flex-wrap gap-3 text-xs text-gray-600 mb-2">
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-blue-200 rounded-sm"></div>
                  <span>Available</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-orange-300 rounded-sm"></div>
                  <span>Booked</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-gray-300 rounded-sm"></div>
                  <span>Unavailable</span>
                </div>
              </div>
              
              <!-- Availability Grid -->
              <div id="availability-grid"
                class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-4">
                <!-- Time slots will be populated here -->
              </div>
            </div>
            
            <!-- Right Column: Selected Sessions -->
            <div class="md:w-2/5">
              <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="font-bold mb-3">Selected Sessions</h4>
                
                <!-- Count and Price -->
                <div class="flex justify-between items-center mb-3 bg-blue-50 p-2 rounded">
                  <div class="text-sm font-medium text-blue-800">
                    Sessions: <span id="session-count">0</span>
                  </div>
                  <div class="text-lg font-bold text-blue-600">
                    Total: $<span id="current-total">0</span>
                  </div>
                </div>
                
                <!-- Selected timeslots -->
                <div id="selected-timeslots" class="space-y-2 max-h-40 overflow-y-auto mb-2">
                  <!-- Selected timeslots will be dynamically populated here -->
                  <div class="text-center py-3 text-gray-500">
                    <p>No sessions selected yet</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex justify-between">
          <button id="back-to-date" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors">
            Back to Date Selection
          </button>
          
          <button id="continue-to-booking" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all opacity-50 cursor-not-allowed" disabled>
            Continue to Booking
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Confirmation Modal with Payment Process -->
  <div id="confirmation-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-3/4 max-w-4xl p-8 scrollable-modal">
      <div id="reservation-timer" class="mb-4 hidden"></div>

      <form id="booking-payment-form" enctype="multipart/form-data">
        <h2 class="text-2xl font-bold mb-2 text-gray-800">Complete Your Booking</h2>
        <p class="text-gray-600 mb-4">You are booking <span id="confirmation-session-count" class="font-bold">0</span> sessions.</p>

        <!-- Selected sessions overview -->
        <div id="confirmation-timeslots" class="space-y-3 mb-6">
          <!-- Confirmation timeslots will be dynamically populated here -->
        </div>

        <p class="text-xl font-bold mb-6">Total Price: <span class="text-blue-600">$<span id="total-price">0</span></span></p>

        <!-- Enhanced Payment Instructions -->
        <div class="bg-blue-50 p-6 rounded-lg mb-6">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Payment & Booking Instructions</h3>
          
          <div class="payment-steps">
            <!-- Step 1: Court Booking -->
            <div class="payment-step mb-6">
              <h4 class="font-bold text-lg text-gray-800 mb-2">Court Booking</h4>
              <div id="court-booking-instructions" class="bg-white p-4 rounded-lg mb-3">
                <div class="text-amber-700 bg-amber-50 p-3 rounded-lg mb-3">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <svg class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                    </div>
                    <div class="ml-3">
                      <h5 class="text-sm font-medium">Important Notice</h5>
                      <p class="text-xs mt-1">You need to book the court first before proceeding with coach payment.</p>
                    </div>
                  </div>
                </div>
                
                <p id="court-booking-text" class="text-sm text-gray-700 mb-3">Please book your court at the venue's website using the link below:</p>
                <div id="specific-court-instructions" class="pl-4 border-l-2 border-blue-200 mb-3"></div>
                
                <div id="court-booking-link-box" class="mb-3">
                  <a id="confirmation-court-link" href="#" target="_blank" class="text-blue-600 hover:underline flex items-center">
                    <i class="fas fa-external-link-alt mr-2"></i> Book court now
                  </a>
                </div>
              </div>
              
              <!-- Court Booking Proof Upload -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Court Booking Proof</label>
                <p class="text-sm text-gray-500 mb-2">Upload a screenshot of your court booking confirmation.</p>
                <div class="file-upload-container">
                  <label for="court-booking-proof" class="file-upload-label">
                    <div class="flex flex-col items-center justify-center py-4">
                      <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-sm text-gray-600">Upload screenshot of your court booking</p>
                      <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
                    </div>
                  </label>
                  <input type="file" id="court-booking-proof" name="court_booking_proof" accept="image/*" class="file-upload-input" required>
                  <div id="court-booking-preview" class="file-preview"></div>
                </div>
              </div>
              
              <div class="flex justify-between items-center">
                <button type="button" id="proceed-to-coach-payment" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all">
                  Proceed to Coach Payment
                </button>
              </div>
            </div>
            
            <!-- Step 2: Coach Payment (hidden initially) -->
            <div id="coach-payment-section" class="payment-step mb-6 hidden">
              <h4 class="font-bold text-lg text-gray-800 mb-2">Coach Payment <span id="coach-payment-amount" class="text-blue-600"></span></h4>
              <div id="coach-payment-methods" class="mb-4">
                <div id="bank-transfer-details" class="bg-white p-4 rounded-lg mb-3">
                  <h5 class="font-medium text-gray-800 mb-2">Bank Transfer</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Bank Name:</p>
                      <p id="coach-bank-name" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Account Holder:</p>
                      <p id="coach-account-name" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Account Number:</p>
                      <p id="coach-account-number" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Reference:</p>
                      <p class="font-medium">PBC Coaching</p>
                    </div>
                  </div>
                </div>
                
                <div id="qr-payment-details" class="bg-white p-4 rounded-lg mb-3 hidden">
                  <h5 class="font-medium text-gray-800 mb-2">QR Payment</h5>
                  <div class="flex justify-center">
                    <div id="coach-qr-code" class="w-48 h-48 bg-gray-200 rounded flex items-center justify-center">
                      <span class="text-gray-500">QR Code Loading...</span>
                    </div>
                  </div>
                  <p class="text-center text-sm text-gray-600 mt-2">Scan the QR code to make payment</p>
                </div>
              </div>
              
              <!-- Coach Payment Proof Upload -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Coach Payment Proof</label>
                <p class="text-sm text-gray-500 mb-2">Upload a screenshot of your payment to the coach.</p>
                <div class="file-upload-container">
                  <label for="coach-payment-proof" class="file-upload-label">
                    <div class="flex flex-col items-center justify-center py-4">
                      <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-sm text-gray-600">Upload payment proof</p>
                      <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
                    </div>
                  </label>
                  <input type="file" id="coach-payment-proof" name="coach_payment_proof" accept="image/*" class="file-upload-input" required>
                  <div id="coach-payment-preview" class="file-preview"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col md:flex-row justify-end space-y-3 md:space-y-0 md:space-x-4">
          <button type="button" id="cancel-button" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
            Cancel
          </button>
          <button type="submit" id="confirm-button" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all hidden">
            Complete Booking
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-1/2 max-w-lg p-8 text-center">
      <div class="mb-6">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-2 text-gray-800">Booking Successful!</h2>
      <p class="text-lg text-gray-600 mb-4">Your sessions have been booked successfully.</p>
      <p class="text-sm text-gray-500 mb-6">Confirmation number: <span id="confirmation-number" class="font-bold"></span></p>
      <p class="text-sm text-gray-500 mb-6">A confirmation email has been sent to your email address.</p>
      
      <button id="success-done-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-lg transform hover:scale-105 transition-all">
        Done
      </button>
    </div>
  </div>

  <!-- Credit Purchase Modal -->
  <div id="credit-purchase-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-2/3 max-w-3xl p-8 scrollable-modal">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Purchase Credits</h2>
        <button id="close-credit-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="credit-purchase-form" enctype="multipart/form-data">
        <input type="hidden" id="credit-id" name="package_id">
        <input type="hidden" id="credit-type" name="package_type">
        <input type="hidden" id="credit-coach-id" name="coach_id">
        
        <div class="mb-6">
          <div id="credit-details" class="bg-blue-50 p-6 rounded-lg">
            <!-- Credit details will be populated here -->
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Payment Instructions</h3>
          <div id="credit-payment-details" class="bg-white p-4 rounded-lg mb-4">
            <!-- Payment details will be populated here -->
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-2">Upload Payment Proof</h3>
          <p class="text-sm text-gray-600 mb-4">Please upload proof of your payment for these credits.</p>
          
          <div class="file-upload-container">
            <label for="credit-payment-proof" class="file-upload-label">
              <div class="flex flex-col items-center justify-center py-4">
                <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
              </div>
            </label>
            <input type="file" id="credit-payment-proof" name="payment_proof" accept="image/*" class="file-upload-input" required>
            <div id="credit-payment-preview" class="file-preview"></div>
          </div>
        </div>
        
        <div class="flex justify-end space-x-4">
          <button type="button" id="credit-cancel-button" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
            Cancel
          </button>
          <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all">
            Complete Purchase
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Credit Purchase Success Modal -->
  <div id="credit-success-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-3/4 max-w-2xl p-8">
      <div class="mb-6 text-center">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <h2 class="text-2xl font-bold mb-2 text-gray-800">Credits Purchased Successfully!</h2>
        <p class="text-lg text-gray-600 mb-4">Your credits purchase has been submitted successfully.</p>
        <p class="text-sm text-gray-500 mb-3">The coach will review your payment and activate your credits soon.</p>
      </div>
      
      <div class="mt-6 text-center">
        <button id="credit-success-done-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-lg transform hover:scale-105 transition-all">
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Login/Register Modal -->
  <div id="auth-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-1/2 max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Login Required</h2>
        <button id="close-auth-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="mb-6 text-center">
        <p class="text-gray-600 mb-4">Please login or create an account to continue.</p>
        
        <div class="flex flex-col space-y-3">
          <button class="login-btn w-full bg-blue-600 text-white py-3 rounded-lg font-medium text-center hover:bg-blue-700 transition-colors">
            Login
          </a>
          <button class="register-btn w-full bg-green-600 text-white py-3 rounded-lg font-medium text-center hover:bg-green-700 transition-colors">
            Create Account
          </a>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Password Section Modal -->
  <div id="password-modal"
    class="custom-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 shadow-lg rounded-xl bg-white">
      <div class="text-center">
        <div
          class="h-16 w-16 mx-auto rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mb-6">
          <span class="text-white font-bold text-2xl">P</span>
        </div>
        <h3 class="text-xl font-bold mb-6 text-gray-800">Create Password</h3>
        <div class="absolute top-2 right-2">
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="password-form" class="mt-4">
          <input type="password" id="password" placeholder="Password"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
            pattern=".*\d+.*" required>
          <p class="text-xs text-left text-gray-500 mb-4">Password must be at least 8 characters and include at least
            one number</p>
          <input type="password" id="confirm-password" placeholder="Confirm Password"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
            pattern=".*\d+.*" required>
          <div id="password-match-error" class="text-red-500 text-sm mb-4 hidden">Passwords do not match</div>
          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all">Submit</button>
        </form>
        <p class="mt-4 text-gray-600"><a href="#"
            class="back-to-registration text-blue-500 font-medium hover:underline">Back to registration</a></p>
      </div>
    </div>
  </div>

  <!-- Guest User Info Modal -->
  <div id="guest-info-modal"
    class="custom-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 shadow-lg rounded-xl bg-white">
      <div class="text-center">
        <div
          class="h-16 w-16 mx-auto rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mb-6">
          <span class="text-white font-bold text-2xl">P</span>
        </div>
        <h3 class="text-xl font-bold mb-4 text-gray-800">Enter Your Details</h3>
        <p class="text-gray-600 mb-6">Please enter your information to continue with the booking</p>
        <div class="absolute top-2 right-2">
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="guest-info-form" class="mt-4">
          <input type="text" name="first_name" placeholder="First Name" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="text" name="last_name" placeholder="Last Name" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="email" name="email" placeholder="Email" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="tel" name="phone" placeholder="Phone Number" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="number" name="dupr_rating" placeholder="DUPR Rating (optional)" step="0.1" min="1" max="8"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">

          <div class="mt-6 flex items-center mb-4">
            <input id="create-account-checkbox" type="checkbox"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="create-account-checkbox" class="ml-2 block text-sm text-gray-700">
              Create an account for future bookings
            </label>
          </div>

          <div id="create-account-fields" class="hidden">
            <input type="password" id="guest-password" placeholder="Password"
              class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
              pattern=".*\d+.*">
            <p class="text-xs text-left text-gray-500 mb-4">Password must be at least 8 characters and include at least
              one number</p>
            <input type="password" id="guest-confirm-password" placeholder="Confirm Password"
              class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
              pattern=".*\d+.*">
          </div>

          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all">Continue
            to Booking</button>
        </form>
        <p class="mt-4 text-gray-600">Already have an account? <a href="#"
            class="login-link text-blue-500 font-medium hover:underline">Login</a></p>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- Script for Profile and Booking Functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // DOM Elements
      const loadingOverlay = document.getElementById('loading-overlay');
      const scheduleModal = document.getElementById('schedule-modal');
      const confirmationModal = document.getElementById('confirmation-modal');
      const successModal = document.getElementById('success-modal');
      const creditPurchaseModal = document.getElementById('credit-purchase-modal');
      const creditSuccessModal = document.getElementById('credit-success-modal');
      const authModal = document.getElementById('auth-modal');

      // Coach profile elements
      const coachName = document.getElementById('coach-name');
      const coachFirstName = document.getElementById('coach-first-name');
      const coachRating = document.getElementById('coach-rating');
      const coachRate = document.getElementById('coach-rate');
      const coachSessions = document.getElementById('coach-sessions');
      const coachCourts = document.getElementById('coach-courts');
      const coachTags = document.getElementById('coach-tags');
      const coachBio = document.getElementById('coach-bio');
      const scheduleBtn = document.getElementById('schedule-btn');
      const viewCreditsBtn = document.getElementById('view-credits-btn');

      // Schedule elements
      const courtSelect = document.getElementById('court-select');
      const currentMonthYear = document.getElementById('current-month-year');
      const calendar = document.getElementById('calendar');
      const selectedDate = document.getElementById('selected-date');
      const availabilityGrid = document.getElementById('availability-grid');
      const selectedTimeslots = document.getElementById('selected-timeslots');
      const currentTotal = document.getElementById('current-total');
      const continueToBookingBtn = document.getElementById('continue-to-booking');

      // Step navigation buttons
      const nextToDateBtn = document.getElementById('next-to-date');
      const backToCourtBtn = document.getElementById('back-to-court');
      const nextToTimeBtn = document.getElementById('next-to-time');
      const backToDateBtn = document.getElementById('back-to-date');

      // Payment elements
      const coachBankName = document.getElementById('coach-bank-name');
      const coachAccountName = document.getElementById('coach-account-name');
      const coachAccountNumber = document.getElementById('coach-account-number');
      const qrPaymentDetails = document.getElementById('qr-payment-details');
      const coachQrCode = document.getElementById('coach-qr-code');
      const proceedToCoachPaymentBtn = document.getElementById('proceed-to-coach-payment');
      const coachPaymentSection = document.getElementById('coach-payment-section');
      const confirmButton = document.getElementById('confirm-button');

      // Form file inputs
      const coachPaymentProof = document.getElementById('coach-payment-proof');
      const courtBookingProof = document.getElementById('court-booking-proof');
      const coachPaymentPreview = document.getElementById('coach-payment-preview');
      const courtBookingPreview = document.getElementById('court-booking-preview');
      const bookingPaymentForm = document.getElementById('booking-payment-form');
      
      // Credit purchase elements
      const creditPaymentProof = document.getElementById('credit-payment-proof');
      const creditPaymentPreview = document.getElementById('credit-payment-preview');
      const creditPurchaseForm = document.getElementById('credit-purchase-form');
      const closeCreditModal = document.getElementById('close-credit-modal');
      const creditCancelButton = document.getElementById('credit-cancel-button');
      const creditSuccessDoneBtn = document.getElementById('credit-success-done-btn');

      // Global state
      let coachData = null;
      let selectedCourtId = null;
      let currentDate = new Date();
      let allAvailabilities = {};
      let selectedSlots = [];
      let selectedPackage = null;
      let studentPackages = [];
      let successfulBookingId = null; // Store the ID of a successful booking
      let previousCourtId = null; 
      const isUserLoggedIn = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
      
      // Package data
      let coachCredits = [];
      let currentCreditData = null; // Store the currently selected credit for purchase
      let reservationToken = null;
      let reservationExpiry = null;
      let countdownInterval = null;
      let pendingAction = null; // Store pending action that requires login

      // Utility Functions
      function formatMoney(amount) {
        return parseFloat(amount).toFixed(2);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
      }

      // Generate star rating HTML
      function generateStars(rating) {
        let starsHtml = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        // Add full stars
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="fas fa-star"></i>';
        }

        // Add half star if needed
        if (hasHalfStar) {
          starsHtml += '<i class="fas fa-star-half-alt"></i>';
        }

        // Add empty stars to make 5 total
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) {
          starsHtml += '<i class="far fa-star"></i>';
        }

        return starsHtml;
      }

      // Modal handling
      function showModal(modal) {
        document.querySelectorAll('.custom-modal').forEach(m => {
          m.classList.add('hidden');
        });
        modal.classList.remove('hidden');
      }

      function hideAllModals() {
        document.querySelectorAll('.custom-modal').forEach(modal => {
          modal.classList.add('hidden');
        });
      }

      // Step progression handling
      function showStep(stepNumber) {
        // Update step indicators
        document.querySelectorAll('.step-item').forEach(item => {
          const itemStep = parseInt(item.dataset.step);
          item.classList.remove('active', 'completed');
          
          if (itemStep === stepNumber) {
            item.classList.add('active');
          } else if (itemStep < stepNumber) {
            item.classList.add('completed');
          }
        });
        
        // Show selected step content and hide others
        document.querySelectorAll('.step-content').forEach(content => {
          content.classList.remove('active');
          if (parseInt(content.dataset.step) === stepNumber) {
            content.classList.add('active');
          }
        });
      }

      // Set up file upload previews
      function setupFileUploadPreview(fileInput, previewContainer) {
        if (!fileInput || !previewContainer) return;
        
        fileInput.addEventListener('change', function(e) {
          previewContainer.innerHTML = '';
          
          if (this.files && this.files[0]) {
            const file = this.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'rounded-lg shadow-sm';
              previewContainer.appendChild(img);
            }
            
            reader.readAsDataURL(file);
          }
        });
      }

      // Set up payment preview functionality
      setupFileUploadPreview(coachPaymentProof, coachPaymentPreview);
      setupFileUploadPreview(courtBookingProof, courtBookingPreview);
      setupFileUploadPreview(creditPaymentProof, creditPaymentPreview);

      // Fetch coach data
      async function fetchCoachData(coachId) {
        try {
          console.log("Fetching coach data for ID:", coachId);
          const response = await fetch(`/public/api/coach/${coachId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch coach data');
          }
          
          const coach = await response.json();
          coachData = coach;
          console.log("Coach data received:", coach);
          
          // Update profile image
          const profileImageContainer = document.getElementById('coach-profile-image');
          if (coach.profile_picture) {
            profileImageContainer.innerHTML = `
              <img src="${coach.profile_picture.replace('%5C','/')}" alt="${coach.first_name}" class="h-32 w-32 rounded-full object-cover border-4 border-blue-100">
            `;
          } else {
            profileImageContainer.innerHTML = `
              <div class="h-32 w-32 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-blue-600 font-bold text-4xl">${coach.first_name.charAt(0)}</span>
              </div>
            `;
          }
          
          // Update coach details
          coachName.textContent = `${coach.first_name} ${coach.last_name}`;
          coachFirstName.textContent = coach.first_name;
          coachRate.textContent = `$${coach.hourly_rate}/hour`;
          document.getElementById('coach-dupr').textContent = `DUPR Rating: ${coach.dupr_rating || 'N/A'}`;
          document.getElementById('coach-experience').textContent = `${coach.years_experience || '0'} Years Experience`;
          coachSessions.textContent = `${coach.sessions_completed || '0'} Sessions Completed`;
          coachBio.textContent = coach.biography || 'No biography available.';

          // Format courts list
          const courtNames = coach.courts.map(court => court.name).join(', ');
          coachCourts.textContent = courtNames;

          // Populate court select dropdown
          courtSelect.innerHTML = '<option value="">Select a court</option>';
          coach.courts.forEach(court => {
            const option = document.createElement('option');
            option.value = court.id;
            option.textContent = court.name;
            courtSelect.appendChild(option);
          });
          
          // Update location if available
          if (coach.location) {
            document.getElementById('coach-location').textContent = coach.location;
            document.getElementById('coach-location-container').classList.remove('hidden');
          }
          
          // Update rating stars
          coachRating.innerHTML = generateStars(coach.avg_rating || 0);
          document.getElementById('rating-count').textContent = `(${coach.rating_count || 0} reviews)`;
          
          // Update courts list
          if (coach.courts && coach.courts.length > 0) {
            const courtsContainer = document.getElementById('coach-courts');
            courtsContainer.innerHTML = '';
            
            coach.courts.forEach(court => {
              const courtItem = document.createElement('li');
              courtItem.className = 'flex items-center';
              courtItem.innerHTML = `
                <i class="fas fa-map-pin text-blue-500 mr-2"></i>
                <span>${court.name}</span>
              `;
              courtsContainer.appendChild(courtItem);
            });
            
            document.getElementById('coach-courts-container').classList.remove('hidden');
          }
          
          // Update showcase images
          if (coach.showcase_images && coach.showcase_images.length > 0) {
            const showcaseContainer = document.getElementById('showcase-images');
            showcaseContainer.innerHTML = '';
            
            coach.showcase_images.forEach(imageSrc => {
              const imageDiv = document.createElement('div');
              imageDiv.className = 'rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow';
              imageDiv.innerHTML = `
                <img src="${imageSrc.replace('%5C','/')}" alt="Coaching showcase" class="w-full h-64 object-cover">
              `;
              showcaseContainer.appendChild(imageDiv);
            });
            
            document.getElementById('showcase-container').classList.remove('hidden');
          }
          
          // Update academy affiliations if available
          if (coach.academy_affiliations && coach.academy_affiliations.length > 0) {
            const academiesContainer = document.getElementById('coach-academies');
            academiesContainer.innerHTML = '';
            
            coach.academy_affiliations.forEach(academy => {
              const academyItem = document.createElement('li');
              academyItem.className = 'flex items-center';
              academyItem.innerHTML = `
                <i class="fas fa-university text-blue-500 mr-2"></i>
                <span>${academy.name} ${academy.role ? `- ${academy.role}` : ''}</span>
              `;
              academiesContainer.appendChild(academyItem);
            });
            
            document.getElementById('coach-academy-container').classList.remove('hidden');
          }
          
          // Set payment information in confirmation modal
          updateCoachPaymentInfo();
          
          // Fetch coach credits (packages renamed to credits)
          fetchCoachCredits(coachId);
          
          // Fetch student credits if user is logged in
          if (isUserLoggedIn) {
            fetchStudentCredits();
            document.getElementById('credits-summary-container').classList.remove('hidden');
          }

          // Update coach contact information in success modals
          //updateCoachContactInfo();

          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
        } catch (error) {
          console.error('Error fetching coach data:', error);
          coachBio.textContent = 'Failed to load coach information. Please try again later.';
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
        }
      }
      
      // Fetch coach credits (former packages)
      async function fetchCoachCredits(coachId) {
        try {
          const response = await fetch(`/api/coach/pricing-plans/${coachId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch coach credits');
          }
          
          const packages = await response.json();
          coachCredits = packages.filter(pkg => pkg.discount_type === 'package');
          
          // Update credits UI
          updateCoachCreditsUI();
        } catch (error) {
          console.error('Error fetching coach credits:', error);
          const coachCreditsContainer = document.getElementById('coach-credits-container');
          if (coachCreditsContainer) {
            const creditsContainer = document.getElementById('coach-credits');
            creditsContainer.innerHTML = `
              <p class="text-sm text-red-500 col-span-full">Could not load coaching credits. Please try again later.</p>
            `;
          }
        }
      }
      
      // When a student selects time slots and clicks "Continue to Booking"
      async function reserveSelectedSlots() {
          try {
              // Show loading spinner
              loadingOverlay.classList.remove('hidden');
              
              const availabilityIds = selectedSlots.map(slot => slot.availabilityId);
              
              if (availabilityIds.length === 0) {
                  alert('Please select at least one time slot');
                  loadingOverlay.classList.add('hidden');
                  return false;
              }

              // Make reservation request
              const response = await fetch('/booking/api/reserve-slots', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      availability_ids: availabilityIds
                  })
              });
              
              const data = await response.json();
              
              if (!response.ok) {
                  // Handle error - another student may have booked the slot
                  if (response.status === 409) {
                      // Conflict - slot no longer available
                      alert(`The slot at ${data.start_time} ${data.availability_date} is no longer available. Please choose different times.`);
                      
                      // Refresh availability display
                      await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());

                      if (selectedDate.dataset.date) {
                        populateAvailabilityGrid(selectedDate.dataset.date);
                      }

                      // Remove the unavailable slot from selection
                      if (data.availability_id) {
                          // Find and remove the slot
                          selectedSlots = selectedSlots.filter(slot => slot.availabilityId !== data.availability_id);
                          updateSelectedTimeslotsUI();
                          updateTotalPrice();
                          const sessionCount = document.getElementById('session-count');
                          sessionCount.textContent = selectedSlots.length;
                      }

                      loadingOverlay.classList.add('hidden');
                      return false;
                  } else {
                      alert(data.error || 'Failed to reserve time slots');
                      loadingOverlay.classList.add('hidden');
                      return false;
                  }
              }
              
              // Store reservation token for booking submission
              reservationToken = data.reservation_token;
              reservationExpiry = new Date(data.expires_at + 'Z');
              
              // Clear any existing countdown
              if (countdownInterval) {
                  clearInterval(countdownInterval);
              }

              // Start countdown timer
              startReservationCountdown();
              
              // Show confirmation modal
              populateConfirmationModal();
              hideAllModals();
              showModal(confirmationModal);
              
              loadingOverlay.classList.add('hidden');
              return true;
              
          } catch (error) {
              console.error('Error reserving slots:', error);
              alert('An error occurred while submitting your booking. Please try again.');
              loadingOverlay.classList.add('hidden');
              return false;
          }
      }

      // Add a countdown timer to show when reservation expires
      function startReservationCountdown() {
          const timerElement = document.getElementById('reservation-timer');
          if (!timerElement) return;
          
          timerElement.classList.remove('hidden');
          
          countdownInterval = setInterval(() => {
              const now = Date.now();

              const timeRemaining = Math.max(0, Math.floor((reservationExpiry - now) / 1000));

              if (timeRemaining <= 0) {
                  clearInterval(countdownInterval);
                  timerElement.innerHTML = `<div class="bg-red-100 text-red-700 p-2 rounded border border-red-300">
                      <i class="fas fa-exclamation-circle mr-1"></i> Reservation expired! Please go back and select time slots again.
                  </div>`;
                  
                  // Disable booking button
                  if (confirmButton) {
                      confirmButton.disabled = true;
                      confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                      confirmButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-600');
                  }
                  
                  return;
              }
              
              const minutes = Math.floor(timeRemaining / 60);
              const seconds = timeRemaining % 60;
              
              timerElement.innerHTML = `<div class="bg-blue-50 p-2 rounded border border-blue-200 ${timeRemaining < 60 ? 'text-red-600' : 'text-blue-600'}">
                  <i class="fas fa-clock mr-1"></i> Your reservation expires in <strong>${minutes}:${seconds.toString().padStart(2, '0')}</strong>
              </div>`;
          }, 1000);
      }

      // Update coach credits UI (formerly packages)
      function updateCoachCreditsUI() {
        const container = document.getElementById('coach-credits-container');
        const creditsContainer = document.getElementById('coach-credits');
        
        if (!container || !creditsContainer) return;
        
        if (!coachCredits || coachCredits.length === 0) {
          container.classList.add('hidden');
          return;
        }
        
        // Show container
        container.classList.remove('hidden');
        
        // Clear previous content
        creditsContainer.innerHTML = '';
        
        // Create a card for each credit package
        coachCredits.forEach(pkg => {
          const discount_type_amount = pkg.percentage_discount  
            ? 'percentage' 
            : 'fixed';

          const discountText = discount_type_amount === 'percentage' 
            ? `${pkg.percentage_discount}% off` 
            : `$${pkg.fixed_discount} off`;
          
          // Calculate original price and discounted price
          const originalPrice = coachData.hourly_rate * pkg.sessions_required;
          let discountedPrice = originalPrice;
          
          if (discount_type_amount === 'percentage') {
            discountedPrice = originalPrice * (1 - pkg.percentage_discount / 100);
          } else if (discount_type_amount === 'fixed') {
            discountedPrice = originalPrice - pkg.fixed_discount;
          }
          
          // Calculate savings
          const savings = originalPrice - discountedPrice;
          const savingsPercent = Math.round((savings / originalPrice) * 100);
          
          const creditCard = document.createElement('div');
          creditCard.className = 'credit-card';
          creditCard.innerHTML = `
            <div class="credit-card-header">
              <h3 class="text-lg font-bold text-gray-800">${pkg.name}</h3>
              <p class="text-sm text-gray-600">${pkg.description || 'Coaching credit package'}</p>
            </div>
            <div class="credit-card-body">
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Sessions:</span>
                <span class="font-medium">${pkg.sessions_required}</span>
              </div>
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Original Price:</span>
                <span class="font-medium line-through text-gray-600">$${formatMoney(originalPrice)}</span>
              </div>
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Credit Price:</span>
                <span class="font-bold text-green-600">$${formatMoney(discountedPrice)}</span>
              </div>
              <div class="mb-4">
                <span class="badge-discount">${discountText} (Save ${savingsPercent}%)</span>
              </div>
              <div class="text-sm text-gray-600">
                <p>Valid for 90 days after purchase</p>
              </div>
            </div>
            <div class="credit-card-footer">
              <button class="w-full py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all buy-credit-btn" data-credit-id="${pkg.id}">
                Buy Credits
              </button>
            </div>
          `;
          
          creditsContainer.appendChild(creditCard);
        });
        
        // Add event listeners to the buy buttons
        document.querySelectorAll('.buy-credit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const creditId = parseInt(this.getAttribute('data-credit-id'));
            
            // Check if user is logged in
            if (!isUserLoggedIn) {
              // Store the credit ID for after login
              pendingAction = {
                type: 'buy-credit',
                creditId: creditId
              };
              
              // Show login modal
              showModal(authModal);
              return;
            }
            
            // Find the credit package
            const creditData = coachCredits.find(p => p.id === creditId);
            
            if (creditData) {
              openCreditPurchaseModal(creditData);
            }
          });
        });
      }
      
      async function fetchStudentCredits() {
        if (!isUserLoggedIn) return;
        
        try {
          // Fetch credits that can be used with this coach
          const response = await fetch(`/api/student/packages?coach_id=${coachData.id}`);
          if (!response.ok) {
            throw new Error('Failed to fetch credits');
          }
          
          const data = await response.json();
          studentPackages = data;
          
          // Update the credits UI
          updateStudentCreditsUI();
          
          // Update credits summary
          updateCreditsSummary();
          
          // Show coach contact if there are active credits
          const hasActiveCredits = studentPackages.some(pkg => pkg.status === 'active' && (pkg.total_sessions - pkg.sessions_booked) > 0);
          if (hasActiveCredits) {
            updateCoachContactInfo(true); // true = show in summary section
          }
        } catch (error) {
          console.error('Error fetching student credits:', error);
          const creditsContainer = document.getElementById('student-credits');
          if (creditsContainer) {
            creditsContainer.innerHTML = `
              <p class="text-sm text-red-500">Could not load your credits. Please try again later.</p>
            `;
          }
        }
      }
      
      function updateCreditsSummary() {
        const totalAvailableCredits = document.getElementById('total-available-credits');
        const creditsExpiryInfo = document.getElementById('credits-expiry-info');
        
        if (!totalAvailableCredits || !creditsExpiryInfo) return;
        
        // Calculate total available credits
        let totalCredits = 0;
        let nearestExpiry = null;
        
        studentPackages.forEach(pkg => {
          if (pkg.status === 'active') {
            const remainingCredits = pkg.total_sessions - pkg.sessions_booked;
            totalCredits += remainingCredits;
            
            // Track nearest expiry date
            if (remainingCredits > 0 && pkg.expires_at) {
              const expiryDate = new Date(pkg.expires_at);
              if (!nearestExpiry || expiryDate < nearestExpiry.date) {
                nearestExpiry = {
                  date: expiryDate,
                  credits: remainingCredits
                };
              }
            }
          }
        });
        
        // Update UI
        totalAvailableCredits.textContent = totalCredits;
        
        // Show expiry warning if applicable
        if (nearestExpiry) {
          const now = new Date();
          const daysToExpiry = Math.ceil((nearestExpiry.date - now) / (1000 * 60 * 60 * 24));
          
          if (daysToExpiry <= 30) {
            creditsExpiryInfo.innerHTML = `
              <div class="flex items-start mt-2">
                <i class="fas fa-exclamation-circle text-amber-500 mt-1 mr-2"></i>
                <div>
                  <p class="text-amber-600 font-medium">${nearestExpiry.credits} credits expiring soon!</p>
                  <p class="text-gray-600">Use before ${nearestExpiry.date.toLocaleDateString()}</p>
                </div>
              </div>
            `;
          } else {
            creditsExpiryInfo.innerHTML = `
              <p class="text-gray-600 mt-2">Next expiry: ${nearestExpiry.date.toLocaleDateString()}</p>
            `;
          }
        } else {
          creditsExpiryInfo.innerHTML = '';
        }
      }

      function updateStudentCreditsUI() {
        const container = document.getElementById('my-credits-container');
        const creditsContainer = document.getElementById('student-credits');
        
        if (!container || !creditsContainer) return;
        
        // Show container
        container.classList.remove('hidden');
        
        // Hide container if no credits
        if (!studentPackages || studentPackages.length === 0) {
          creditsContainer.innerHTML = `
            <p class="text-gray-500">You don't have any credits with this coach.</p>
          `;
          return;
        }
        
        // Clear previous content
        creditsContainer.innerHTML = '';
        
        // Group credits by status
        const activeCredits = [];
        const pendingCredits = [];
        const expiredCredits = [];
        
        studentPackages.forEach(pkg => {
          if (pkg.status === 'active') {
            activeCredits.push(pkg);
          } else if (pkg.status === 'pending') {
            pendingCredits.push(pkg);
          } else {
            expiredCredits.push(pkg);
          }
        });
        
        // Create section for active credits
        if (activeCredits.length > 0) {
          const activeSectionHeader = document.createElement('h3');
          activeSectionHeader.className = 'font-semibold text-lg text-gray-800 mb-3';
          activeSectionHeader.textContent = 'Active Credits';
          creditsContainer.appendChild(activeSectionHeader);
          
          activeCredits.forEach(credit => {
            const sessionsRemaining = credit.total_sessions - credit.sessions_booked;
            const expiryDate = credit.expires_at ? new Date(credit.expires_at).toLocaleDateString() : 'Never';
            
            const creditDiv = document.createElement('div');
            creditDiv.className = 'bg-white p-4 rounded-lg border border-green-200 hover:shadow-md transition-all mb-3';
            
            creditDiv.innerHTML = `
              <div class="flex justify-between mb-1">
                <div>
                  <span class="font-semibold">${credit.pricing_plan.name}</span>
                  <div class="mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Active</span>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-blue-700">${sessionsRemaining} sessions remaining</span>
                  <p class="text-xs text-gray-500 mt-1">Expires: ${expiryDate}</p>
                </div>
              </div>
              <div class="flex flex-wrap justify-between items-center mt-2">
                <p class="text-sm text-gray-600">Purchase date: ${new Date(credit.purchase_date).toLocaleDateString()}</p>
                <a href="#" class="text-sm px-3 py-1 text-blue-600 hover:underline contact-coach-btn">
                  Contact Coach to Schedule
                </a>
              </div>
            `;
            
            creditsContainer.appendChild(creditDiv);
          });
        }
        
        // Create section for pending credits
        if (pendingCredits.length > 0) {
          const pendingSectionHeader = document.createElement('h3');
          pendingSectionHeader.className = 'font-semibold text-lg text-gray-800 mb-3 mt-6';
          pendingSectionHeader.textContent = 'Pending Credits';
          creditsContainer.appendChild(pendingSectionHeader);
          
          pendingCredits.forEach(credit => {
            const creditDiv = document.createElement('div');
            creditDiv.className = 'bg-white p-4 rounded-lg border border-yellow-200 hover:shadow-md transition-all mb-3';
            
            creditDiv.innerHTML = `
              <div class="flex justify-between mb-1">
                <div>
                  <span class="font-semibold">${credit.pricing_plan.name}</span>
                  <div class="mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-gray-700">${credit.total_sessions} sessions</span>
                  <p class="text-xs text-gray-500 mt-1">Submitted: ${new Date(credit.purchase_date).toLocaleDateString()}</p>
                </div>
              </div>
              <p class="text-sm text-gray-600 mt-2">Awaiting coach approval. Please check back later.</p>
            `;
            
            creditsContainer.appendChild(creditDiv);
          });
        }
        
        // Create section for expired/used credits
        if (expiredCredits.length > 0) {
          const expiredSectionHeader = document.createElement('h3');
          expiredSectionHeader.className = 'font-semibold text-lg text-gray-800 mb-3 mt-6';
          expiredSectionHeader.textContent = 'Past Credits';
          creditsContainer.appendChild(expiredSectionHeader);
          
          expiredCredits.forEach(credit => {
            const creditDiv = document.createElement('div');
            creditDiv.className = 'bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-all mb-3';
            
            let statusBadge = '';
            if (credit.status === 'expired') {
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">Expired</span>`;
            } else if (credit.status === 'completed') {
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Completed</span>`;
            } else {
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">${credit.status}</span>`;
            }
            
            creditDiv.innerHTML = `
              <div class="flex justify-between mb-1">
                <div>
                  <span class="font-semibold">${credit.pricing_plan.name}</span>
                  <div class="mt-1">
                    ${statusBadge}
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-gray-700">${credit.sessions_booked}/${credit.total_sessions} sessions used</span>
                  <p class="text-xs text-gray-500 mt-1">Expired: ${credit.expires_at ? new Date(credit.expires_at).toLocaleDateString() : 'N/A'}</p>
                </div>
              </div>
            `;
            
            creditsContainer.appendChild(creditDiv);
          });
        }
        
        // Add event listeners to contact buttons
        document.querySelectorAll('.contact-coach-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            // Scroll to contact info
            const contactInfo = document.getElementById('coach-contact-info');
            if (contactInfo) {
              contactInfo.scrollIntoView({ behavior: 'smooth' });
              // Highlight temporarily
              contactInfo.classList.add('ring-2', 'ring-blue-500');
              setTimeout(() => {
                contactInfo.classList.remove('ring-2', 'ring-blue-500');
              }, 1500);
            }
          });
        });
      }

      // Open credit purchase modal
      function openCreditPurchaseModal(creditData) {
        currentCreditData = creditData;
        
        // Set hidden form fields
        document.getElementById('credit-id').value = creditData.id;
        document.getElementById('credit-type').value = 'coach';
        document.getElementById('credit-coach-id').value = coachData.id;
        
        // Calculate pricing details
        const hourlyRate = coachData.hourly_rate;
        
        const originalPrice = hourlyRate * creditData.sessions_required;
        let discountedPrice = originalPrice;
        
        const discount_type_amount = creditData.percentage_discount  
          ? 'percentage' 
          : 'fixed';

        if (discount_type_amount === 'percentage') {
          discountedPrice = originalPrice * (1 - creditData.percentage_discount / 100);
        } else if (discount_type_amount === 'fixed') {
          discountedPrice = originalPrice - creditData.fixed_discount;
        }
        
        // Fill credit details
        const creditDetails = document.getElementById('credit-details');
        creditDetails.innerHTML = `
          <h3 class="text-xl font-bold text-gray-800 mb-4">${creditData.name}</h3>
          <p class="text-gray-600 mb-4">${creditData.description || 'Purchase coaching session credits'}</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold text-gray-700 mb-2">Credit Details</h4>
              <ul class="space-y-2">
                <li class="flex justify-between">
                  <span class="text-gray-600">Coach:</span>
                  <span class="font-medium">${coachData.first_name} ${coachData.last_name}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Sessions Included:</span>
                  <span class="font-medium">${creditData.sessions_required}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Regular Price:</span>
                  <span class="font-medium line-through text-gray-500">${formatMoney(originalPrice)}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Discount:</span>
                  <span class="font-medium text-green-600">${discount_type_amount === 'percentage' ? `${creditData.percentage_discount}%` : `${formatMoney(creditData.fixed_discount)}`}</span>
                </li>
              </ul>
            </div>
            
            <div>
              <h4 class="font-semibold text-gray-700 mb-2">Credit Benefits</h4>
              <ul class="space-y-1 text-gray-600">
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Save ${Math.round(((originalPrice - discountedPrice) / originalPrice) * 100)}% off regular price</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Valid for 90 days after purchase</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Direct communication with coach to schedule sessions</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Coach can help book courts for your sessions</span>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-gray-800">Total Credits Price:</span>
              <span class="text-xl font-bold text-blue-600">${formatMoney(discountedPrice)}</span>
            </div>
          </div>
        `;
        
        // Fill payment details
        const paymentDetails = document.getElementById('credit-payment-details');
        if (coachData.payment_info) {
          const paymentInfo = coachData.payment_info;
          
          paymentDetails.innerHTML = `
            <h4 class="font-medium text-gray-800 mb-4">Please transfer the payment to:</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-600 mb-1">Bank Name:</p>
                <p class="font-medium">${paymentInfo.bank_name || 'Please ask coach'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Account Holder:</p>
                <p class="font-medium">${paymentInfo.account_name || `${coachData.first_name} ${coachData.last_name}`}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Account Number:</p>
                <p class="font-medium">${paymentInfo.account_number || 'Please ask coach'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Reference:</p>
                <p class="font-medium">PBC Credits: ${creditData.name}</p>
              </div>
            </div>
            <p class="font-bold text-blue-700 mt-4">Amount to pay: ${formatMoney(discountedPrice)}</p>
          `;
          
          // Add QR code if available
          if (paymentInfo.qr_code_url) {
            paymentDetails.innerHTML += `
              <div class="mt-4 p-4 border border-gray-200 rounded-lg">
                <h5 class="font-medium text-gray-800 mb-2">QR Payment</h5>
                <div class="flex justify-center">
                  <img src="${paymentInfo.qr_code_url}" alt="Payment QR Code" class="h-48 object-contain">
                </div>
                <p class="text-center text-sm text-gray-600 mt-2">Scan the QR code to make payment</p>
              </div>
            `;
          }
        } else {
          // Fallback payment instructions
          paymentDetails.innerHTML = `
            <h4 class="font-medium text-gray-800 mb-4">Payment Instructions</h4>
            <p class="text-gray-600 mb-2">Please contact ${coachData.first_name} ${coachData.last_name} for payment details.</p>
            <p class="font-bold text-blue-700 mt-2">Amount to pay: ${formatMoney(discountedPrice)}</p>
            <p class="text-sm text-gray-500 mt-4">After your payment is confirmed, you'll receive the coach's contact information to schedule your sessions.</p>
          `;
        }
        
        // Show the modal
        showModal(creditPurchaseModal);
      }
      
      // Update coach contact information
      async function updateCoachContactInfo(inSummary = false, forceLoad = false) {
        // Only fetch contact info if student has credits or just purchased (forceLoad)
        const hasActiveCredits = studentPackages && studentPackages.some(pkg => 
          pkg.status === 'active' && (pkg.total_sessions - pkg.sessions_booked) > 0
        );
        
        if (!hasActiveCredits && !forceLoad) {
          // Hide contact info if no active credits and not just purchased
          if (inSummary) {
            const contactCard = document.getElementById('coach-contact-info');
            if (contactCard) contactCard.classList.add('hidden');
          }
          return;
        }
        
        // We need to fetch coach contact info - it's not included in the initial coach data
        try {
          // Only fetch if we don't already have it
          if (!coachData.phone_number || !coachData.email || forceLoad) {
            const response = await fetch(`/api/coach/contact/${coachData.id}`);
            
            if (response.ok) {
              const contactData = await response.json();
              // Update coach data with contact info
              coachData.phone_number = contactData.phone_number;
              coachData.email = contactData.email;
            } else {
              console.log('Could not load coach contact details. Student may not have active credits.');
              return;
            }
          }
          
          // Prepare the contact information
          const phone = coachData.phone_number;
          const email = coachData.email;
          
          // Create whatsapp link if phone is available
          const whatsappLink = phone ? `https://wa.me/${phone.replace(/\D/g, '')}` : '#';
          
          // Determine which contact elements to update
          let phoneElement, emailElement, whatsappElement, contactCard;
          
          if (inSummary) {
            // Update in the credits summary section
            phoneElement = document.getElementById('coach-phone-link');
            emailElement = document.getElementById('coach-email-link');
            whatsappElement = document.getElementById('coach-whatsapp-link');
            contactCard = document.getElementById('coach-contact-info');
          } else {
            // Update in the credit success modal
            phoneElement = document.getElementById('success-coach-phone');
            emailElement = document.getElementById('success-coach-email');
            whatsappElement = document.getElementById('success-coach-whatsapp');
            contactCard = document.getElementById('credit-success-contact');
          }
          
          // Update the elements if they exist
          if (phoneElement) {
            if (phone) {
              phoneElement.textContent = phone;
              phoneElement.href = `tel:${phone}`;
            } else {
              phoneElement.textContent = 'Not available';
              phoneElement.href = '#';
            }
          }
          
          if (emailElement) {
            if (email) {
              emailElement.textContent = email;
              emailElement.href = `mailto:${email}`;
            } else {
              emailElement.textContent = 'Not available';
              emailElement.href = '#';
            }
          }
          
          if (whatsappElement) {
            whatsappElement.href = whatsappLink;
          }
          
          // Show contact card
          if (contactCard) {
            contactCard.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error fetching coach contact info:', error);
        }
      }
      
      // Add this function to handle credit purchase submission
      async function submitCreditPurchase(event) {
        event.preventDefault();
        
        if (!isUserLoggedIn) {
          alert('Please log in to purchase credits.');
          return;
        }
        
        try {
          // Show loading overlay
          loadingOverlay.classList.remove('hidden');
          
          // Get form data
          const formData = new FormData(creditPurchaseForm);
          
          // Verify payment proof is uploaded
          if (!creditPaymentProof.files[0]) {
            alert('Please upload payment proof for the credits.');
            loadingOverlay.classList.add('hidden');
            return;
          }
          
          // Send the credit purchase request
          const response = await fetch('/api/packages/purchase', {
            method: 'POST',
            body: formData
          });
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to purchase credits');
          }
          
          const result = await response.json();
          
          // Show success message
          hideAllModals();
          
          // Update coach contact information in success modal - force load contact info
          //updateCoachContactInfo(false, true);
          
          // Show credit success modal
          showModal(creditSuccessModal);
          
          // Reset form
          creditPurchaseForm.reset();
          creditPaymentPreview.innerHTML = '';
          
          // Refresh student credits
          fetchStudentCredits();
          return result;
          
        } catch (error) {
          console.error('Error purchasing credits:', error);
          loadingOverlay.classList.add('hidden');
          alert(`Credits purchase failed: ${error.message}`);
        }
      }

      function setSelectedDate(dateStr) {
        const dateObj = new Date(dateStr);
        // Format for display
        selectedDate.textContent = dateObj.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Store the original date string in a data attribute for easy access
        selectedDate.dataset.date = dateStr;
      }

      // Generate calendar for given month/year
      function generateCalendar(year, month) {
        calendar.innerHTML = ""; // Clear previous calendar

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay(); // 0 (Sunday) to 6 (Saturday)

        // Update month/year display
        currentMonthYear.textContent = new Intl.DateTimeFormat('en-US', {
          month: 'long',
          year: 'numeric'
        }).format(firstDay);

        // Create day name headers
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        dayNames.forEach(day => {
          const dayCell = document.createElement("div");
          dayCell.textContent = day;
          dayCell.className = "mt-3 p-2 text-center font-bold";
          calendar.appendChild(dayCell);
        });

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "text-center text-gray-400";
          calendar.appendChild(emptyCell);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format: YYYY-MM-DD

          const cell = document.createElement("div");
          cell.textContent = day;
          cell.className = "text-center p-2 rounded-lg";
          cell.dataset.date = dateStr; // Add data attribute for the date

          // Determine if this date has availability data
          const hasAvailabilityData = allAvailabilities[dateStr] &&
            (allAvailabilities[dateStr].available.length > 0 ||
              allAvailabilities[dateStr].booked.length > 0);

          // Disable past dates
          if (dateObj < new Date().setHours(0, 0, 0, 0)) {
            cell.className += " bg-gray-200 text-gray-400 cursor-not-allowed";
          }
          // If court is selected and has availability
          else if (selectedCourtId && hasAvailabilityData) {
            cell.className += " bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer";
            cell.addEventListener("click", () => {
              // Remove previous selection
              document.querySelectorAll("#calendar div.selected-date").forEach(div => {
                div.classList.remove("selected-date");
              });

              // Add selection to this date
              cell.classList.add("selected-date");

              // Get the date from the data attribute
              const dateStr = cell.dataset.date;

              // Update selected date display
              setSelectedDate(dateStr);

              // Populate available time slots
              populateAvailabilityGrid(dateStr);
              
              // Enable next button
              if (nextToTimeBtn) {
                nextToTimeBtn.disabled = false;
                nextToTimeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              }
            });
          }
          // No availability data yet or no court selected
          else {
            cell.className += " bg-gray-200 text-gray-500 cursor-not-allowed";
          }

          calendar.appendChild(cell);
        }
      }

      // Fetch availability data for the selected court and date
      async function fetchAvailability(courtId, year, month) {
        try {
          // Reset all availabilities for this month
          allAvailabilities = {};

          // Create dates for all days in the month
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format: YYYY-MM-DD

            // Don't fetch for past dates
            if (date < new Date().setHours(0, 0, 0, 0)) {
              continue;
            }

            // Fetch availability from API
            const response = await fetch(`/booking/api/availability/${coachData.id}/${courtId}/${dateStr}`);

            if (!response.ok) {
              console.error(`Failed to fetch availability for ${dateStr}`);
              continue;
            }

            const data = await response.json();

            // Store availability data (but ignore court fees and pricing plans as per new design)
            allAvailabilities[dateStr] = {
              available: data.available || [],
              booked: data.booked || []
            };
          }

          // Regenerate calendar now that we have availability data
          generateCalendar(year, month);

        } catch (error) {
          console.error('Error fetching availability:', error);
        }
      }

      // Populate availability grid for selected date
      function populateAvailabilityGrid(date) {
        // Define the hours to display in the grid
        const hours = [
          "08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", 
          "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", 
          "04:00 PM", "05:00 PM", "06:00 PM", "07:00 PM",
          "08:00 PM", "09:00 PM", "10:00 PM", "11:00 PM"
        ];

        availabilityGrid.innerHTML = ""; // Clear previous slots

        // Update the selectedDate element with the correctly formatted date
        const displayDate = new Date(date);
        selectedDate.textContent = displayDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        // Create a map of availability status for each hour
        const hourStatus = {};
        
        // Initialize all hours as not available
        hours.forEach(hour => {
          hourStatus[hour] = { status: 'unavailable', slotId: null };
        });
        
        // If we have availability data for the selected date, update the status
        if (allAvailabilities[date]) {
          const availability = allAvailabilities[date];
          
          // Mark available slots
          availability.available.forEach(slot => {
            if (hours.includes(slot.time)) {
              hourStatus[slot.time] = { 
                status: 'available', 
                slotId: slot.id
              };
            }
          });
          
          // Mark booked slots
          availability.booked.forEach(slot => {
            if (hours.includes(slot.time)) {
              hourStatus[slot.time] = { 
                status: 'booked', 
                slotId: null
              };
            }
          });
        }
        
        // Create a time slot element for each hour in our predefined hours array
        hours.forEach(hour => {
          const timeSlot = document.createElement("div");
          timeSlot.className = "p-2 rounded-lg text-center text-sm"; // Default styling
          
          // Create inner content with time
          const timeText = document.createElement("div");
          timeText.textContent = hour;
          
          const status = hourStatus[hour].status;
          const slotId = hourStatus[hour].slotId;

          // Find if this slot is in our selected slots
          const isSelected = selectedSlots.some(slot =>
            slot.date === date && slot.time === hour && slot.courtId === selectedCourtId
          );

          if (isSelected) {
            timeSlot.className += " bg-blue-500 text-white cursor-pointer";
            timeSlot.addEventListener("click", () => removeSelectedSlot(date, hour, selectedCourtId));
          }
          else if (status === 'available') {
            timeSlot.className += " bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer";
            timeSlot.addEventListener("click", () => addSelectedSlot(date, hour, slotId, selectedCourtId));
          }
          else if (status === 'booked') {
            timeSlot.className += " bg-orange-300 text-white cursor-not-allowed";
          }
          else {
            timeSlot.className += " bg-gray-300 text-gray-500 cursor-not-allowed";
          }
          
          timeSlot.prepend(timeText);
          availabilityGrid.appendChild(timeSlot);
        });
        
        // Display a message if there's no data for this date
        if (!allAvailabilities[date]) {
          availabilityGrid.innerHTML = "<p class='text-center text-gray-500 py-4'>No availability data for this date.</p>";
          return;
        } else if (Object.values(hourStatus).every(status => status.status === 'unavailable')) {
          availabilityGrid.innerHTML = "<p class='text-center text-gray-500 py-4'>No time slots available on this date.</p>";
          return;
        }
      }
      
      // Add a selected time slot
      function addSelectedSlot(date, time, availabilityId, courtId) {
        // Check if already selected
        if (selectedSlots.some(slot => slot.date === date && slot.time === time && slot.courtId === courtId)) {
          return;
        }

        const courtName = courtSelect.options[courtSelect.selectedIndex].text;

        // Calculate total price (coach fee only)
        const totalPrice = parseFloat(coachData.hourly_rate);

        selectedSlots.push({
          date,
          time,
          availabilityId,
          courtId,
          courtName,
          coach_fee: parseFloat(coachData.hourly_rate),
          price: totalPrice,
          discounted_price: totalPrice // Will be updated if discount applied
        });

        // Update session count
        const sessionCount = document.getElementById('session-count');
        if (sessionCount) {
          sessionCount.textContent = selectedSlots.length;
        }

        // Update UI
        updateSelectedTimeslotsUI();
        updateTotalPrice();

        // Refresh the availability grid
        populateAvailabilityGrid(date);
        
        // Enable continue button if at least one slot is selected
        if (continueToBookingBtn && selectedSlots.length > 0) {
          continueToBookingBtn.disabled = false;
          continueToBookingBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Remove a selected time slot
      function removeSelectedSlot(date, time, courtId) {
        selectedSlots = selectedSlots.filter(slot =>
          !(slot.date === date && slot.time === time && slot.courtId === courtId)
        );

        // Update session count
        const sessionCount = document.getElementById('session-count');
        if (sessionCount) {
          sessionCount.textContent = selectedSlots.length;
        }

        // Update pricing and UI
        updateSelectedTimeslotsUI();
        updateTotalPrice();

        // Refresh the availability grid
        populateAvailabilityGrid(date);
        
        // Disable continue button if no slots selected
        if (continueToBookingBtn && selectedSlots.length === 0) {
          continueToBookingBtn.disabled = true;
          continueToBookingBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      // Update the selected timeslots UI
      function updateSelectedTimeslotsUI() {
        const container = document.getElementById('selected-timeslots');
        container.innerHTML = "";

        if (selectedSlots.length === 0) {
          // Show a message when no slots are selected
          const emptyMessage = document.createElement("div");
          emptyMessage.className = "text-gray-500 text-sm italic text-center py-2";
          emptyMessage.textContent = "No sessions selected yet";
          container.appendChild(emptyMessage);
          return;
        }

        // Sort slots by date and time
        const sortedSlots = [...selectedSlots].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });

        // Create UI elements for each selected slot
        sortedSlots.forEach(slot => {
          const slotDiv = document.createElement("div");
          slotDiv.className = "flex justify-between items-center bg-blue-100 text-blue-800 px-3 py-2 rounded-lg text-sm mb-2";

          // Format price display
          let priceDisplay = '';
          if (slot.discounted_price < slot.price) {
            // Show discount
            priceDisplay = `<span class="line-through text-gray-500">${slot.price.toFixed(2)}</span> ${slot.discounted_price.toFixed(2)}`;
          } else {
            priceDisplay = `${slot.price.toFixed(2)}`;
          }

          slotDiv.innerHTML = `
      <div>
        <div class="font-medium">${formatDate(slot.date)}</div>
        <div>${slot.time} at <span class="font-semibold">${slot.courtName}</span></div>
      </div>
      <div class="flex items-center space-x-2">
        <div class="font-medium">${priceDisplay}</div>
        <button class="text-red-500 hover:text-red-700 p-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    `;

          // Add remove button functionality
          const removeButton = slotDiv.querySelector('button');
          removeButton.addEventListener('click', () => {
            removeSelectedSlot(slot.date, slot.time, slot.courtId);
          });

          container.appendChild(slotDiv);
        });
      }

      // Update total price display
      function updateTotalPrice() {
        // Calculate total with any discounts applied
        const grandTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.discounted_price), 0);

        // Update display
        currentTotal.textContent = formatMoney(grandTotal);

        // Also update the confirmation modal if open
        const totalPriceElement = document.getElementById('total-price');
        if (totalPriceElement) {
          totalPriceElement.textContent = formatMoney(grandTotal);
        }
        
        // Update coach payment amount in confirmation modal
        const coachPaymentAmount = document.getElementById('coach-payment-amount');
        if (coachPaymentAmount) {
          coachPaymentAmount.textContent = `(${formatMoney(grandTotal)})`;
        }
      }

      // Populate confirmation modal
      function populateConfirmationModal() {
        const container = document.getElementById('confirmation-timeslots');
        container.innerHTML = "";
        
        // Sort slots by date and time
        const sortedSlots = [...selectedSlots].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });

        // Create UI elements for each selected slot
        sortedSlots.forEach(slot => {
          const slotDiv = document.createElement("div");
          slotDiv.className = "bg-blue-100 text-blue-800 px-4 py-3 rounded-lg mb-2";

          slotDiv.innerHTML = `
            <div class="flex justify-between">
              <div>
                <span class="font-medium">${formatDate(slot.date)} at ${slot.time}</span>
                <div class="text-sm">${slot.courtName}</div>
              </div>
              <div class="font-bold">${formatMoney(slot.price)}</div>
            </div>
          `;

          container.appendChild(slotDiv);
        });

        // Calculate total
        const grandTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.price), 0);

        // Update session count if available
        const sessionCountElement = document.getElementById('confirmation-session-count');
        if (sessionCountElement) {
          sessionCountElement.textContent = selectedSlots.length;
        }
        
        // Update total price
        document.getElementById('total-price').textContent = formatMoney(grandTotal);
        
        // Update coach payment amount
        const coachPaymentAmount = document.getElementById('coach-payment-amount');
        if (coachPaymentAmount) {
          coachPaymentAmount.textContent = `(${formatMoney(grandTotal)})`;
        }

        // Update court booking instructions
        updateCourtBookingInstructions();
        
        // Initially hide the coach payment section and confirm button
        if (coachPaymentSection) {
          coachPaymentSection.classList.add('hidden');
        }
        
        if (confirmButton) {
          confirmButton.classList.add('hidden');
        }
        
        // Make court booking proof required
        if (courtBookingProof) {
          courtBookingProof.required = true;
        }
      }

      // Update court booking instructions in the confirmation modal
      function updateCourtBookingInstructions() {
        const specificCourtInstructions = document.getElementById('specific-court-instructions');
        const courtBookingLinkBox = document.getElementById('court-booking-link-box');
        const confirmationCourtLink = document.getElementById('confirmation-court-link');
        
        if (!specificCourtInstructions || !selectedCourtId) return;
        
        // Get the selected court
        const selectedCourt = coachData.courts.find(court => court.id === parseInt(selectedCourtId));
        if (!selectedCourt) return;
        
        // Group slots by court and date
        const courtDateMap = new Map();
        
        selectedSlots.forEach(slot => {
          const courtKey = `${slot.courtId}-${slot.date}`;
          if (!courtDateMap.has(courtKey)) {
            courtDateMap.set(courtKey, {
              courtName: slot.courtName,
              date: slot.date,
              times: []
            });
          }
          
          const entry = courtDateMap.get(courtKey);
          entry.times.push(slot.time);
        });
        
        // Clear previous content
        specificCourtInstructions.innerHTML = '';
        
        // Create list items for each court and date
        courtDateMap.forEach(entry => {
          const prettyDate = new Date(entry.date).toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          });
          
          // Format each time with start-end (assuming 1 hour sessions)
          const formattedTimes = entry.times.map(time => {
            const startTimeParts = time.match(/(\d+):(\d+) ([AP]M)/);
            
            if (startTimeParts) {
              let startHour = parseInt(startTimeParts[1]);
              const startMinute = parseInt(startTimeParts[2]);
              const period = startTimeParts[3];
              
              // Convert to 24-hour format
              if (period === 'PM' && startHour < 12) startHour += 12;
              if (period === 'AM' && startHour === 12) startHour = 0;
              
              // Calculate end time (add 1 hour)
              let endHour = startHour + 1;
              let endPeriod = period;
              
              // Handle period change
              if (endHour === 12 && period === 'AM') endPeriod = 'PM';
              else if (endHour === 24) {
                endHour = 12;
                endPeriod = 'AM';
              }
              // Convert back to 12-hour format
              if (endHour > 12) endHour -= 12;
              
              const endTime = `${endHour}:${startMinute.toString().padStart(2, '0')} ${endPeriod}`;
              return `${time}-${endTime}`;
            } else {
              return time;
            }
          });
          
          const listItem = document.createElement('div');
          listItem.className = 'mb-3';
          listItem.innerHTML = `
            <p class="font-medium">${prettyDate} at ${entry.courtName}</p>
            <p class="text-sm">Times: ${formattedTimes.join(', ')}</p>
          `;
          
          specificCourtInstructions.appendChild(listItem);
        });
        
        // Add booking link if available
        if (selectedCourt.booking_link) {
          confirmationCourtLink.href = selectedCourt.booking_link;
          courtBookingLinkBox.classList.remove('hidden');
        } else {
          courtBookingLinkBox.classList.add('hidden');
        }
      }

      function updateCoachPaymentInfo() {
        // Check if we have payment info in coach data
        if (coachData.payment_info) {
          const paymentInfo = coachData.payment_info;
          
          // Bank transfer details
          if (paymentInfo.bank_name && paymentInfo.account_name && paymentInfo.account_number) {
            const coachBankName = document.getElementById('coach-bank-name');
            const coachAccountName = document.getElementById('coach-account-name');
            const coachAccountNumber = document.getElementById('coach-account-number');
            
            if (coachBankName) coachBankName.textContent = paymentInfo.bank_name;
            if (coachAccountName) coachAccountName.textContent = paymentInfo.account_name;
            if (coachAccountNumber) coachAccountNumber.textContent = paymentInfo.account_number;
            
            document.getElementById('bank-transfer-details').classList.remove('hidden');
          } else {
            // Fallback values
            const coachBankName = document.getElementById('coach-bank-name');
            const coachAccountName = document.getElementById('coach-account-name');
            const coachAccountNumber = document.getElementById('coach-account-number');
            
            if (coachBankName) coachBankName.textContent = "Example Bank";
            if (coachAccountName) coachAccountName.textContent = `${coachData.first_name} ${coachData.last_name}`;
            if (coachAccountNumber) coachAccountNumber.textContent = "Please ask coach";
          }
          
          // QR code if available
          if (paymentInfo.qr_code_url) {
            const coachQrCode = document.getElementById('coach-qr-code');
            const qrPaymentDetails = document.getElementById('qr-payment-details');
            
            if (coachQrCode) {
              coachQrCode.innerHTML = `<img src="${paymentInfo.qr_code_url}" alt="Payment QR Code" class="w-full h-full object-contain">`;
            }
            if (qrPaymentDetails) {
              qrPaymentDetails.classList.remove('hidden');
            }
          }
        } else {
          // Fallback values if no payment info
          const coachBankName = document.getElementById('coach-bank-name');
          const coachAccountName = document.getElementById('coach-account-name');
          const coachAccountNumber = document.getElementById('coach-account-number');
          
          if (coachBankName) coachBankName.textContent = "Example Bank";
          if (coachAccountName) coachAccountName.textContent = `${coachData.first_name} ${coachData.last_name}`;
          if (coachAccountNumber) coachAccountNumber.textContent = "Please ask coach";
        }
      }

      // Add this function to handle booking submissions with payment proofs
      async function submitBooking(userData = null) {
        try {
          // Show loading overlay
          loadingOverlay.classList.remove('hidden');
          
          if (!reservationToken) {
              alert('Your session has expired. Please go back and select time slots again.');
              loadingOverlay.classList.add('hidden');
              return;
          }

          // Prepare the FormData object for file uploads
          const formData = new FormData();
          formData.append('reservation_token', reservationToken);

          // Get the file inputs
          const coachPaymentProofFile = document.getElementById('coach-payment-proof').files[0];
          const courtBookingProofFile = document.getElementById('court-booking-proof')?.files[0];
          
          // Append files if available
          if (coachPaymentProofFile) {
            formData.append('coach_payment_proof', coachPaymentProofFile);
          } else {
            throw new Error('Coach payment proof is required');
          }
          
          // Check if court booking proof is provided
          if (!courtBookingProofFile) {
            throw new Error('Court booking proof is required');
          } else {
            formData.append('court_booking_proof', courtBookingProofFile);
          }
          
          // Group availabilities by court
          const courtAvailabilities = {};
          
          selectedSlots.forEach(slot => {
            if (!courtAvailabilities[slot.courtId]) {
              courtAvailabilities[slot.courtId] = [];
            }
            courtAvailabilities[slot.courtId].push(slot.availabilityId);
          });
          
          // Prepare the bookings data
          const bookingsData = Object.keys(courtAvailabilities).map(courtId => ({
            coach_id: coachData.id,
            court_id: parseInt(courtId),
            availability_ids: courtAvailabilities[courtId],
            package_id: selectedPackage ? selectedPackage.id : null
          }));
          
          // Add the bookings data to the form
          formData.append('bookings', JSON.stringify(bookingsData));
          
          // Add user data if provided (for guest booking)
          if (userData) {
            formData.append('user_data', JSON.stringify(userData));
          }
          
          // Send the booking request to a new endpoint that handles file uploads
          const response = await fetch('/booking/api/bookings/create-with-proofs', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          if (!response.ok) {
              // Handle specific error codes
              if (result.code === 'RESERVATION_EXPIRED') {
                  alert('Your reservation has expired. Please go back and select time slots again.');
                  hideAllModals();
                  showModal(scheduleModal);
              } else if (result.code === 'SLOT_UNAVAILABLE') {
                  alert('One or more selected slots are no longer available. Please choose different times.');
                  hideAllModals();
                  showModal(scheduleModal);
                  
                  // Refresh availability
                  await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
                  if (selectedDate.dataset.date) {
                      populateAvailabilityGrid(selectedDate.dataset.date);
                  }
              } else {
                  alert(result.error || 'Booking failed. Please try again.');
              }
              
              loadingOverlay.classList.add('hidden');
              return;
          }
          
          // Store the booking ID for reference
          successfulBookingId = result.bookings && result.bookings.length > 0 
            ? result.bookings[0].id 
            : null;
          
          // Clear countdown timer
          if (countdownInterval) {
              clearInterval(countdownInterval);
          }

          // Show success message
          hideAllModals();
          
          // Update confirmation number in success modal
          document.getElementById('confirmation-number').textContent = result.confirmation_number;
          
          // Show success modal
          showModal(successModal);
          
          // Reset state
          selectedSlots = [];
          selectedPackage = null;
          selectedCourtId = null;
          reservationToken = null;
          reservationExpiry = null;
          
          return result;
          
        } catch (error) {
          console.error('Error creating booking:', error);
          loadingOverlay.classList.add('hidden');
          alert(`Booking failed: ${error.message}`);
          throw error;
        }
      }

      // Event Listeners

      // Booking path selection
      document.getElementById('schedule-btn-main').addEventListener('click', () => {
        showModal(scheduleModal);
        showStep(1);
        
        // Initialize calendar for the current month
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
      });
      
      document.getElementById('view-credits-btn-main').addEventListener('click', () => {
        if (isUserLoggedIn) {
          document.getElementById('coach-credits-container').classList.remove('hidden');
          document.getElementById('coach-credits-container').scrollIntoView({ behavior: 'smooth' });
        } else {
          pendingAction = {
            type: 'view-credits'
          };
          showModal(authModal);
        }
      });
      
      // Day and time selection in availability selector
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('bg-green-600');
          this.classList.toggle('text-white');
        });
      });
      
      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('bg-green-600');
          this.classList.toggle('text-white');
        });
      });
      
      // Add event listeners for day and time selection in My Credits section
      document.querySelectorAll('.my-day-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('bg-blue-600');
          this.classList.toggle('text-white');
        });
      });
      
      document.querySelectorAll('.my-time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('bg-blue-600');
          this.classList.toggle('text-white');
        });
      });
      
      // Send availability from My Credits section
      document.getElementById('my-send-availability-btn')?.addEventListener('click', async function() {
        // Get selected days
        const selectedDays = [];
        document.querySelectorAll('.my-day-btn.bg-blue-600').forEach(btn => {
          selectedDays.push(btn.dataset.day);
        });
        
        // Get selected times
        const selectedTimes = [];
        document.querySelectorAll('.my-time-btn.bg-blue-600').forEach(btn => {
          selectedTimes.push(btn.dataset.time);
        });
        
        // Get notes
        const notes = document.getElementById('my-availability-notes').value.trim();
        
        // Check if anything is selected
        if (selectedDays.length === 0 && selectedTimes.length === 0 && !notes) {
          alert('Please select at least one day, time preference, or add notes.');
          return;
        }
        
        // Show loading state on button
        const originalButtonText = this.innerHTML;
        this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Sending...`;
        this.disabled = true;
        
        try {
          // Send API request
          const response = await fetch('/api/student/send-availability', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              coach_id: coachData.id,
              days: selectedDays,
              times: selectedTimes,
              notes: notes
            })
          });
          
          // Reset button
          this.innerHTML = originalButtonText;
          this.disabled = false;
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to send availability');
          }
          
          // Show success message
          const successBox = document.createElement('div');
          successBox.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded';
          successBox.innerHTML = `
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <p>Your availability preferences have been saved!</p>
            </div>
          `;
          
          // Insert success message before the button's parent element
          const buttonContainer = this.parentElement;
          buttonContainer.parentElement.insertBefore(successBox, buttonContainer);
          
          // Remove success message after 5 seconds
          setTimeout(() => {
            successBox.remove();
          }, 5000);
          
        } catch (error) {
          console.error('Error sending availability:', error);
          
          // Show error message
          const errorBox = document.createElement('div');
          errorBox.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded';
          errorBox.innerHTML = `
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
              <p>${error.message || 'An error occurred. Please try again.'}</p>
            </div>
          `;
          
          // Insert error message before the button's parent element
          const buttonContainer = this.parentElement;
          buttonContainer.parentElement.insertBefore(errorBox, buttonContainer);
          
          // Remove error message after 5 seconds
          setTimeout(() => {
            errorBox.remove();
          }, 5000);
          
          // Reset button
          this.innerHTML = originalButtonText;
          this.disabled = false;
        }
      });

      // Close modal buttons
      document.getElementById('close-schedule-modal').addEventListener('click', () => {
        hideAllModals();
      });
      
      document.getElementById('close-auth-modal').addEventListener('click', () => {
        hideAllModals();
      });

      // Step navigation
      nextToDateBtn.addEventListener('click', () => {
        showStep(2);
      });
      
      backToCourtBtn.addEventListener('click', () => {
        showStep(1);
      });
      
      nextToTimeBtn.addEventListener('click', () => {
        showStep(3);
      });
      
      backToDateBtn.addEventListener('click', () => {
        showStep(2);
      });

      // Court selection change
      courtSelect.addEventListener('change', async function () {
        const newCourtId = parseInt(this.value);
        
        if (selectedSlots.length >= 1) {
          if (window.confirm("You can only book sessions at one court at a time. Your previous selected bookings will be removed. Continue?")) {
            // Reset state
            selectedSlots = [];
            selectedPackage = null;
            updateSelectedTimeslotsUI();
            updateTotalPrice();
            
            // Set the new court ID
            selectedCourtId = newCourtId;
            
            // Store the new selection
            previousCourtId = newCourtId;
          } else {
            // User canceled, revert to previous selection
            this.value = previousCourtId || "";
            return; // Exit the function
          }
        } else {
          // No slots selected, just update the court ID
          selectedCourtId = newCourtId;
          previousCourtId = newCourtId;
        }

        // Enable/disable next button based on selection
        if (nextToDateBtn) {
          if (selectedCourtId) {
            nextToDateBtn.disabled = false;
            nextToDateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            nextToDateBtn.disabled = true;
            nextToDateBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }

        if (selectedCourtId) {
          // Show loading animations for calendar
          animateElementUpdate(document.getElementById('calendar-container'), true);
          animateElementUpdate(document.getElementById('availability-grid'), true);

          // Wait for availability data to be fetched
          await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
          availabilityGrid.innerHTML = "";
          selectedDate.textContent = "";

          const sessionCount = document.getElementById('session-count');
          sessionCount.textContent = 0;

          // Update the UI components
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

          // Remove loading animations
          animateElementUpdate(document.getElementById('calendar-container'), false);
          animateElementUpdate(document.getElementById('availability-grid'), false);
          
          // Add completion animation
          animateCompletion();

        } else {
          allAvailabilities = {};

          // Show loading animations
          animateElementUpdate(document.getElementById('calendar-container'), true);
          animateElementUpdate(document.getElementById('availability-grid'), true);

          // Update UI
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

          // Clear availability grid
          availabilityGrid.innerHTML = "";
          selectedDate.textContent = "";

          // Remove loading animations
          animateElementUpdate(document.getElementById('calendar-container'), false);
          animateElementUpdate(document.getElementById('availability-grid'), false);
        }
      });

      // Animation helper functions
      function animateElementUpdate(element, isLoading) {
        if (!element) return;

        if (isLoading) {
          // Apply loading state
          element.classList.add('animate-pulse', 'opacity-60');

          // Optional: add a subtle background flash
          element.classList.add('transition-colors', 'duration-500');
          element.dataset.originalBg = element.style.backgroundColor || 'transparent';
          element.style.backgroundColor = 'rgba(219, 234, 254, 0.4)'; // light blue background
        } else {
          // Remove loading state
          element.classList.remove('animate-pulse', 'opacity-60');

          // Restore original background
          if (element.dataset.originalBg) {
            element.style.backgroundColor = element.dataset.originalBg;
          }
        }
      }

      function animateCompletion() {
        // Create a completion notification
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-500';
        notification.innerHTML = `
  <div class="z-50 flex items-center">
    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    <span>Court information updated</span>
  </div>
`;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove('translate-y-20', 'opacity-0');
        }, 100);

        // Animate out and remove
        setTimeout(() => {
          notification.classList.add('translate-y-20', 'opacity-0');
          setTimeout(() => {
            notification.remove();
          }, 500);
        }, 3000);
      }

      // Previous month button
      document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        if (selectedCourtId) {
          fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
        } else {
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
      });

      // Next month button
      document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        if (selectedCourtId) {
          fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
        } else {
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
      });

      // Schedule button
      scheduleBtn.addEventListener('click', () => {
        showModal(scheduleModal);
        showStep(1);
        
        // Initialize calendar for the current month
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
      });
      
      // View credits button
      if (viewCreditsBtn) {
        viewCreditsBtn.addEventListener('click', function() {
          if (isUserLoggedIn) {
            document.getElementById('my-credits-container').classList.remove('hidden');
            document.getElementById('my-credits-container').scrollIntoView({ behavior: 'smooth' });
          } else {
            showModal(authModal);
          }
        });
      }

      // Continue to booking button
      continueToBookingBtn.addEventListener('click', async function() {
        if (selectedSlots.length === 0) {
          alert('Please select at least one time slot to continue.');
          return;
        }
        
        // Check if user is logged in
        if (!isUserLoggedIn) {
          // Store the pending action
          pendingAction = {
            type: 'booking',
            slots: selectedSlots
          };
          
          // Show login modal
          showModal(authModal);
          return;
        }

        await reserveSelectedSlots();
      });

      // Cancel button
      document.getElementById('cancel-button').addEventListener('click', () => {
        hideAllModals();
      });
      
      // Proceed to coach payment button
      proceedToCoachPaymentBtn.addEventListener('click', function() {
        // Check if court booking proof is uploaded
        const courtBookingProofFile = courtBookingProof.files[0];
        
        if (!courtBookingProofFile) {
          alert('Please upload your court booking proof before proceeding to coach payment.');
          return;
        }
        
        // Show coach payment section
        coachPaymentSection.classList.remove('hidden');
        
        // Show confirm button
        confirmButton.classList.remove('hidden');
        
        // Hide the proceed button
        this.classList.add('hidden');
      });

      // Confirm button
      confirmButton.addEventListener('click', () => {
        // Form submission will be handled by the form's submit event
      });

      // Booking form submission
      bookingPaymentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitBooking();
      });

      // Success modal done button
      document.getElementById('success-done-btn').addEventListener('click', () => {
        hideAllModals();
      });
      
      // Credit purchase form submission
      if (creditPurchaseForm) {
        creditPurchaseForm.addEventListener('submit', submitCreditPurchase);
      }
      
      // Credit modal buttons
      if (closeCreditModal) {
        closeCreditModal.addEventListener('click', () => {
          hideAllModals();
        });
      }
      
      if (creditCancelButton) {
        creditCancelButton.addEventListener('click', () => {
          hideAllModals();
        });
      }
      
      // Credit success done button
      if (creditSuccessDoneBtn) {
        creditSuccessDoneBtn.addEventListener('click', () => {
          hideAllModals();
          
          // Refresh student credits
          fetchStudentCredits();
          
          // Show contact information
          document.getElementById('student-credits').scrollIntoView({ behavior: 'smooth' });
        });
      }

      async function loadAvailabilityPreferences() {
        if (!isUserLoggedIn) return;
        
        try {
          const response = await fetch('/api/student/get-availability');
          
          if (!response.ok) {
            console.error('Failed to load availability preferences');
            return;
          }
          
          const preferences = await response.json();
          
          // Set days
          if (preferences.days && preferences.days.length > 0) {
            preferences.days.forEach(day => {
              const dayBtn = document.querySelector(`.my-day-btn[data-day="${day}"]`);
              if (dayBtn) dayBtn.classList.add('bg-blue-600', 'text-white');
            });
          }
          
          // Set times
          if (preferences.times && preferences.times.length > 0) {
            preferences.times.forEach(time => {
              const timeBtn = document.querySelector(`.my-time-btn[data-time="${time}"]`);
              if (timeBtn) timeBtn.classList.add('bg-blue-600', 'text-white');
            });
          }
          
          // Set notes
          if (preferences.notes) {
            document.getElementById('my-availability-notes').value = preferences.notes;
          }
          
        } catch (error) {
          console.error('Error loading availability preferences:', error);
        }
      }

      // Initialize
      // Extract coach id from URL
      const coachId =  {{ coach.id }}  || 1; // Default to 1 if no ID is provided
      fetchCoachData(coachId);
      loadAvailabilityPreferences();
    });
  </script>
{% endblock %}