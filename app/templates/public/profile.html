{% extends 'base.html' %}

{% block extra_styles %}
/* Your existing styles */
.animate-float {
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0% {
    transform: translateY(0px);
  }

  50% {
    transform: translateY(-15px);
  }

  100% {
    transform: translateY(0px);
  }
}

.scroll-section {
  opacity: 0;
  transform: translateY(50px);
  transition: all 1s ease;
}

.scroll-section.active {
  opacity: 1;
  transform: translateY(0);
}

/* Custom CSS for scrollable modal */
.scrollable-modal {
  max-height: 80vh;
  overflow-y: auto;
}

@media (max-width: 640px) {
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }

  .text-right {
    text-align: left;
  }
}

/* Improve modal scrolling on mobile devices */
@media (max-width: 768px) {
  .scrollable-modal {
    padding: 1rem;
    margin: 1rem;
  }

  #calendar {
    font-size: 0.75rem;
  }

  #availability-grid {
    font-size: 0.75rem;
  }

  #selected-timeslots {
    max-height: 30vh;
  }
}

/* Style for the selected date in calendar */
.selected-date {
  background-color: #3b82f6 !important;
  color: white !important;
  font-weight: bold;
}

/* Smooth transition for time slot selection */
#availability-grid>div {
  transition: all 0.2s ease;
}

/* Total cost highlighting */
#current-total {
  font-size: 1.25rem;
}

/* Loading spinner */
.loader {
  border-top-color: #4158D0;
  -webkit-animation: spinner 1.5s linear infinite;
  animation: spinner 1.5s linear infinite;
}

@-webkit-keyframes spinner {
  0% {
    -webkit-transform: rotate(0deg);
  }

  100% {
    -webkit-transform: rotate(360deg);
  }
}

@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/* Tag styling */
.coach-tag {
  display: inline-block;
  background-color: #EBF5FF;
  color: #3B82F6;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  margin-right: 0.5rem;
  margin-bottom: 0.5rem;
}

/* File upload styling */
.file-upload-container {
  border: 2px dashed #e2e8f0;
  border-radius: 0.5rem;
  padding: 1rem;
  text-align: center;
  transition: all 0.3s ease;
}

.file-upload-container:hover {
  border-color: #3B82F6;
}

.file-upload-input {
  display: none;
}

.file-upload-label {
  cursor: pointer;
  display: block;
  width: 100%;
}

.file-preview {
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.file-preview img {
  max-height: 100px;
  max-width: 100%;
  border-radius: 0.25rem;
}

.payment-steps {
  counter-reset: step-counter;
}

.payment-step {
  position: relative;
  padding-left: 2.5rem;
  margin-bottom: 1rem;
}

.payment-step::before {
  content: counter(step-counter);
  counter-increment: step-counter;
  position: absolute;
  left: 0;
  top: 0;
  width: 1.75rem;
  height: 1.75rem;
  border-radius: 50%;
  background-color: #3B82F6;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

/* Package card styles */
.package-card {
  background-color: white;
  border-radius: 0.75rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  overflow: hidden;
}

.package-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
}

.package-card-header {
  padding: 1.25rem;
  border-bottom: 1px solid #f3f4f6;
}

.package-card-body {
  padding: 1.25rem;
}

.package-card-footer {
  padding: 1rem;
  background-color: #f9fafb;
  border-top: 1px solid #f3f4f6;
}

.badge-discount {
  background-color: #fee2e2;
  color: #ef4444;
  border-radius: 9999px;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}
{% endblock %}

{% block head_scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
{% endblock %}

{% block content %}
  <!-- Loading Indicator -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-50 bg-opacity-75 flex items-center justify-center z-50">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
  </div>
  
  <!-- Main Content -->
  <div class="container mx-auto px-6 py-12">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Coach Info Section -->
      <div class="lg:w-1/3">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <!-- Coach profile image -->
          <div id="coach-profile-image" class="flex justify-center mb-6">
            <!-- Profile image will be inserted here by JavaScript -->
            <div class="h-32 w-32 rounded-full bg-blue-100 flex items-center justify-center">
              <span class="text-blue-600 font-bold text-4xl">C</span>
            </div>
          </div>
          
          <!-- Coach details -->
          <h1 id="coach-name" class="text-2xl font-bold text-center mb-2">Loading...</h1>
          
          <div class="flex justify-center mb-4">
            <!-- Rating stars -->
            <div id="coach-rating" class="flex text-yellow-400">
              <!-- Rating stars will be inserted here by JavaScript -->
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
              <i class="far fa-star"></i>
            </div>
            <span id="rating-count" class="text-gray-500 ml-2">(0 reviews)</span>
          </div>
          
          <!-- Coach stats and info -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center">
              <i class="fas fa-dollar-sign w-8 text-blue-500"></i>
              <span id="coach-rate">$0/hour</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-medal w-8 text-blue-500"></i>
              <span id="coach-dupr">DUPR Rating: 0.0</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-history w-8 text-blue-500"></i>
              <span id="coach-experience">0 Years Experience</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-check-circle w-8 text-blue-500"></i>
              <span id="coach-sessions">0 Sessions Completed</span>
            </div>
            <div id="coach-location-container" class="flex items-center hidden">
              <i class="fas fa-map-marker-alt w-8 text-blue-500"></i>
              <span id="coach-location"></span>
            </div>
          </div>
          
          <!-- Coach tags (replacing specialties) -->
          <div id="coach-tags-container" class="mb-6">
            <h3 class="font-semibold mb-2">Specialties</h3>
            <div class="flex flex-wrap">
              {% for tag in coach_tags %}
                <span class="coach-tag">{{ tag.name }}</span>
              {% else %}
                <p class="text-gray-600">No specialties listed</p>
              {% endfor %}
            </div>
          </div>
          
          <!-- Available courts -->
          <div id="coach-courts-container" class="mb-6 hidden">
            <h3 class="font-semibold mb-2">Available at</h3>
            <ul id="coach-courts" class="space-y-1">
              <!-- Courts will be inserted here by JavaScript -->
            </ul>
          </div>

          <!-- Academy affiliations -->
          <div id="coach-academy-container" class="mb-6 hidden">
            <h3 class="font-semibold mb-2">Academy Affiliations</h3>
            <ul id="coach-academies" class="space-y-1">
              <!-- Academy affiliations will be inserted here by JavaScript -->
            </ul>
          </div>
          
          <!-- Book button -->
          <button id="schedule-btn" class="block w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium text-center hover:shadow-lg transform hover:scale-105 transition-all">
            Book a Session
          </button>
        </div>
      </div>
      
      <!-- Biography and Showcase Section -->
      <div class="lg:w-2/3">
        <!-- Biography section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
          <h2 class="text-xl font-semibold mb-4">About <span id="coach-first-name">this coach</span></h2>
          <div class="text-gray-700">
            <p id="coach-bio">Loading bio information...</p>
          </div>
        </div>
        
        <!-- Image showcase section -->
        <div id="showcase-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Showcase</h2>
          <div id="showcase-images" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Showcase images will be inserted here by JavaScript -->
          </div>
        </div>
        
        <!-- Coach Packages Section -->
        <div id="coach-packages-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Available Packages From The Coach</h2>
          <div id="coach-packages" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Coach packages will be inserted here by JavaScript -->
            <p class="text-gray-500 text-sm col-span-full">Loading packages...</p>
          </div>
        </div>
        
        <!-- Academy Packages Section -->
        <div id="academy-packages-container" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
          <h2 class="text-xl font-semibold mb-4">Academy Packages</h2>
          <div id="academy-packages" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Academy packages will be inserted here by JavaScript -->
            <p class="text-gray-500 text-sm col-span-full">Loading packages...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div id="schedule-modal"
    class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-3/4 lg:w-3/4 p-6 scrollable-modal">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Schedule a Session</h2>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Calendar -->
        <div class="lg:col-span-2">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Left side: Court and Calendar -->
            <div>
              <!-- Court Selection -->
              <div class="mb-6 bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                <label for="court-select" class="font-bold mb-2 block text-lg text-blue-800">1. Select a Court</label>
                <p class="mb-2 text-gray-600 text-sm">Choose a court to see available time slots</p>
                <select id="court-select"
                  class="w-full p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                  <option value="">-- Select a court --</option>
                  <!-- Court options will be populated dynamically -->
                </select>
              </div>

              <!-- Date Selection -->
              <div class="mb-2">
                <label class="font-bold mb-2 block text-lg text-gray-700">2. Select a Date</label>
              </div>

              <div id="calendar-container" class="transition-all duration-300">
                <!-- Month Navigation and Display -->
                <div class="flex justify-between items-center mb-3">
                  <button id="prev-month" class="text-gray-700 hover:text-blue-600 transition-colors">&#10094;</button>
                  <h3 id="current-month-year" class="text-lg font-bold"></h3>
                  <button id="next-month" class="text-gray-700 hover:text-blue-600 transition-colors">&#10095;</button>
                </div>
                
                <!-- Calendar -->
                <div id="calendar" class="grid grid-cols-7 gap-1 text-sm">
                  <!-- Calendar days will be dynamically populated here -->
                </div>
              </div>
            </div>

            <!-- Right side: Time Slots -->
            <div>
              <!-- Selected Date Display -->
              <h3 id="selected-date" class="text-lg font-bold mb-2"></h3>

              <!-- Availability Legend -->
              <div class="flex flex-wrap gap-3 text-xs text-gray-600 mb-2">
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-blue-200 rounded-sm"></div>
                  <span>Available</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-orange-300 rounded-sm"></div>
                  <span>Booked</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-gray-300 rounded-sm"></div>
                  <span>Unavailable</span>
                </div>
              </div>

              <!-- Selected sessions info -->
              <div class="flex items-center space-x-4 my-5">
                <div class="text-sm font-medium bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                  Sessions: <span id="session-count">0</span>
                </div>
                <div>
                  <span class="text-lg font-bold text-blue-600">Total: $<span id="current-total">0</span></span>
                  <div id="savings-container" class="text-sm text-green-600 hidden">
                    Savings: $<span id="total-savings">0</span>
                  </div>
                </div>
              </div>

              <!-- Availability Grid -->
              <div>
                <h4 class="font-bold mb-2">Available Time Slots</h4>
                <div id="availability-grid"
                  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-4">
                  <!-- Time slots will be populated here -->
                </div>
              </div>

              <!-- Court Fee Information -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm">
                <h4 class="font-bold mb-2">Court Information</h4>
                <div id="court-fee-info" class="text-gray-600 mb-2">
                  <p>Select a court to view fee information.</p>
                </div>
                <div id="court-booking-info" class="text-gray-600 hidden">
                  <div class="flex items-center text-sm text-blue-600">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span id="booking-responsibility-text">Loading booking information...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pricing Plans Section -->
          <div class="mt-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
            <h3 class="font-bold text-lg text-blue-800 mb-3">3. Special Pricing & Packages</h3>
            <div id="pricing-plans-container" class="space-y-3">
              <!-- Pricing plans will be populated here -->
              <p class="text-sm text-gray-500">No special pricing plans available</p>
            </div>
          </div>
          <div class="mt-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200" id="packages-container">
            <h3 class="font-bold text-lg text-blue-800 mb-3">Your Available Packages</h3>
            <div id="student-packages" class="space-y-3">
              <p class="text-sm text-gray-500">Loading your packages...</p>
            </div>
          </div>
        </div>

        <!-- Right Column: Selected Sessions and Fee Breakdown -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h3 class="font-bold text-lg mb-3">Selected Session</h3>
          <div id="selected-timeslots" class="space-y-2 max-h-40 overflow-y-auto mb-4">
            <!-- Selected timeslots will be dynamically populated here -->
            <div class="text-center py-6 text-gray-500">
              <p>No sessions selected yet</p>
            </div>
          </div>

          <hr class="my-4 border-gray-300">

          <!-- Fee Breakdown -->
          <div class="mb-4">
            <h4 class="font-bold mb-2">Fee Breakdown</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>Coach Fees:</span>
                <span>$<span id="coach-fee-total">0.00</span></span>
              </div>
              <div class="flex justify-between">
                <span>Court Fees:</span>
                <span>$<span id="court-fee-total">0.00</span></span>
              </div>
              <div id="discount-info" class="text-green-600 hidden">
                <div class="flex justify-between">
                  <span>Discount:</span>
                  <span>-$<span id="discount-amount">0.00</span></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Cost -->
          <div class="bg-blue-100 p-3 rounded-lg">
            <div class="flex justify-between text-lg font-bold">
              <span>Total Cost:</span>
              <span>$<span id="current-total-copy">0.00</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Button -->
      <button id="schedule-button"
        class="mt-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-xl transform hover:scale-105 transition-all w-full">
        Continue to Booking
      </button>
    </div>
  </div>

  <!-- Enhanced Confirmation Modal with Payment Process -->
  <div id="confirmation-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-3/4 max-w-4xl p-8 scrollable-modal">
      <div id="reservation-timer" class="mb-4 hidden"></div>

      <form id="booking-payment-form" enctype="multipart/form-data">
        <h2 class="text-2xl font-bold mb-2 text-gray-800">Complete Your Booking</h2>
        <p class="text-gray-600 mb-4">You are booking <span id="confirmation-session-count" class="font-bold">0</span> sessions.</p>

        <!-- Selected sessions overview -->
        <div id="confirmation-timeslots" class="space-y-3 mb-6">
          <!-- Confirmation timeslots will be dynamically populated here -->
        </div>

        <p class="text-xl font-bold mb-6">Total Price: <span class="text-blue-600">$<span id="total-price">0</span></span></p>

        <!-- Enhanced Payment Instructions -->
        <div class="bg-blue-50 p-6 rounded-lg mb-6">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Payment & Booking Instructions</h3>
          
          <div class="payment-steps">
            <!-- Step 1: Coach Payment -->
            <div class="payment-step mb-6">
              <h4 class="font-bold text-lg text-gray-800 mb-2">Coach Payment</h4>
              <div id="coach-payment-methods" class="mb-4">
                <div id="bank-transfer-details" class="bg-white p-4 rounded-lg mb-3">
                  <h5 class="font-medium text-gray-800 mb-2">Bank Transfer</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Bank Name:</p>
                      <p id="coach-bank-name" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Account Holder:</p>
                      <p id="coach-account-name" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Account Number:</p>
                      <p id="coach-account-number" class="font-medium">Loading...</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-600 mb-1">Reference:</p>
                      <p class="font-medium">PBC Coaching</p>
                    </div>
                  </div>
                </div>
                
                <div id="qr-payment-details" class="bg-white p-4 rounded-lg mb-3 hidden">
                  <h5 class="font-medium text-gray-800 mb-2">QR Payment</h5>
                  <div class="flex justify-center">
                    <div id="coach-qr-code" class="w-48 h-48 bg-gray-200 rounded flex items-center justify-center">
                      <span class="text-gray-500">QR Code Loading...</span>
                    </div>
                  </div>
                  <p class="text-center text-sm text-gray-600 mt-2">Scan the QR code to make payment</p>
                </div>
              </div>
              
              <!-- Coach Payment Proof Upload -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Coach Payment Proof</label>
                <div class="file-upload-container">
                  <label for="coach-payment-proof" class="file-upload-label">
                    <div class="flex flex-col items-center justify-center py-4">
                      <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                      <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
                    </div>
                  </label>
                  <input type="file" id="coach-payment-proof" name="coach_payment_proof" accept="image/*" class="file-upload-input" required>
                  <div id="coach-payment-preview" class="file-preview"></div>
                </div>
              </div>
            </div>
            
            <!-- Step 2: Court Booking (conditional) -->
            <div id="court-booking-section" class="payment-step mb-6 hidden">
              <h4 class="font-bold text-lg text-gray-800 mb-2">Court Booking</h4>
              <div id="court-booking-instructions" class="bg-white p-4 rounded-lg mb-3">
                <div class="text-amber-700 bg-amber-50 p-3 rounded-lg mb-3">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <svg class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                    </div>
                    <div class="ml-3">
                      <h5 class="text-sm font-medium">Important Notice</h5>
                      <p class="text-xs mt-1">You must book the VIP courts as specified below. Bookings on regular courts may be cancelled by the coach.</p>
                    </div>
                  </div>
                </div>
                
                <p id="court-booking-text" class="text-sm text-gray-700 mb-3">Please follow these instructions to book your court:</p>
                <div id="specific-court-instructions" class="pl-4 border-l-2 border-blue-200 mb-3"></div>
                
                <div id="court-booking-link-box" class="mb-3">
                  <a id="confirmation-court-link" href="#" target="_blank" class="text-blue-600 hover:underline flex items-center">
                    <i class="fas fa-external-link-alt mr-2"></i> Book court now
                  </a>
                </div>
              </div>
              
              <!-- Court Booking Proof Upload -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Court Booking Proof</label>
                <div class="file-upload-container">
                  <label for="court-booking-proof" class="file-upload-label">
                    <div class="flex flex-col items-center justify-center py-4">
                      <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-sm text-gray-600">Upload screenshot of your court booking</p>
                      <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
                    </div>
                  </label>
                  <input type="file" id="court-booking-proof" name="court_booking_proof" accept="image/*" class="file-upload-input">
                  <div id="court-booking-preview" class="file-preview"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col md:flex-row justify-end space-y-3 md:space-y-0 md:space-x-4">
          <button type="button" id="cancel-button" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
            Cancel
          </button>
          <button type="submit" id="confirm-button" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all">
            Complete Booking
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-1/2 max-w-lg p-8 text-center">
      <div class="mb-6">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-2 text-gray-800">Booking Successful!</h2>
      <p class="text-lg text-gray-600 mb-4">Your sessions have been booked successfully.</p>
      <p class="text-sm text-gray-500 mb-6">Confirmation number: <span id="confirmation-number" class="font-bold"></span></p>
      <p class="text-sm text-gray-500 mb-6">A confirmation email has been sent to your email address.</p>
      
      <button id="success-done-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-lg transform hover:scale-105 transition-all">
        Done
      </button>
    </div>
  </div>

  <!-- Package Purchase Modal -->
  <div id="package-purchase-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-2/3 max-w-3xl p-8 scrollable-modal">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Purchase Package</h2>
        <button id="close-package-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="package-purchase-form" enctype="multipart/form-data">
        <input type="hidden" id="package-id" name="package_id">
        <input type="hidden" id="package-type" name="package_type">
        <input type="hidden" id="package-coach-id" name="coach_id">
        <input type="hidden" id="package-academy-id" name="academy_id">
        
        <div class="mb-6">
          <div id="package-details" class="bg-blue-50 p-6 rounded-lg">
            <!-- Package details will be populated here -->
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Payment Instructions</h3>
          <div id="package-payment-details" class="bg-white p-4 rounded-lg mb-4">
            <!-- Payment details will be populated here -->
          </div>
        </div>
        
        <div class="mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-2">Upload Payment Proof</h3>
          <p class="text-sm text-gray-600 mb-4">Please upload proof of your payment for this package.</p>
          
          <div class="file-upload-container">
            <label for="package-payment-proof" class="file-upload-label">
              <div class="flex flex-col items-center justify-center py-4">
                <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                <p class="text-xs text-gray-500">PNG, JPG or JPEG (max. 5MB)</p>
              </div>
            </label>
            <input type="file" id="package-payment-proof" name="payment_proof" accept="image/*" class="file-upload-input" required>
            <div id="package-payment-preview" class="file-preview"></div>
          </div>
        </div>
        
        <div class="flex justify-end space-x-4">
          <button type="button" id="package-cancel-button" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
            Cancel
          </button>
          <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all">
            Complete Purchase
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Package Purchase Success Modal -->
  <div id="package-success-modal" class="custom-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl shadow-lg w-11/12 md:w-1/2 max-w-lg p-8 text-center">
      <div class="mb-6">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-2 text-gray-800">Package Purchase Submitted!</h2>
      <p class="text-lg text-gray-600 mb-4">Your package purchase request has been submitted successfully.</p>
      <p class="text-sm text-gray-500 mb-6">The coach/academy will review your payment and activate your package soon.</p>
      
      <button id="package-success-done-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-lg transform hover:scale-105 transition-all">
        Done
      </button>
    </div>
  </div>

  <!-- Password Section Modal -->
  <div id="password-modal"
    class="custom-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 shadow-lg rounded-xl bg-white">
      <div class="text-center">
        <div
          class="h-16 w-16 mx-auto rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mb-6">
          <span class="text-white font-bold text-2xl">P</span>
        </div>
        <h3 class="text-xl font-bold mb-6 text-gray-800">Create Password</h3>
        <div class="absolute top-2 right-2">
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="password-form" class="mt-4">
          <input type="password" id="password" placeholder="Password"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
            pattern=".*\d+.*" required>
          <p class="text-xs text-left text-gray-500 mb-4">Password must be at least 8 characters and include at least
            one number</p>
          <input type="password" id="confirm-password" placeholder="Confirm Password"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
            pattern=".*\d+.*" required>
          <div id="password-match-error" class="text-red-500 text-sm mb-4 hidden">Passwords do not match</div>
          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all">Submit</button>
        </form>
        <p class="mt-4 text-gray-600"><a href="#"
            class="back-to-registration text-blue-500 font-medium hover:underline">Back to registration</a></p>
      </div>
    </div>
  </div>

  <!-- Guest User Info Modal -->
  <div id="guest-info-modal"
    class="custom-modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 shadow-lg rounded-xl bg-white">
      <div class="text-center">
        <div
          class="h-16 w-16 mx-auto rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mb-6">
          <span class="text-white font-bold text-2xl">P</span>
        </div>
        <h3 class="text-xl font-bold mb-4 text-gray-800">Enter Your Details</h3>
        <p class="text-gray-600 mb-6">Please enter your information to continue with the booking</p>
        <div class="absolute top-2 right-2">
          <button type="button" class="close-modal text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="guest-info-form" class="mt-4">
          <input type="text" name="first_name" placeholder="First Name" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="text" name="last_name" placeholder="Last Name" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="email" name="email" placeholder="Email" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="tel" name="phone" placeholder="Phone Number" required
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <input type="number" name="dupr_rating" placeholder="DUPR Rating (optional)" step="0.1" min="1" max="8"
            class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500">

          <div class="mt-6 flex items-center mb-4">
            <input id="create-account-checkbox" type="checkbox"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="create-account-checkbox" class="ml-2 block text-sm text-gray-700">
              Create an account for future bookings
            </label>
          </div>

          <div id="create-account-fields" class="hidden">
            <input type="password" id="guest-password" placeholder="Password"
              class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
              pattern=".*\d+.*">
            <p class="text-xs text-left text-gray-500 mb-4">Password must be at least 8 characters and include at least
              one number</p>
            <input type="password" id="guest-confirm-password" placeholder="Confirm Password"
              class="w-full px-4 py-3 mb-4 border rounded-lg focus:ring-blue-500 focus:border-blue-500" minlength="8"
              pattern=".*\d+.*">
          </div>

          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:shadow-lg transform hover:scale-105 transition-all">Continue
            to Booking</button>
        </form>
        <p class="mt-4 text-gray-600">Already have an account? <a href="#"
            class="login-link text-blue-500 font-medium hover:underline">Login</a></p>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- Script for Profile and Booking Functionality -->
  <script>
//    document.addEventListener('DOMContentLoaded', function () {
      // DOM Elements
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const loadingOverlay = document.getElementById('loading-overlay');
      const loginModal = document.getElementById('login-modal');
      const registerModal = document.getElementById('register-modal');
      const passwordModal = document.getElementById('password-modal');
      const scheduleModal = document.getElementById('schedule-modal');
      const confirmationModal = document.getElementById('confirmation-modal');
      const guestInfoModal = document.getElementById('guest-info-modal');
      const successModal = document.getElementById('success-modal');
      const packagePurchaseModal = document.getElementById('package-purchase-modal');
      const packageSuccessModal = document.getElementById('package-success-modal');

      // Coach profile elements
      const coachName = document.getElementById('coach-name');
      const coachFirstName = document.getElementById('coach-first-name');
      const coachRating = document.getElementById('coach-rating');
      const coachRate = document.getElementById('coach-rate');
      const coachSessions = document.getElementById('coach-sessions');
      const coachCourts = document.getElementById('coach-courts');
      const coachTags = document.getElementById('coach-tags');
      const coachBio = document.getElementById('coach-bio');
      const scheduleBtn = document.getElementById('schedule-btn');

      // Schedule elements
      const courtSelect = document.getElementById('court-select');
      const currentMonthYear = document.getElementById('current-month-year');
      const calendar = document.getElementById('calendar');
      const selectedDate = document.getElementById('selected-date');
      const availabilityGrid = document.getElementById('availability-grid');
      const selectedTimeslots = document.getElementById('selected-timeslots');
      const currentTotal = document.getElementById('current-total');
      const currentTotalCopy = document.getElementById('current-total-copy');
      const scheduleButton = document.getElementById('schedule-button');

      // Payment elements
      const coachBankName = document.getElementById('coach-bank-name');
      const coachAccountName = document.getElementById('coach-account-name');
      const coachAccountNumber = document.getElementById('coach-account-number');
      const qrPaymentDetails = document.getElementById('qr-payment-details');
      const coachQrCode = document.getElementById('coach-qr-code');

      // Form file inputs
      const coachPaymentProof = document.getElementById('coach-payment-proof');
      const courtBookingProof = document.getElementById('court-booking-proof');
      const coachPaymentPreview = document.getElementById('coach-payment-preview');
      const courtBookingPreview = document.getElementById('court-booking-preview');
      const bookingPaymentForm = document.getElementById('booking-payment-form');
      
      // Package purchase elements
      const packagePaymentProof = document.getElementById('package-payment-proof');
      const packagePaymentPreview = document.getElementById('package-payment-preview');
      const packagePurchaseForm = document.getElementById('package-purchase-form');
      const closePackageModal = document.getElementById('close-package-modal');
      const packageCancelButton = document.getElementById('package-cancel-button');
      const packageSuccessDoneBtn = document.getElementById('package-success-done-btn');

      // Global state
      let coachData = null;
      let selectedCourtId = null;
      let currentDate = new Date();
      let allAvailabilities = {};
      let selectedSlots = [];
      let selectedPricingPlan = null;
      let availablePricingPlans = [];
      let studentPackages = [];
      let selectedPackage = null;
      let bookingResponsibilities = {}; // Track who books the court for each availability
      let successfulBookingId = null; // Store the ID of a successful booking
      let previousCourtId = null; 
      const isUserLoggedIn = {% if current_user.is_authenticated %}true{% else %}false{% endif %};
      
      // Package data
      let coachPackages = [];
      let academyPackages = [];
      let currentPackageData = null; // Store the currently selected package for purchase
      let reservationToken = null;
      let reservationExpiry = null;
      let countdownInterval = null;

      // Utility Functions
      function formatMoney(amount) {
        return parseFloat(amount).toFixed(2);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
      }

      // Generate star rating HTML
      function generateStars(rating) {
        let starsHtml = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;

        // Add full stars
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="fas fa-star"></i>';
        }

        // Add half star if needed
        if (hasHalfStar) {
          starsHtml += '<i class="fas fa-star-half-alt"></i>';
        }

        // Add empty stars to make 5 total
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) {
          starsHtml += '<i class="far fa-star"></i>';
        }

        return starsHtml;
      }

      // Modal handling
      function showModal(modal) {
        document.querySelectorAll('.custom-modal').forEach(m => {
          m.classList.add('hidden');
        });
        modal.classList.remove('hidden');
      }

      function hideAllModals() {
        document.querySelectorAll('.custom-modal').forEach(modal => {
          modal.classList.add('hidden');
        });
      }

      // Set up file upload previews
      function setupFileUploadPreview(fileInput, previewContainer) {
        fileInput.addEventListener('change', function(e) {
          previewContainer.innerHTML = '';
          
          if (this.files && this.files[0]) {
            const file = this.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'rounded-lg shadow-sm';
              previewContainer.appendChild(img);
            }
            
            reader.readAsDataURL(file);
          }
        });
      }

      // Set up payment preview functionality
      setupFileUploadPreview(coachPaymentProof, coachPaymentPreview);
      setupFileUploadPreview(courtBookingProof, courtBookingPreview);
      setupFileUploadPreview(packagePaymentProof, packagePaymentPreview);

      // Fetch coach data
      async function fetchCoachData(coachId) {
        try {
          console.log("Fetching coach data for ID:", coachId);
          const response = await fetch(`/public/api/coach/${coachId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch coach data');
          }
          
          const coach = await response.json();
          coachData = coach;
          console.log("Coach data received:", coach);
          
          // Update profile image
          const profileImageContainer = document.getElementById('coach-profile-image');
          if (coach.profile_picture) {
            profileImageContainer.innerHTML = `
              <img src="${coach.profile_picture.replace('%5C','/')}" alt="${coach.first_name}" class="h-32 w-32 rounded-full object-cover border-4 border-blue-100">
            `;
          } else {
            profileImageContainer.innerHTML = `
              <div class="h-32 w-32 rounded-full bg-blue-100 flex items-center justify-center">
                <span class="text-blue-600 font-bold text-4xl">${coach.first_name.charAt(0)}</span>
              </div>
            `;
          }
          
          // Update coach details
          coachName.textContent = `${coach.first_name} ${coach.last_name}`;
          coachFirstName.textContent = coach.first_name;
          coachRate.textContent = `$${coach.hourly_rate}/hour`;
          document.getElementById('coach-dupr').textContent = `DUPR Rating: ${coach.dupr_rating || 'N/A'}`;
          document.getElementById('coach-experience').textContent = `${coach.years_experience || '0'} Years Experience`;
          coachSessions.textContent = `${coach.sessions_completed || '0'} Sessions Completed`;
          coachBio.textContent = coach.biography || 'No biography available.';

          // Format courts list
          const courtNames = coach.courts.map(court => court.name).join(', ');
          coachCourts.textContent = courtNames;

          // Populate court select dropdown
          courtSelect.innerHTML = '<option value="">Select a court</option>';
          coach.courts.forEach(court => {
            const option = document.createElement('option');
            option.value = court.id;
            option.textContent = court.name;
            courtSelect.appendChild(option);
          });
          
          // Update location if available
          if (coach.location) {
            document.getElementById('coach-location').textContent = coach.location;
            document.getElementById('coach-location-container').classList.remove('hidden');
          }
          
          // Update rating stars
          coachRating.innerHTML = generateStars(coach.avg_rating || 0);
          document.getElementById('rating-count').textContent = `(${coach.rating_count || 0} reviews)`;
          
          // Update courts list
          if (coach.courts && coach.courts.length > 0) {
            const courtsContainer = document.getElementById('coach-courts');
            courtsContainer.innerHTML = '';
            
            coach.courts.forEach(court => {
              const courtItem = document.createElement('li');
              courtItem.className = 'flex items-center';
              courtItem.innerHTML = `
                <i class="fas fa-map-pin text-blue-500 mr-2"></i>
                <span>${court.name}</span>
              `;
              courtsContainer.appendChild(courtItem);
            });
            
            document.getElementById('coach-courts-container').classList.remove('hidden');
          }
          
          // Update showcase images
          if (coach.showcase_images && coach.showcase_images.length > 0) {
            const showcaseContainer = document.getElementById('showcase-images');
            showcaseContainer.innerHTML = '';
            
            coach.showcase_images.forEach(imageSrc => {
              const imageDiv = document.createElement('div');
              imageDiv.className = 'rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow';
              imageDiv.innerHTML = `
                <img src="${imageSrc.replace('%5C','/')}" alt="Coaching showcase" class="w-full h-64 object-cover">
              `;
              showcaseContainer.appendChild(imageDiv);
            });
            
            document.getElementById('showcase-container').classList.remove('hidden');
          }
          
          // Update academy affiliations if available
          if (coach.academy_affiliations && coach.academy_affiliations.length > 0) {
            const academiesContainer = document.getElementById('coach-academies');
            academiesContainer.innerHTML = '';
            
            coach.academy_affiliations.forEach(academy => {
              const academyItem = document.createElement('li');
              academyItem.className = 'flex items-center';
              academyItem.innerHTML = `
                <i class="fas fa-university text-blue-500 mr-2"></i>
                <span>${academy.name} ${academy.role ? `- ${academy.role}` : ''}</span>
              `;
              academiesContainer.appendChild(academyItem);
            });
            
            document.getElementById('coach-academy-container').classList.remove('hidden');
          }
          
          // Set payment information in confirmation modal
          updateCoachPaymentInfo();
          
          // Fetch coach packages
          fetchCoachPackages(coachId);
          
          // Fetch academy packages if coach has academy affiliations
          if (coach.academy_affiliations && coach.academy_affiliations.length > 0) {
            const academyIds = coach.academy_affiliations.map(academy => academy.id);
            fetchAcademyPackages(academyIds);
          }
          
          // Fetch student packages if user is logged in
          if (isUserLoggedIn) {
            fetchStudentPackages();
          } else {
            // Hide packages container if not logged in
            const packagesContainer = document.getElementById('packages-container');
            if (packagesContainer) {
              packagesContainer.classList.add('hidden');
            }
          }

          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
        } catch (error) {
          console.error('Error fetching coach data:', error);
          coachBio.textContent = 'Failed to load coach information. Please try again later.';
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
        }
      }
      
      // Fetch coach packages
      async function fetchCoachPackages(coachId) {
        try {
          const response = await fetch(`/api/coach/pricing-plans/${coachId}`);
          if (!response.ok) {
            throw new Error('Failed to fetch coach packages');
          }
          
          const packages = await response.json();
          coachPackages = packages.filter(pkg => pkg.discount_type === 'package');
          
          // Update packages UI
          updateCoachPackagesUI();
        } catch (error) {
          console.error('Error fetching coach packages:', error);
          const coachPackagesContainer = document.getElementById('coach-packages-container');
          if (coachPackagesContainer) {
            const packagesContainer = document.getElementById('coach-packages');
            packagesContainer.innerHTML = `
              <p class="text-sm text-red-500 col-span-full">Could not load coach packages. Please try again later.</p>
            `;
          }
        }
      }
      
      // When a student selects time slots and clicks "Continue to Booking"
      async function reserveSelectedSlots() {
          try {
              // Show loading spinner
              loadingOverlay.classList.remove('hidden');
              
              const availabilityIds = selectedSlots.map(slot => slot.availabilityId);
              

              if (availabilityIds.length === 0) {
                  alert('Please select at least one time slot');
                  loadingOverlay.classList.add('hidden');
                  return false;
              }

              // Make reservation request
              const response = await fetch('/booking/api/reserve-slots', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      availability_ids: availabilityIds
                  })
              });
              
              const data = await response.json();
              
              if (!response.ok) {
                  // Handle error - another student may have booked the slot
                  if (response.status === 409) {
                      // Conflict - slot no longer available
                      alert(`The slot at ${data.start_time} ${data.availability_date} are no longer available. Please choose different times.`);
                      
                      // Refresh availability display
                      await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());

                      if (selectedDate.dataset.date) {
                        populateAvailabilityGrid(selectedDate.dataset.date);
                      }

                      // Remove the unavailable slot from selection
                      if (data.availability_id) {
                          // Find and remove the slot
                          selectedSlots = selectedSlots.filter(slot => slot.availabilityId !== data.availability_id);
                          updateSelectedTimeslotsUI();
                          updateTotalPrice();
                          const sessionCount = document.getElementById('session-count');
                          sessionCount.textContent = sessionCount.textContent - 1;

                      }

                      loadingOverlay.classList.add('hidden');
                      return false;
                  } else {
                      alert(data.error || 'Failed to reserve time slots');
                      loadingOverlay.classList.add('hidden');
                      return false;
                  }
              }
              
              // Store reservation token for booking submission
              reservationToken = data.reservation_token;
              reservationExpiry = new Date(data.expires_at + 'Z');
              
              // Clear any existing countdown
              if (countdownInterval) {
                  clearInterval(countdownInterval);
              }

              // Start countdown timer
              startReservationCountdown();
              
              // Show confirmation modal
              populateConfirmationModal();
              hideAllModals();
              showModal(confirmationModal);
              
              loadingOverlay.classList.add('hidden');
              return true;
              
          } catch (error) {
              console.error('Error reserving slots:', error);
              alert('An error occurred while submitting your booking. Please try again.');
              return false;
          } finally {
              loadingOverlay.classList.add('hidden');
          }
      }

      // Add a countdown timer to show when reservation expires
      function startReservationCountdown() {
          const timerElement = document.getElementById('reservation-timer');
          if (!timerElement) return;
          
          timerElement.classList.remove('hidden');
          
          const countdownInterval = setInterval(() => {
              const now = Date.now();

              const timeRemaining = Math.max(0, Math.floor((reservationExpiry  - now) / 1000));

              if (timeRemaining <= 0) {
                  clearInterval(countdownInterval);
                  timerElement.innerHTML = `<div class="bg-red-100 text-red-700 p-2 rounded border border-red-300">
                      <i class="fas fa-exclamation-circle mr-1"></i> Reservation expired! Please go back and select time slots again.
                  </div>`;
                  
                  // Disable booking button
                  const confirmButton = document.getElementById('confirm-button');
                  if (confirmButton) {
                      confirmButton.disabled = true;
                      confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                      confirmButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-600');
                  }
                  
                  return;
              }
              
              const minutes = Math.floor(timeRemaining / 60);
              const seconds = timeRemaining % 60;
              
              timerElement.innerHTML = `<div class="bg-blue-50 p-2 rounded border border-blue-200 ${timeRemaining < 60 ? 'text-red-600' : 'text-blue-600'}">
                  <i class="fas fa-clock mr-1"></i> Your reservation expires in <strong>${minutes}:${seconds.toString().padStart(2, '0')}</strong>
              </div>`;
          }, 1000);
      }

      // Fetch academy packages
      async function fetchAcademyPackages(academyIds) {
        try {
          // Create a comma-separated list of academy IDs
          academyPackages = []
          for (const idParam of academyIds){

            const response = await fetch(`/academy/${idParam}/pricing-plans`);
            if (!response.ok) {
              throw new Error('Failed to fetch academy packages');
            }
            
            const packages = await response.json();
            for (const package of packages){
              academyPackages.push(package);
            }
          }

          // Update academy packages UI
          updateAcademyPackagesUI();
        } catch (error) {
          console.error('Error fetching academy packages:', error);
          const academyPackagesContainer = document.getElementById('academy-packages-container');
          if (academyPackagesContainer) {
            const packagesContainer = document.getElementById('academy-packages');
            packagesContainer.innerHTML = `
              <p class="text-sm text-red-500 col-span-full">Could not load academy packages. Please try again later.</p>
            `;
          }
        }
      }
      
      // Update coach packages UI
      function updateCoachPackagesUI() {
        const container = document.getElementById('coach-packages-container');
        const packagesContainer = document.getElementById('coach-packages');
        
        if (!container || !packagesContainer) return;
        
        if (!coachPackages || coachPackages.length === 0) {
          container.classList.add('hidden');
          return;
        }
        
        // Show container
        container.classList.remove('hidden');
        
        // Clear previous content
        packagesContainer.innerHTML = '';
        
        // Create a card for each package
        coachPackages.forEach(pkg => {

          const discount_type_amount = pkg.percentage_discount  
            ? 'percentage' 
            : 'fixed';

          const discountText = discount_type_amount === 'percentage' 
            ? `${pkg.percentage_discount}% off` 
            : `$${pkg.fixed_discount} off`;
          
          // Calculate original price and discounted price
          const originalPrice = coachData.hourly_rate * pkg.sessions_required;
          let discountedPrice = originalPrice;
          
          if (discount_type_amount === 'percentage') {
            discountedPrice = originalPrice * (1 - pkg.percentage_discount / 100);
          } else if (discount_type_amount === 'fixed') {
            discountedPrice = originalPrice - pkg.fixed_discount;
          }
          
          // Calculate savings
          const savings = originalPrice - discountedPrice;
          const savingsPercent = Math.round((savings / originalPrice) * 100);
          
          const packageCard = document.createElement('div');
          packageCard.className = 'package-card';
          packageCard.innerHTML = `
            <div class="package-card-header">
              <h3 class="text-lg font-bold text-gray-800">${pkg.name}</h3>
              <p class="text-sm text-gray-600">${pkg.description || 'Package deal with coach'}</p>
            </div>
            <div class="package-card-body">
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Sessions:</span>
                <span class="font-medium">${pkg.sessions_required}</span>
              </div>
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Original Price:</span>
                <span class="font-medium line-through text-gray-600">$${formatMoney(originalPrice)}</span>
              </div>
              <div class="flex justify-between mb-2">
                <span class="text-gray-600">Package Price:</span>
                <span class="font-bold text-green-600">$${formatMoney(discountedPrice)}</span>
              </div>
              <div class="mb-4">
                <span class="badge-discount">${discountText} (Save ${savingsPercent}%)</span>
              </div>
              <div class="text-sm text-gray-600">
                <p>Valid for 90 days after purchase</p>
              </div>
            </div>
            <div class="package-card-footer">
              <button class="w-full py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all buy-package-btn" data-package-id="${pkg.id}" data-package-type="coach">
                Buy Package
              </button>
            </div>
          `;
          
          packagesContainer.appendChild(packageCard);
        });
        
        // Add event listeners to the buy buttons
        document.querySelectorAll('.buy-package-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const packageId = parseInt(this.getAttribute('data-package-id'));
            const packageType = this.getAttribute('data-package-type');
            
            // Find the package
            const packageData = packageType === 'coach' 
              ? coachPackages.find(p => p.id === packageId)
              : academyPackages.find(p => p.id === packageId);
            
            if (packageData) {
              openPackagePurchaseModal(packageData, packageType);
            }
          });
        });
      }
      
      // Update academy packages UI
      function updateAcademyPackagesUI() {
        const container = document.getElementById('academy-packages-container');
        const packagesContainer = document.getElementById('academy-packages');
        
        if (!container || !packagesContainer) return;
        
        if (!academyPackages || academyPackages.length === 0) {
          container.classList.add('hidden');
          return;
        }
        
        // Show container
        container.classList.remove('hidden');
        
        // Clear previous content
        packagesContainer.innerHTML = '';
        
        // Group packages by academy
        const packagesByAcademy = {};
        academyPackages.forEach(pkg => {
          if (!packagesByAcademy[pkg.academy_id]) {
            packagesByAcademy[pkg.academy_id] = [];
          }
          packagesByAcademy[pkg.academy_id].push(pkg);
        });
        
        // Create a section for each academy
        Object.keys(packagesByAcademy).forEach(academyId => {
          // Find academy info
          const academyAffiliation = coachData.academy_affiliations.find(a => a.id === parseInt(academyId));
          
          if (!academyAffiliation) return;
          
          // Create academy header
          const academyHeader = document.createElement('div');
          academyHeader.className = 'col-span-full mb-4';
          academyHeader.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800">${academyAffiliation.name} Packages</h3>
          `;
          
          packagesContainer.appendChild(academyHeader);
          
          // Create cards for each package in this academy
          packagesByAcademy[academyId].forEach(pkg => {
            const discount_type_amount = pkg.percentage_discount  
              ? 'percentage' 
              : 'fixed';

            const discountText = discount_type_amount === 'percentage'
              ? `${pkg.percentage_discount}% off` 
              : `$${pkg.fixed_discount} off`;
            
            // Use academy rate or default to coach rate
            const hourlyRate = pkg.academy_rate || coachData.hourly_rate;
            
            // Calculate original price and discounted price
            const originalPrice = hourlyRate * pkg.sessions_required;
            let discountedPrice = originalPrice;
            
            if (discount_type_amount === 'percentage') {
              discountedPrice = originalPrice * (1 - pkg.percentage_discount / 100);
            } else if (discount_type_amount === 'fixed') {
              discountedPrice = originalPrice - pkg.fixed_discount;
            }
            
            // Calculate savings
            const savings = originalPrice - discountedPrice;
            const savingsPercent = Math.round((savings / originalPrice) * 100);
            
            const packageCard = document.createElement('div');
            packageCard.className = 'package-card';
            packageCard.innerHTML = `
              <div class="package-card-header">
                <h3 class="text-lg font-bold text-gray-800">${pkg.name}</h3>
                <p class="text-sm text-gray-600">${pkg.description || 'Academy package deal'}</p>
              </div>
              <div class="package-card-body">
                <div class="flex justify-between mb-2">
                  <span class="text-gray-600">Sessions:</span>
                  <span class="font-medium">${pkg.sessions_required}</span>
                </div>
                <div class="flex justify-between mb-2">
                  <span class="text-gray-600">Original Price:</span>
                  <span class="font-medium line-through text-gray-600">$${formatMoney(originalPrice)}</span>
                </div>
                <div class="flex justify-between mb-2">
                  <span class="text-gray-600">Package Price:</span>
                  <span class="font-bold text-green-600">$${formatMoney(discountedPrice)}</span>
                </div>
                <div class="mb-4">
                  <span class="badge-discount">${discountText} (Save ${savingsPercent}%)</span>
                </div>
                <div class="text-sm text-gray-600">
                  <p>Valid for 90 days after purchase</p>
                  <p>Use with any coach in ${academyAffiliation.name}</p>
                </div>
              </div>
              <div class="package-card-footer">
                <button class="w-full py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all buy-package-btn" data-package-id="${pkg.id}" data-package-type="academy" data-academy-id="${academyId}">
                  Buy Package
                </button>
              </div>
            `;
            
            packagesContainer.appendChild(packageCard);
          });
        });
        
        // Add event listeners to the buy buttons
        document.querySelectorAll('.buy-package-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const packageId = parseInt(this.getAttribute('data-package-id'));
            const packageType = this.getAttribute('data-package-type');
            const academyId = parseInt(this.getAttribute('data-academy-id') || '0');
            
            // Find the package
            const packageData = packageType === 'coach' 
              ? coachPackages.find(p => p.id === packageId)
              : academyPackages.find(p => p.id === packageId);
            
            if (packageData) {
              if (packageType === 'academy') {
                packageData.academy_id = academyId;
              }
              openPackagePurchaseModal(packageData, packageType);
            }
          });
        });
      }
      
      // Open package purchase modal
      function openPackagePurchaseModal(packageData, packageType) {
        if (!isUserLoggedIn) {
          alert('Please log in to purchase packages.');
          return;
        }
        
        currentPackageData = packageData;
        
        // Set hidden form fields
        document.getElementById('package-id').value = packageData.id;
        document.getElementById('package-type').value = packageType;
        document.getElementById('package-coach-id').value = packageType === 'coach' ? coachData.id : '';
        document.getElementById('package-academy-id').value = packageType === 'academy' ? packageData.academy_id : '';
        
        // Calculate pricing details
        const hourlyRate = packageType === 'academy' && packageData.academy_rate 
          ? packageData.academy_rate 
          : coachData.hourly_rate;
        
        const originalPrice = hourlyRate * packageData.sessions_required;
        let discountedPrice = originalPrice;
        
        const discount_type_amount = packageData.percentage_discount  
          ? 'percentage' 
          : 'fixed';

        if (discount_type_amount === 'percentage') {
          discountedPrice = originalPrice * (1 - packageData.percentage_discount / 100);
        } else if (discount_type_amount === 'fixed') {
          discountedPrice = originalPrice - packageData.fixed_discount;
        }
        
        // Fill package details
        const packageDetails = document.getElementById('package-details');
        packageDetails.innerHTML = `
          <h3 class="text-xl font-bold text-gray-800 mb-4">${packageData.name}</h3>
          <p class="text-gray-600 mb-4">${packageData.description || 'Package deal for coaching sessions'}</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold text-gray-700 mb-2">Package Details</h4>
              <ul class="space-y-2">
                <li class="flex justify-between">
                  <span class="text-gray-600">Provider:</span>
                  <span class="font-medium">${packageType === 'coach' ? `${coachData.first_name} ${coachData.last_name}` : findAcademyName(packageData.academy_id)}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Sessions Included:</span>
                  <span class="font-medium">${packageData.sessions_required}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Regular Price:</span>
                  <span class="font-medium line-through text-gray-500">$${formatMoney(originalPrice)}</span>
                </li>
                <li class="flex justify-between">
                  <span class="text-gray-600">Discount:</span>
                  <span class="font-medium text-green-600">${discount_type_amount === 'percentage' ? `${packageData.percentage_discount}%` : `$${formatMoney(packageData.fixed_discount)}`}</span>
                </li>
              </ul>
            </div>
            
            <div>
              <h4 class="font-semibold text-gray-700 mb-2">Package Benefits</h4>
              <ul class="space-y-1 text-gray-600">
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Save ${Math.round(((originalPrice - discountedPrice) / originalPrice) * 100)}% off regular price</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>Valid for 90 days after purchase</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 text-green-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span>${packageType === 'academy' ? 'Can be used with any coach in the academy' : 'Exclusive coaching sessions with this coach'}</span>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-lg font-bold text-gray-800">Total Package Price:</span>
              <span class="text-xl font-bold text-blue-600">$${formatMoney(discountedPrice)}</span>
            </div>
          </div>
        `;
        
        // Fill payment details
        const paymentDetails = document.getElementById('package-payment-details');
        if (packageType === 'coach' && coachData.payment_info) {
          const paymentInfo = coachData.payment_info;
          
          paymentDetails.innerHTML = `
            <h4 class="font-medium text-gray-800 mb-4">Please transfer the package payment to:</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-600 mb-1">Bank Name:</p>
                <p class="font-medium">${paymentInfo.bank_name || 'Please ask coach'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Account Holder:</p>
                <p class="font-medium">${paymentInfo.account_name || `${coachData.first_name} ${coachData.last_name}`}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Account Number:</p>
                <p class="font-medium">${paymentInfo.account_number || 'Please ask coach'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-600 mb-1">Reference:</p>
                <p class="font-medium">PBC Package: ${packageData.name}</p>
              </div>
            </div>
            <p class="font-bold text-blue-700 mt-4">Amount to pay: $${formatMoney(discountedPrice)}</p>
          `;
          
          // Add QR code if available
          if (paymentInfo.qr_code_url) {
            paymentDetails.innerHTML += `
              <div class="mt-4 p-4 border border-gray-200 rounded-lg">
                <h5 class="font-medium text-gray-800 mb-2">QR Payment</h5>
                <div class="flex justify-center">
                  <img src="${paymentInfo.qr_code_url}" alt="Payment QR Code" class="h-48 object-contain">
                </div>
                <p class="text-center text-sm text-gray-600 mt-2">Scan the QR code to make payment</p>
              </div>
            `;
          }
        } else if (packageType === 'academy') {
          // Academy payment details - this would need to be fetched from the academy
          paymentDetails.innerHTML = `
            <h4 class="font-medium text-gray-800 mb-4">Academy Package Payment Instructions</h4>
            <p class="text-gray-600 mb-2">Please contact ${findAcademyName(packageData.academy_id)} for payment details or use the details below if provided.</p>
            <div class="p-4 bg-yellow-50 rounded-lg">
              <p class="font-medium text-amber-800">Package Price: $${formatMoney(discountedPrice)}</p>
              <p class="text-sm text-amber-700 mt-1">Include your name and "${packageData.name} Package" as reference</p>
            </div>
          `;
        } else {
          // Fallback payment instructions
          paymentDetails.innerHTML = `
            <h4 class="font-medium text-gray-800 mb-4">Payment Instructions</h4>
            <p class="text-gray-600 mb-2">Please contact ${packageType === 'coach' ? `${coachData.first_name} ${coachData.last_name}` : findAcademyName(packageData.academy_id)} for payment details.</p>
            <p class="font-bold text-blue-700 mt-2">Amount to pay: $${formatMoney(discountedPrice)}</p>
          `;
        }
        
        // Show the modal
        showModal(packagePurchaseModal);
      }
      
      // Helper function to find academy name by ID
      function findAcademyName(academyId) {
        const academyAffiliation = coachData.academy_affiliations.find(a => a.id === parseInt(academyId));
        return academyAffiliation ? academyAffiliation.name : 'the Academy';
      }
    
      async function fetchStudentPackages() {
        if (!isUserLoggedIn) return;
        
        try {
          // Fetch packages that can be used with this coach
          const response = await fetch(`/api/student/packages?coach_id=${coachData.id}`);
          if (!response.ok) {
            throw new Error('Failed to fetch packages');
          }
          
          const data = await response.json();
          studentPackages = data;
          
          // Update the packages UI
          updatePackagesUI();
        } catch (error) {
          console.error('Error fetching student packages:', error);
          document.getElementById('student-packages').innerHTML = `
            <p class="text-sm text-red-500">Could not load your packages. Please try again later.</p>
          `;
        }
      }

      function updatePackagesUI() {
        const container = document.getElementById('student-packages');
        if (!container) return;
        
        // Hide container if user is not logged in or no packages
        if (!isUserLoggedIn) {
          document.getElementById('packages-container').classList.add('hidden');
          return;
        }
        
        if (!studentPackages || studentPackages.length === 0) {
          container.innerHTML = `
            <p class="text-sm text-gray-500">You don't have any active packages with this coach or their academies.</p>
          `;
          return;
        }
        
        // Show available packages
        container.innerHTML = '';
        
        studentPackages.forEach(pkg => {
          const sessionsRemaining = pkg.total_sessions - pkg.sessions_booked;
          const expiryDate = pkg.expires_at ? new Date(pkg.expires_at).toLocaleDateString() : 'Never';
          
          // Determine package type text
          let packageTypeText = 'Coach Package';
          if (pkg.package_type === 'academy') {
            packageTypeText = 'Academy Package';
          }
          
          const isSelected = selectedPackage && selectedPackage.id === pkg.id;
          
          // Check if package is active
          const isActive = pkg.status === 'active';

          // Create status badge
          let statusBadge = '';
          switch(pkg.status) {
            case 'active':
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Active</span>`;
              break;
            case 'pending':
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>`;
              break;
            case 'rejected':
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Rejected</span>`;
              break;
            case 'expired':
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">Expired</span>`;
              break;
            default:
              statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">${pkg.status || 'Unknown'}</span>`;
          }
          
          const packageDiv = document.createElement('div');
          // Use different styling based on if package is active
          packageDiv.className = `${isSelected ? 'bg-blue-200' : (isActive ? 'bg-white' : 'bg-gray-100')} p-3 rounded-lg border ${isActive ? 'border-blue-300' : 'border-gray-300'} hover:shadow-md transition-all`;
          
          packageDiv.innerHTML = `
            <div class="flex justify-between mb-1">
              <div>
                <span class="font-semibold">${pkg.pricing_plan.name}</span>
                <div class="mt-1">${statusBadge}</div>
              </div>
              <div class="text-right">
                <span class="text-blue-700">${sessionsRemaining} sessions remaining</span>
                <p class="text-xs text-gray-500 mt-1">Expires: ${expiryDate}</p>
              </div>
            </div>
            <p class="text-sm text-gray-600">${packageTypeText}</p>
            <div class="flex justify-end mt-2">
              ${isActive ? 
                `<button class="text-sm px-3 py-1 ${isSelected ? 'bg-green-600' : 'bg-blue-600'} text-white rounded-lg hover:bg-blue-700 package-select-btn" 
                  data-package-id="${pkg.id}">
                  ${isSelected ? 'Selected' : 'Use Package'}
                </button>` :
                `<button class="text-sm px-3 py-1 bg-gray-400 text-white rounded-lg cursor-not-allowed" disabled>
                  ${pkg.status === 'pending' ? 'Awaiting Approval' : 'Unavailable'}
                </button>`
              }
            </div>
          `;
          
          container.appendChild(packageDiv);
        });
        
        // Add event listeners to package selection buttons
        document.querySelectorAll('.package-select-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const packageId = parseInt(this.getAttribute('data-package-id'));
            
            // Check if this package is already selected
            if (selectedPackage && selectedPackage.id === packageId) {
              // Deselect the package
              selectedPackage = null;
              updatePackagesUI();
              
              // Reset pricing to normal
              updatePricesWithDiscount();
              return;
            }
            
            // Get the package data
            const pkg = studentPackages.find(p => p.id === packageId);
            if (!pkg) return;

            // Make sure it's active
            if (pkg.status !== 'active') {
              alert('This package is not active and cannot be used.');
              return;
            }

            // Check if there are enough sessions remaining in the package
            const sessionsRemaining = pkg.total_sessions - pkg.sessions_booked;
            if (sessionsRemaining < selectedSlots.length) {
              alert(`You've selected ${selectedSlots.length} sessions but only have ${sessionsRemaining} sessions remaining in this package.`);
              return;
            }
            
            // Set as selected package
            selectedPackage = pkg;
            
            // Update UI
            updatePackagesUI();
            
            // Update pricing to show package discount
            applyPackageDiscount();
          });
        });
      }

      function applyPackageDiscount() {
        if (!selectedPackage) return;
        
        // Check how many sessions we can apply the package to
        const sessionsRemaining = selectedPackage.total_sessions - selectedPackage.sessions_booked;
        const sessionsToApply = Math.min(sessionsRemaining, selectedSlots.length);
        
        // Sort slots by date and time so we apply the package to the earliest slots first
        const sortedSlots = [...selectedSlots].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });
        
        // Apply package discount to the first N slots where N is sessionsToApply
        for (let i = 0; i < sortedSlots.length; i++) {
          if (i < sessionsToApply) {
            // Keep court fee, but set coach fee to 0
            sortedSlots[i].discounted_price = sortedSlots[i].court_fee;
          } else {
            // Reset any remaining slots to regular price
            sortedSlots[i].discounted_price = sortedSlots[i].price;
          }
        }
        
        // Update UI
        updateSelectedTimeslotsUI();
        updateTotalPrice();
      }

      function setSelectedDate(dateStr) {
        const dateObj = new Date(dateStr);
        // Format for display
        selectedDate.textContent = dateObj.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Store the original date string in a data attribute for easy access
        selectedDate.dataset.date = dateStr;
      }

      // Generate calendar for given month/year
      function generateCalendar(year, month) {
        calendar.innerHTML = ""; // Clear previous calendar

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay(); // 0 (Sunday) to 6 (Saturday)

        // Update month/year display
        currentMonthYear.textContent = new Intl.DateTimeFormat('en-US', {
          month: 'long',
          year: 'numeric'
        }).format(firstDay);

        // Create day name headers
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        dayNames.forEach(day => {
          const dayCell = document.createElement("div");
          dayCell.textContent = day;
          dayCell.className = "mt-3 p-2 text-center font-bold";
          calendar.appendChild(dayCell);
        });

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "text-center text-gray-400";
          calendar.appendChild(emptyCell);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format: YYYY-MM-DD

          const cell = document.createElement("div");
          cell.textContent = day;
          cell.className = "text-center p-2 rounded-lg";
          cell.dataset.date = dateStr; // Add data attribute for the date

          // Determine if this date has availability data
          const hasAvailabilityData = allAvailabilities[dateStr] &&
            (allAvailabilities[dateStr].available.length > 0 ||
              allAvailabilities[dateStr].booked.length > 0);

          // Disable past dates
          if (dateObj < new Date().setHours(0, 0, 0, 0)) {
            cell.className += " bg-gray-200 text-gray-400 cursor-not-allowed";
          }
          // If court is selected and has availability
          else if (selectedCourtId && hasAvailabilityData) {
            cell.className += " bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer";
            cell.addEventListener("click", () => {
              // Remove previous selection
              document.querySelectorAll("#calendar div.selected-date").forEach(div => {
                div.classList.remove("selected-date");
              });

              // Add selection to this date
              cell.classList.add("selected-date");

              // Get the date from the data attribute
              const dateStr = cell.dataset.date;

              // Update selected date display
              setSelectedDate(dateStr);

              // Populate available time slots
              populateAvailabilityGrid(dateStr);
            });
          }
          // No availability data yet or no court selected
          else {
            cell.className += " bg-gray-200 text-gray-500 cursor-not-allowed";
          }

          calendar.appendChild(cell);
        }
      }

      // Fetch availability data for the selected court and date
      async function fetchAvailability(courtId, year, month) {
        try {
          // Reset all availabilities for this month
          allAvailabilities = {};

          // Create dates for all days in the month
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; // Format: YYYY-MM-DD

            // Don't fetch for past dates
            if (date < new Date().setHours(0, 0, 0, 0)) {
              continue;
            }

            // Fetch availability from API
            const response = await fetch(`/booking/api/availability/${coachData.id}/${courtId}/${dateStr}`);

            if (!response.ok) {
              console.error(`Failed to fetch availability for ${dateStr}`);
              continue;
            }

            const data = await response.json();

            // Store availability data including court fees and pricing plans
            allAvailabilities[dateStr] = {
              available: data.available || [],
              booked: data.booked || [],
              court_fees: data.court_fees || [],
              pricing_plans: data.pricing_plans || []
            };
          }

          // Store pricing plans globally for easy access
          availablePricingPlans = allAvailabilities[Object.keys(allAvailabilities)[0]]?.pricing_plans || [];

          // Update the pricing plan options in the UI
          updatePricingPlanOptions();

          // Regenerate calendar now that we have availability data
          generateCalendar(year, month);

        } catch (error) {
          console.error('Error fetching availability:', error);
        }
      }


      function updatePricingPlanOptions() {
        const container = document.getElementById('pricing-plans-container');
        if (!container) return;

        container.innerHTML = '';

        if (!availablePricingPlans || availablePricingPlans.length === 0) {
          container.innerHTML = `
      <p class="text-sm text-gray-500">No special pricing plans available</p>
    `;
          return;
        }

        // Check if the user is logged in
        const isLoggedIn = typeof isUserLoggedIn !== 'undefined' ? isUserLoggedIn : false;

        // For guest users, show a message about available discounts that require login
        if (!isLoggedIn) {
          // Check if there are any first-time discount plans
          const hasFirstTimeDiscounts = availablePricingPlans.some(plan => plan.first_time_only);

          if (hasFirstTimeDiscounts) {
            // Add login/register prompt for first-time discounts
            const loginPrompt = document.createElement('div');
            loginPrompt.className = 'bg-blue-50 p-4 rounded-lg mb-4 border border-blue-300';
            loginPrompt.innerHTML = `
        <div class="flex items-start">
          <div class="flex-shrink-0 mt-0.5">
            <svg class="h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Special Discounts Available!</h3>
            <div class="mt-1 text-sm text-blue-700">
              <p>First-time student discounts are available. <a href="#" class="font-bold login-btn">Login</a> or <a href="#" class="font-bold register-btn">Register</a> to access these special rates.</p>
            </div>
          </div>
        </div>
      `;
            container.appendChild(loginPrompt);

            // Add event listeners to the login/register links
            loginPrompt.querySelector('.login-btn').addEventListener('click', function (e) {
              e.preventDefault();
              // Show login modal
              showModal(loginModal);
            });

            loginPrompt.querySelector('.register-btn').addEventListener('click', function (e) {
              e.preventDefault();
              // Show registration modal
              showModal(registerModal);
            });
          }
        }

        // Function to check if user is eligible for first-time discount
        const checkFirstTimeStatus = async () => {
          if (!isLoggedIn) {
            // Guest users are not eligible for first-time discounts
            return false;
          }

          try {
            // Try to fetch previous bookings with this coach
            const response = await fetch(`/student/api/student/has-previous-bookings/${coachData.id}`);
            if (!response.ok) {
              throw new Error('Failed to check booking history');
            }

            const data = await response.json();
            return !data.has_previous_bookings;
          } catch (error) {
            console.error('Error checking first-time status:', error);
            // Default to assuming not first time when there's an error
            return false;
          }
        };

        // Update the UI based on the first-time status
        checkFirstTimeStatus().then(isFirstTime => {
          // Create HTML for each applicable pricing plan
          availablePricingPlans.forEach(plan => {
            // For guest users, only show non-first-time discount plans
            if (!isLoggedIn && plan.first_time_only) return;

            // For logged-in users, check eligibility for first-time discounts
            if (isLoggedIn && plan.first_time_only && !isFirstTime) return;

            // Skip seasonal plans outside of valid date range
            if (plan.valid_from && plan.valid_to) {
              const today = new Date();
              if (new Date(plan.valid_from) > today || new Date(plan.valid_to) < today) return;
            }

            const planDiv = document.createElement('div');
            planDiv.className = 'bg-blue-50 p-3 rounded-lg mb-2 border border-blue-200';

            let discountText = '';
            if (plan.discount_type_amount === 'percentage') {
              discountText = `${plan.discount_amount}% off`;
            } else {
              discountText = `$${plan.discount_amount} off`;
            }

            // Special display for package deals
            if (plan.discount_type === 'package') {
              planDiv.innerHTML = `
          <div class="flex justify-between mb-1">
            <span class="font-semibold">${plan.name}</span>
            <span class="text-blue-700">${discountText}</span>
          </div>
          <p class="text-sm text-gray-600">${plan.description}</p>
          <p class="text-xs text-blue-800 mt-1">Book ${plan.sessions_required} sessions to activate (${selectedSlots.length}/${plan.sessions_required} selected)</p>
          <div class="flex justify-end mt-2">
            <button class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 select-pricing-plan-btn ${selectedSlots.length >= plan.sessions_required ? '' : 'opacity-50 cursor-not-allowed'}" 
              data-plan-id="${plan.id}" ${selectedSlots.length >= plan.sessions_required ? '' : 'disabled'}>
              Select
            </button>
          </div>
        `;
            } else {
              planDiv.innerHTML = `
          <div class="flex justify-between mb-1">
            <span class="font-semibold">${plan.name}</span>
            <span class="text-blue-700">${discountText}</span>
          </div>
          <p class="text-sm text-gray-600">${plan.description}</p>
          <div class="flex justify-end mt-2">
            <button class="text-sm px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 select-pricing-plan-btn" data-plan-id="${plan.id}">
              Select
            </button>
          </div>
        `;
            }

            container.appendChild(planDiv);
          });

          // Add event listeners to the "Select" buttons
          document.querySelectorAll('.select-pricing-plan-btn').forEach(btn => {
            btn.addEventListener('click', function () {
              const planId = parseInt(this.getAttribute('data-plan-id'));

              // Find the plan data
              const plan = availablePricingPlans.find(p => p.id === planId);

              // Check if this plan is already selected
              const isAlreadySelected = selectedPricingPlan && selectedPricingPlan.id === planId;

              if (isAlreadySelected) {
                // User is clicking an already selected plan, so unselect it
                selectedPricingPlan = null;

                // Reset button to unselected state
                this.classList.remove('bg-green-600');
                this.classList.add('bg-blue-600');
                this.textContent = 'Select';

                // Update prices without discount
                updatePricesWithDiscount();
                return;
              }

              // New plan selection

              // Check if meets minimum sessions for package deals
              if (plan.discount_type === 'package' && selectedSlots.length < plan.sessions_required) {
                alert(`You need to select at least ${plan.sessions_required} sessions to use this package deal.`);
                return;
              }

              // Set selected plan
              selectedPricingPlan = plan;

              // Update UI to show selected plan
              document.querySelectorAll('.select-pricing-plan-btn').forEach(b => {
                b.classList.remove('bg-green-600');
                b.classList.add('bg-blue-600');
                b.textContent = 'Select';
              });

              this.classList.remove('bg-blue-600');
              this.classList.add('bg-green-600');
              this.textContent = 'Selected';

              // Update prices with the selected discount
              updatePricesWithDiscount();
            });
          });
        });
      }
      
      // Add this function to update prices with selected discount
      function updatePricesWithDiscount() {
        if (!selectedPricingPlan && !selectedPackage) {
          // No discount applied, reset to base prices
          selectedSlots.forEach(slot => {
            slot.discounted_price = slot.price;
          });
        } else if (selectedPackage) {
          // Apply package discount (coach fee becomes 0)
          // Check how many sessions we can apply the package to
          const sessionsRemaining = selectedPackage.total_sessions - selectedPackage.sessions_booked;
          const sessionsToApply = Math.min(sessionsRemaining, selectedSlots.length);
          
          // Sort slots by date and time so we apply the package to the earliest slots first
          const sortedSlots = [...selectedSlots].sort((a, b) => {
            const dateA = new Date(a.date + ' ' + a.time);
            const dateB = new Date(b.date + ' ' + b.time);
            return dateA - dateB;
          });
          
          // Apply package discount to the first N slots where N is sessionsToApply
          for (let i = 0; i < sortedSlots.length; i++) {
            if (i < sessionsToApply) {
              // Keep court fee, but set coach fee to 0
              sortedSlots[i].discounted_price = sortedSlots[i].court_fee;
            } else {
              // Reset any remaining slots to regular price
              sortedSlots[i].discounted_price = sortedSlots[i].price;
            }
          }
        } else if (selectedPricingPlan) {
          // Apply discount based on the selected plan
          if (selectedPricingPlan.discount_type_amount === 'percentage') {
            const discount = selectedPricingPlan.discount_amount / 100;

            selectedSlots.forEach(slot => {
              // Only apply discount to coach fee, not court fee
              const coachFee = coachData.hourly_rate;
              const discountAmount = coachFee * discount;
              slot.discounted_price = slot.price - discountAmount;
            });
          } else {
            // Fixed discount - distribute evenly across all slots
            const totalSlots = selectedSlots.length;
            const discountPerSlot = selectedPricingPlan.discount_amount / totalSlots;

            selectedSlots.forEach(slot => {
              slot.discounted_price = Math.max(0, slot.price - discountPerSlot);
            });
          }
        }

        // Update UI displays
        updateSelectedTimeslotsUI();
        updateTotalPrice();
      }

      // Populate availability grid for selected date
      function populateAvailabilityGrid(date) {
        // Define the hours to display in the grid
        const hours = [
          "08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", 
          "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", 
          "04:00 PM", "05:00 PM", "06:00 PM", "07:00 PM",
          "08:00 PM", "09:00 PM", "10:00 PM", "11:00 PM"
        ];

        availabilityGrid.innerHTML = ""; // Clear previous slots

        // Update the selectedDate element with the correctly formatted date
        const displayDate = new Date(date);
        selectedDate.textContent = displayDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        // Create a map of availability status for each hour
        const hourStatus = {};
        
        // Initialize all hours as not available
        hours.forEach(hour => {
          hourStatus[hour] = { status: 'unavailable', slotId: null, student_books_court: false };
        });
        
        // If we have availability data for the selected date, update the status
        if (allAvailabilities[date]) {
          const availability = allAvailabilities[date];
          
          // Mark available slots
          availability.available.forEach(slot => {
            if (hours.includes(slot.time)) {
              hourStatus[slot.time] = { 
                status: 'available', 
                slotId: slot.id,
                student_books_court: slot.student_books_court
              };
              
              // Store booking responsibility
              bookingResponsibilities[slot.id] = slot.student_books_court;
            }
          });
          
          // Mark booked slots
          availability.booked.forEach(slot => {
            if (hours.includes(slot.time)) {
              hourStatus[slot.time] = { 
                status: 'booked', 
                slotId: null,
                student_books_court: false
              };
            }
          });
        }
        
        // Create a time slot element for each hour in our predefined hours array
        hours.forEach(hour => {
          const timeSlot = document.createElement("div");
          timeSlot.className = "p-2 rounded-lg text-center text-sm"; // Default styling
          
          // Create inner content with time and possibly booking indicator
          const timeText = document.createElement("div");
          timeText.textContent = hour;
          
          const status = hourStatus[hour].status;
          const slotId = hourStatus[hour].slotId;
          const studentBooksCourtFlag = hourStatus[hour].student_books_court;

          // Find if this slot is in our selected slots
          const isSelected = selectedSlots.some(slot =>
            slot.date === date && slot.time === hour && slot.courtId === selectedCourtId
          );

          if (isSelected) {
            timeSlot.className += " bg-blue-500 text-white cursor-pointer";
            timeSlot.addEventListener("click", () => removeSelectedSlot(date, hour, selectedCourtId));
          }
          else if (status === 'available') {
            timeSlot.className += " bg-blue-100 text-blue-800 hover:bg-blue-200 cursor-pointer";
            timeSlot.addEventListener("click", () => addSelectedSlot(date, hour, slotId, selectedCourtId));

            // Add indicator for booking responsibility
            if (studentBooksCourtFlag) {
              const indicator = document.createElement("div");
              indicator.className = "text-xs mt-1 text-orange-600";
              indicator.innerHTML = `<i class="fas fa-calendar-check"></i> Book court`;
              timeSlot.appendChild(indicator);
            }
          }
          else if (status === 'booked') {
            timeSlot.className += " bg-orange-300 text-white cursor-not-allowed";
          }
          else {
            timeSlot.className += " bg-gray-300 text-gray-500 cursor-not-allowed";
          }
          
          timeSlot.prepend(timeText);
          availabilityGrid.appendChild(timeSlot);
        });
        
        // Display a message if there's no data for this date
        if (!allAvailabilities[date]) {
          availabilityGrid.innerHTML = "<p class='text-center text-gray-500 py-4'>No availability data for this date.</p>";
          return;
        } else if (Object.values(hourStatus).every(status => status.status === 'unavailable')) {
          availabilityGrid.innerHTML = "<p class='text-center text-gray-500 py-4'>No time slots available on this date.</p>";
          return;
        }
        
        // Update court booking info
        updateCourtBookingInfo();
      }
      
      // Add a selected time slot
      function addSelectedSlot(date, time, availabilityId, courtId) {
        // Check if already selected
        if (selectedSlots.some(slot => slot.date === date && slot.time === time && slot.courtId === courtId)) {
          return;
        }

        const courtName = courtSelect.options[courtSelect.selectedIndex].text;

        // Get availability data for this date
        const dateAvailability = allAvailabilities[date];

        // Find the specific availability item
        const availabilityItem = dateAvailability.available.find(item => item.id === availabilityId);

        // Get court fee for this time
        const courtFee = availabilityItem ? availabilityItem.court_fee : 0;
        
        // Get booking responsibility
        const studentBooksCourtFlag = availabilityItem ? availabilityItem.student_books_court : false;

        // Calculate total price (coach fee + court fee)
        const totalPrice = parseFloat(coachData.hourly_rate) + parseFloat(courtFee);

        selectedSlots.push({
          date,
          time,
          availabilityId,
          courtId,
          courtName,
          coach_fee: parseFloat(coachData.hourly_rate),
          court_fee: parseFloat(courtFee),
          price: totalPrice,
          discounted_price: totalPrice, // Will be updated if discount applied
          student_books_court: studentBooksCourtFlag // Add booking responsibility flag
        });

        // Store booking responsibility for this availability
        bookingResponsibilities[availabilityId] = studentBooksCourtFlag;

        // Update session count
        const sessionCount = document.getElementById('session-count');
        if (sessionCount) {
          sessionCount.textContent = selectedSlots.length;
        }

        // Update pricing based on what's selected
        if (selectedPackage) {
          applyPackageDiscount();
        } else if (selectedPricingPlan) {
          updatePricesWithDiscount();
        } else {
          updateSelectedTimeslotsUI();
          updateTotalPrice();
        }

        // Update package eligibility statuses
        updatePricingPlanOptions();

        // Refresh the availability grid
        populateAvailabilityGrid(date);
      }
      
      // Remove a selected time slot
      function removeSelectedSlot(date, time, courtId) {
        selectedSlots = selectedSlots.filter(slot =>
          !(slot.date === date && slot.time === time && slot.courtId === courtId)
        );

        // Update session count
        const sessionCount = document.getElementById('session-count');
        if (sessionCount) {
          sessionCount.textContent = selectedSlots.length;
        }

        // If we have a pricing plan selected, check if it's still applicable
        if (selectedPricingPlan && selectedPricingPlan.discount_type === 'package'
          && selectedSlots.length < selectedPricingPlan.sessions_required) {
          // No longer eligible for this package
          selectedPricingPlan = null;
          alert('You no longer have enough sessions selected for the package deal.');
        }

        // Update pricing and UI
        updatePricesWithDiscount();

        // Update package eligibility statuses
        updatePricingPlanOptions();

        // Refresh the availability grid
        populateAvailabilityGrid(date);
      }

      function updateCourtBookingInfo() {
        const infoContainer = document.getElementById('court-booking-info');
        const responsibilityText = document.getElementById('booking-responsibility-text');
        
        if (!infoContainer || !selectedCourtId) {
          if (infoContainer) infoContainer.classList.add('hidden');
          return;
        }
        
        // Get the selected court data
        const selectedCourt = coachData.courts.find(court => court.id === parseInt(selectedCourtId));
        if (!selectedCourt) {
          infoContainer.classList.add('hidden');
          return;
        }
        
        infoContainer.classList.remove('hidden');
        
        // Check if any of the selected slots require student to book the court
        const studentResponsible = selectedSlots.some(slot => slot.student_books_court);
        
        if (studentResponsible) {
          responsibilityText.textContent = "You are responsible for booking the court for these sessions.";
          
        } else {
          responsibilityText.textContent = "The coach will handle court bookings for these sessions.";
        }
      }

      // Update the selected timeslots UI
      function updateSelectedTimeslotsUI() {
        const container = document.getElementById('selected-timeslots');
        container.innerHTML = "";

        if (selectedSlots.length === 0) {
          // Show a message when no slots are selected
          const emptyMessage = document.createElement("div");
          emptyMessage.className = "text-gray-500 text-sm italic text-center py-2";
          emptyMessage.textContent = "No sessions selected yet";
          container.appendChild(emptyMessage);
          return;
        }

        // Sort slots by date and time
        const sortedSlots = [...selectedSlots].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });

        // Create UI elements for each selected slot
        sortedSlots.forEach(slot => {
          const slotDiv = document.createElement("div");
          slotDiv.className = "flex justify-between items-center bg-blue-100 text-blue-800 px-3 py-2 rounded-lg text-sm mb-2";

          // Format price display
          let priceDisplay = '';
          if (slot.discounted_price < slot.price) {
            // Show discount
            priceDisplay = `<span class="line-through text-gray-500">$${slot.price.toFixed(2)}</span> $${slot.discounted_price.toFixed(2)}`;
          } else {
            priceDisplay = `$${slot.price.toFixed(2)}`;
          }

          slotDiv.innerHTML = `
      <div>
        <div class="font-medium">${formatDate(slot.date)}</div>
        <div>${slot.time} at <span class="font-semibold">${slot.courtName}</span></div>
        <div class="text-xs text-blue-600 mt-1">
          Coach: $${slot.coach_fee.toFixed(2)} | Court: $${slot.court_fee.toFixed(2)}
        </div>
        <div class="font-medium">${priceDisplay}</div>
      </div>
      <button class="text-red-500 hover:text-red-700 p-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    `;

          // Add remove button functionality
          const removeButton = slotDiv.querySelector('button');
          removeButton.addEventListener('click', () => {
            removeSelectedSlot(slot.date, slot.time, slot.courtId);
          });

          container.appendChild(slotDiv);
        });
      }

      // Update total price display
      function updateTotalPrice() {
        // Calculate subtotals
        const coachTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.coach_fee), 0);
        const courtTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.court_fee), 0);

        // Calculate total with any discounts applied
        const grandTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.discounted_price), 0);

        // Update display
        currentTotal.textContent = formatMoney(grandTotal);
        currentTotalCopy.textContent = formatMoney(grandTotal);

        // Update subtotals if elements exist
        const coachTotalElement = document.getElementById('coach-fee-total');
        const courtTotalElement = document.getElementById('court-fee-total');

        if (coachTotalElement) coachTotalElement.textContent = formatMoney(coachTotal);
        if (courtTotalElement) courtTotalElement.textContent = formatMoney(courtTotal);

        // Calculate savings if any
        const originalTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.price), 0);
        const savings = originalTotal - grandTotal;

        const savingsElement = document.getElementById('total-savings');
        const savingsContainer = document.getElementById('savings-container');
        const discountInfoElement = document.getElementById('discount-info');
        const discountAmountElement = document.getElementById('discount-amount');

        if (savingsElement && savingsContainer) {
          if (savings > 0) {
            savingsElement.textContent = formatMoney(savings);
            savingsContainer.classList.remove('hidden');
            
            // Also update the discount info in fee breakdown
            if (discountInfoElement && discountAmountElement) {
              discountInfoElement.classList.remove('hidden');
              discountAmountElement.textContent = formatMoney(savings);
            }
          } else {
            savingsContainer.classList.add('hidden');
            
            if (discountInfoElement) {
              discountInfoElement.classList.add('hidden');
            }
          }
        }

        // Also update the confirmation modal if open
        const totalPriceElement = document.getElementById('total-price');
        if (totalPriceElement) {
          totalPriceElement.textContent = formatMoney(grandTotal);
        }
      }

      // Populate confirmation modal
      function populateConfirmationModal() {
        const container = document.getElementById('confirmation-timeslots');
        container.innerHTML = "";

        // Instead of a simple boolean, count different booking types
        const studentBookedSlots = selectedSlots.filter(slot => slot.student_books_court);
        const coachBookedSlots = selectedSlots.filter(slot => !slot.student_books_court);
        
        const hasStudentBookedCourts = studentBookedSlots.length > 0;
        const hasCoachBookedCourts = coachBookedSlots.length > 0;
        
        // Calculate court fees for each type
        const studentBookedCourtFees = studentBookedSlots.reduce((sum, slot) => sum + parseFloat(slot.court_fee), 0);
        const coachBookedCourtFees = coachBookedSlots.reduce((sum, slot) => sum + parseFloat(slot.court_fee), 0);
        
        // Sort slots by date and time
        const sortedSlots = [...selectedSlots].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });

        // Create UI elements for each selected slot
        sortedSlots.forEach(slot => {
          const slotDiv = document.createElement("div");
          slotDiv.className = "bg-blue-100 text-blue-800 px-4 py-3 rounded-lg mb-2";

          // Format price display
          let priceDisplay = '';
          if (slot.discounted_price < slot.price) {
            // Show discount
            priceDisplay = `<span class="line-through text-gray-500">$${slot.price.toFixed(2)}</span> $${slot.discounted_price.toFixed(2)}`;
          } else {
            priceDisplay = `$${slot.price.toFixed(2)}`;
          }

          slotDiv.innerHTML = `
            <div class="flex justify-between">
              <div>
                <span class="font-medium">${formatDate(slot.date)} at ${slot.time}</span>
                <div class="text-sm">${slot.courtName}</div>
                <div class="text-xs mt-1">Coach: $${slot.coach_fee.toFixed(2)} | Court: $${slot.court_fee.toFixed(2)}</div>
                ${slot.student_books_court ? 
                  '<div class="text-xs text-orange-600 mt-1"><i class="fas fa-info-circle"></i> You need to book this court</div>' : 
                  '<div class="text-xs text-blue-600 mt-1"><i class="fas fa-info-circle"></i> Coach will book this court</div>'}
              </div>
              <div class="font-bold">${priceDisplay}</div>
            </div>
          `;

          container.appendChild(slotDiv);
        });

        // Calculate subtotals
        const coachTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.coach_fee), 0);
        const courtTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.court_fee), 0);
        
        const grandTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.discounted_price), 0);
        const originalTotal = selectedSlots.reduce((sum, slot) => sum + parseFloat(slot.price), 0);
        const savings = originalTotal - grandTotal;
        const discountedCoachTotal = grandTotal - courtTotal;

        // Update coach payment step title
        const coachPaymentStep = document.querySelector('.payment-steps .payment-step:first-child h4');
        if (coachPaymentStep) {
          coachPaymentStep.innerHTML = `Coach Payment <span class="text-blue-600">($${formatMoney(discountedCoachTotal)})</span>`;
        }

        // Add subtotals section
        const subtotalsDiv = document.createElement('div');
        subtotalsDiv.className = 'mt-4 p-4 bg-gray-50 rounded-lg';

        subtotalsDiv.innerHTML = `
          <div class="flex justify-between mb-2">
            <span class="text-gray-600">Coach Fees:</span>
            <span>$${formatMoney(coachTotal)}</span>
          </div>
          <div class="flex justify-between mb-2">
            <span class="text-gray-600">Court Fees:</span>
            <span>$${formatMoney(courtTotal)}</span>
          </div>
        `;

        // Add discount info if applicable
        if (savings > 0) {
          subtotalsDiv.innerHTML += `
            <div class="flex justify-between mb-2 text-green-600">
              <span>Discount ${selectedPricingPlan ? `(${selectedPricingPlan.name})` : ''}:</span>
              <span>-$${formatMoney(savings)}</span>
            </div>
          `;
        }

        container.appendChild(subtotalsDiv);

        // Update total price
        document.getElementById('total-price').textContent = formatMoney(grandTotal);

        // Update session count if available
        const sessionCountElement = document.getElementById('confirmation-session-count');
        if (sessionCountElement) {
          sessionCountElement.textContent = selectedSlots.length;
        }

        // Get all required payment and booking proof elements
        const coachPaymentSection = document.getElementById('coach-payment-methods');
        const coachPaymentProofSection = document.getElementById('coach-payment-proof').closest('.mb-4');
        const courtBookingSection = document.getElementById('court-booking-section');
        const courtBookingInstructions = document.getElementById('court-booking-instructions');
        const specificCourtInstructions = document.getElementById('specific-court-instructions');
        const courtBookingText = document.getElementById('court-booking-text');
        const courtBookingLinkBox = document.getElementById('court-booking-link-box');
        const confirmationCourtLink = document.getElementById('confirmation-court-link');
        const courtBookingProofSection = document.getElementById('court-booking-proof').closest('.mb-4');
        
        // 1. Coach Payment Section (for coaching fees) - keeping this part the same...
        if (discountedCoachTotal <= 0) {
          // No coach payment needed for coaching (using a package)
          if (coachPaymentSection) {
            coachPaymentSection.innerHTML = `
              <div class="bg-green-100 p-4 rounded-lg mb-3">
                <div class="flex items-center text-green-800">
                  <i class="fas fa-check-circle mr-2"></i>
                  <p class="font-medium">No coaching fee payment required</p>
                </div>
                <p class="text-sm text-green-700 mt-1">
                  This package has pre-paid coaching fees or you are using package sessions.
                </p>
              </div>
            `;
          }
          
          // Hide coaching payment proof upload if no coaching fee
          if (coachPaymentProofSection) {
            coachPaymentProofSection.classList.add('hidden');
          }
          
          // Make the coach payment proof not required
          const coachPaymentProof = document.getElementById('coach-payment-proof');
          if (coachPaymentProof) {
            coachPaymentProof.required = false;
          }
        } else {
          // Coach payment required for coaching fee
          // Update bank account details with amount to pay
          const coachBankName = document.getElementById('coach-bank-name');
          const coachAccountName = document.getElementById('coach-account-name');
          const coachAccountNumber = document.getElementById('coach-account-number');
          
          if (coachData && coachData.payment_info) {
            const paymentInfo = coachData.payment_info;
            if (paymentInfo.bank_name && paymentInfo.account_name && paymentInfo.account_number) {
              if (coachBankName) coachBankName.textContent = paymentInfo.bank_name;
              if (coachAccountName) coachAccountName.textContent = paymentInfo.account_name;
              if (coachAccountNumber) coachAccountNumber.textContent = paymentInfo.account_number;
            } else {
              // Fallback if no payment info
              if (coachBankName) coachBankName.textContent = "Example Bank";
              if (coachAccountName) coachAccountName.textContent = `${coachData.first_name} ${coachData.last_name}`;
              if (coachAccountNumber) coachAccountNumber.textContent = "Please ask coach";
            }
            
            // Add payment amount to the bank transfer details
            const bankTransferDetails = document.getElementById('bank-transfer-details');
            if (bankTransferDetails) {
              // Remove any existing payment note
              const existingPaymentNote = bankTransferDetails.querySelector('.payment-note');
              if (existingPaymentNote) {
                existingPaymentNote.remove();
              }
              
              // Add payment note
              const paymentNote = document.createElement('p');
              paymentNote.className = 'font-bold text-blue-700 mt-2 payment-note';
              paymentNote.innerHTML = `Amount to pay: $${formatMoney(discountedCoachTotal)} (coaching fee only)`;
              bankTransferDetails.appendChild(paymentNote);
            }
          }
          
          // Show coaching payment proof upload
          if (coachPaymentProofSection) {
            coachPaymentProofSection.classList.remove('hidden');
            
            // Update label to clarify this is for coaching fee only
            const coachPaymentLabel = coachPaymentProofSection.querySelector('label');
            if (coachPaymentLabel) {
              coachPaymentLabel.textContent = "Upload Coach Payment Proof (Coaching Fee)";
            }
          }
          
          // Make the coach payment proof required
          const coachPaymentProof = document.getElementById('coach-payment-proof');
          if (coachPaymentProof) {
            coachPaymentProof.required = true;
          }
        }

        // 2. Court Payment/Booking Section - allow for mixed court booking responsibilities
        if (courtBookingSection) {
          // Always show the section if there are any court fees
          if (hasStudentBookedCourts || hasCoachBookedCourts) {
            courtBookingSection.classList.remove('hidden');
            
            // Update section title
            const courtSectionTitle = courtBookingSection.querySelector('h4');
            if (courtSectionTitle) {
              // Show total court fees - this can be mixed
              courtSectionTitle.innerHTML = `Court Fees <span class="text-blue-600">($${formatMoney(studentBookedCourtFees + coachBookedCourtFees)})</span>`;
            }
            
            // Set the appropriate text for the court booking section
            if (courtBookingText) {
              if (hasStudentBookedCourts && hasCoachBookedCourts) {
                courtBookingText.innerHTML = `<strong>Mixed Court Bookings:</strong> Some courts you need to book directly, and some will be booked by the coach:`;
              } else if (hasStudentBookedCourts) {
                courtBookingText.innerHTML = `Please book your court and pay the venue directly:`;
              } else {
                courtBookingText.innerHTML = `The coach will book these courts. Please transfer the court fee to the coach:`;
              }
            }
            
            // Clear and populate specific court instructions
            if (specificCourtInstructions) {
              specificCourtInstructions.innerHTML = '';
              
              // If there are student-booked courts
              if (hasStudentBookedCourts) {
                const studentSection = document.createElement('div');
                studentSection.className = 'mb-4';
                
                if (hasCoachBookedCourts) {
                  // Add a section title if we have both types
                  studentSection.innerHTML = `
                    <h6 class="font-medium text-sm mb-2 text-orange-700">Courts YOU Need to Book ($${formatMoney(studentBookedCourtFees)}):</h6>
                  `;
                }
                
                // Add the court list
                const studentCourtList = document.createElement('ul');
                studentCourtList.className = 'list-disc pl-5 text-sm space-y-1';
                
                studentBookedSlots.forEach(slot => {
                  const listItem = document.createElement('li');
                  listItem.innerHTML = `${formatDate(slot.date)} at ${slot.time} - ${slot.courtName} ($${formatMoney(slot.court_fee)})`;
                  studentCourtList.appendChild(listItem);
                });
                
                studentSection.appendChild(studentCourtList);
                specificCourtInstructions.appendChild(studentSection);
                
                // Show the court booking link
                if (courtBookingLinkBox && confirmationCourtLink) {
                  const selectedCourt = coachData.courts.find(court => court.id === parseInt(selectedCourtId));
                  
                  if (selectedCourt && selectedCourt.booking_link) {
                    confirmationCourtLink.href = selectedCourt.booking_link;
                    courtBookingLinkBox.classList.remove('hidden');
                  } else {
                    courtBookingLinkBox.classList.add('hidden');
                  }
                }
              }
              
              // If there are coach-booked courts
              if (hasCoachBookedCourts) {
                const coachSection = document.createElement('div');
                
                if (hasStudentBookedCourts) {
                  // Add a section title if we have both types
                  coachSection.innerHTML = `
                    <h6 class="font-medium text-sm mb-2 mt-4 text-blue-700">Courts the COACH Will Book ($${formatMoney(coachBookedCourtFees)}):</h6>
                  `;
                }
                
                // Add the court list
                const coachCourtList = document.createElement('ul');
                coachCourtList.className = 'list-disc pl-5 text-sm space-y-1';
                
                coachBookedSlots.forEach(slot => {
                  const listItem = document.createElement('li');
                  listItem.innerHTML = `${formatDate(slot.date)} at ${slot.time} (1 Hour) - ${slot.courtName} ($${formatMoney(slot.court_fee)})`;
                  coachCourtList.appendChild(listItem);
                });
                
                coachSection.appendChild(coachCourtList);
                
                // Add coach payment details for court fees
                if (coachData.payment_info && coachData.payment_info.court_payment_details) {
                  // If coach has specific court payment details
                  const courtPayInfo = coachData.payment_info.court_payment_details;
                  const paymentDetails = document.createElement('div');
                  paymentDetails.className = 'mt-2 text-sm pl-5';
                  paymentDetails.innerHTML = `
                    <p class="font-medium">Payment Details:</p>
                    <p>${courtPayInfo}</p>
                    <p class="font-bold text-blue-700 mt-1">Amount to pay: $${formatMoney(coachBookedCourtFees)}</p>
                  `;
                  coachSection.appendChild(paymentDetails);
                } else {
                  // Default to same payment details as coaching
                  const paymentDetails = document.createElement('div');
                  paymentDetails.className = 'mt-2 text-sm pl-5';
                  paymentDetails.innerHTML = `
                    <p class="font-medium">Payment Details:</p>
                    <p>Use the same payment details as above for coaching payment.</p>
                    <p class="font-bold text-blue-700 mt-1">Amount to pay: $${formatMoney(coachBookedCourtFees)}</p>
                  `;
                  coachSection.appendChild(paymentDetails);
                }
                
                specificCourtInstructions.appendChild(coachSection);
                
                // Hide court booking link for coach-booked courts section
                if (hasStudentBookedCourts === false && courtBookingLinkBox) {
                  courtBookingLinkBox.classList.add('hidden');
                }
              }
            }
            
            // Court proof section - always show if there are any court fees
            if (studentBookedCourtFees + coachBookedCourtFees > 0) {
              if (courtBookingProofSection) {
                courtBookingProofSection.classList.remove('hidden');
                
                // Update label based on the mix of responsibilities
                const courtProofLabel = courtBookingProofSection.querySelector('label');
                if (courtProofLabel) {
                  if (hasStudentBookedCourts && !hasCoachBookedCourts) {
                    courtProofLabel.textContent = "Upload Court Booking Proof";
                  } else if (!hasStudentBookedCourts && hasCoachBookedCourts) {
                    courtProofLabel.textContent = "Upload Court Fee Payment Proof";
                  } else {
                    courtProofLabel.textContent = "Upload Court Booking/Payment Proof";
                  }
                }
              }
              
              // Make court proof required
              const courtBookingProof = document.getElementById('court-booking-proof');
              if (courtBookingProof) {
                courtBookingProof.required = true;
              }
            } else {
              // Hide court proof section if no fee
              if (courtBookingProofSection) {
                courtBookingProofSection.classList.add('hidden');
              }
              
              // Make court proof not required
              const courtBookingProof = document.getElementById('court-booking-proof');
              if (courtBookingProof) {
                courtBookingProof.required = false;
              }
            }
          } else {
            // No court fees at all - hide the section
            courtBookingSection.classList.add('hidden');
          }
        }

        // Reset the file upload forms and previews
        const coachPaymentPreview = document.getElementById('coach-payment-preview');
        const courtBookingPreview = document.getElementById('court-booking-preview');
        if (coachPaymentPreview) coachPaymentPreview.innerHTML = '';
        if (courtBookingPreview) courtBookingPreview.innerHTML = '';
        
        // Reset the file inputs
        const coachPaymentProof = document.getElementById('coach-payment-proof');
        const courtBookingProof = document.getElementById('court-booking-proof');
        if (coachPaymentProof) coachPaymentProof.value = '';
        if (courtBookingProof) courtBookingProof.value = '';
      }

      // Add a new function to update court booking section with amounts
      function updateCourtBookingSectionWithAmounts(courtTotal) {
        const specificCourtInstructions = document.getElementById('specific-court-instructions');
        if (!specificCourtInstructions) return;
        
        // Get court booking instructions from coach data or use defaults
        let courtBookingInstructions = "Please book the VIP courts for your session. Regular courts may not be suitable for coaching.";
        
        if (coachData.court_booking_instructions) {
          courtBookingInstructions = coachData.court_booking_instructions;
        }
        
        // Add the instructions
        specificCourtInstructions.innerHTML = `
          <div class="text-sm text-gray-700 mb-3">
            <p class="mb-2">${courtBookingInstructions}</p>
            <p class="font-bold text-blue-700">Total court fee: $${formatMoney(courtTotal)}</p>
          </div>
        `;
        
        // Add specific court booking details
        const courtsThatNeedBooking = selectedSlots.filter(slot => slot.student_books_court);
        if (courtsThatNeedBooking.length > 0) {
          const bookingList = document.createElement('ul');
          bookingList.className = 'list-disc list-inside text-sm text-gray-700 space-y-2';
          
          // Create a map to group by court and date
          const courtDateMap = new Map();
          
          courtsThatNeedBooking.forEach(slot => {
            const courtKey = `${slot.courtId}-${slot.date}`;
            if (!courtDateMap.has(courtKey)) {
              courtDateMap.set(courtKey, {
                courtName: slot.courtName,
                date: slot.date,
                times: [],
                fees: 0
              });
            }
            
            const entry = courtDateMap.get(courtKey);
            entry.times.push(slot.time);
            entry.fees += parseFloat(slot.court_fee);
          });
          
          // Create list items for each court and date
          courtDateMap.forEach(entry => {
            const prettyDate = new Date(entry.date).toLocaleDateString('en-US', {
              weekday: 'short',
              month: 'short',
              day: 'numeric'
            });
            
            // Format each time with start-end (assuming 1 hour sessions)
            const formattedTimes = entry.times.map(time => {
              const startTimeParts = time.match(/(\d+):(\d+) ([AP]M)/);
              
              if (startTimeParts) {
                let startHour = parseInt(startTimeParts[1]);
                const startMinute = parseInt(startTimeParts[2]);
                const period = startTimeParts[3];
                
                // Convert to 24-hour format
                if (period === 'PM' && startHour < 12) startHour += 12;
                if (period === 'AM' && startHour === 12) startHour = 0;
                
                // Calculate end time (add 1 hour)
                let endHour = startHour + 1;
                let endPeriod = period;
                
                // Handle period change
                if (endHour === 12 && period === 'AM') endPeriod = 'PM';
                else if (endHour === 24) {
                  endHour = 12;
                  endPeriod = 'AM';
                }
                // Convert back to 12-hour format
                if (endHour > 12) endHour -= 12;
                
                const endTime = `${endHour}:${startMinute.toString().padStart(2, '0')} ${endPeriod}`;
                return `${time}-${endTime}`;
              } else {
                return time;
              }
            });
            
            const listItem = document.createElement('li');
            listItem.innerHTML = `
              <span class="font-medium">${prettyDate} at ${entry.courtName}</span><br>
              <span>Times: ${formattedTimes.join(', ')}</span><br>
              <span class="text-blue-600">Fee: $${formatMoney(entry.fees)}</span>
            `;
            bookingList.appendChild(listItem);
          });
          
          specificCourtInstructions.appendChild(bookingList);
        }
      }

      // Add this function to update the court fee information display
      function updateCourtFeeInfo() {
        const container = document.getElementById('court-fee-info');
        if (!container) return;

        if (!selectedCourtId || !allAvailabilities) {
          container.innerHTML = '<p>Select a court to view fee information.</p>';
          return;
        }

        // Get the first date that has court fee information
        const firstDateWithFees = Object.keys(allAvailabilities).find(date =>
          allAvailabilities[date]?.court_fees?.length > 0
        );

        if (!firstDateWithFees) {
          container.innerHTML = '<p>No fee information available for this court.</p>';
          return;
        }

        const fees = allAvailabilities[firstDateWithFees].court_fees;

        if (fees.length === 0) {
          container.innerHTML = '<p>No fee information available for this court.</p>';
          return;
        }

        let html = '<div class="space-y-2">';

        fees.forEach(fee => {
          html += `
      <div class="flex justify-between">
        <span>${fee.start_time} - ${fee.end_time}</span>
        <span class="font-semibold">$${fee.fee}/hour</span>
      </div>
    `;
        });

        html += '</div>';
        container.innerHTML = html;
      }

      if (coachPaymentProof) {
        coachPaymentProof.addEventListener('change', function(e) {
          handleFilePreview(this, coachPaymentPreview);
        });
      }
  
      if (courtBookingProof) {
        courtBookingProof.addEventListener('change', function(e) {
          handleFilePreview(this, courtBookingPreview);
        });
      }
  
      function handleFilePreview(input, previewContainer) {
        previewContainer.innerHTML = '';
        
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'max-h-32 rounded-lg shadow-sm';
            previewContainer.appendChild(img);
          }
          
          reader.readAsDataURL(file);
        }
      }

      function updateCoachPaymentInfo() {
        // Check if we have payment info in coach data
        if (coachData.payment_info) {
          const paymentInfo = coachData.payment_info;
          
          // Bank transfer details
          if (paymentInfo.bank_name && paymentInfo.account_name && paymentInfo.account_number) {
            const coachBankName = document.getElementById('coach-bank-name');
            const coachAccountName = document.getElementById('coach-account-name');
            const coachAccountNumber = document.getElementById('coach-account-number');
            
            if (coachBankName) coachBankName.textContent = paymentInfo.bank_name;
            if (coachAccountName) coachAccountName.textContent = paymentInfo.account_name;
            if (coachAccountNumber) coachAccountNumber.textContent = paymentInfo.account_number;
            
            document.getElementById('bank-transfer-details').classList.remove('hidden');
          } else {
            // Fallback values
            const coachBankName = document.getElementById('coach-bank-name');
            const coachAccountName = document.getElementById('coach-account-name');
            const coachAccountNumber = document.getElementById('coach-account-number');
            
            if (coachBankName) coachBankName.textContent = "Example Bank";
            if (coachAccountName) coachAccountName.textContent = `${coachData.first_name} ${coachData.last_name}`;
            if (coachAccountNumber) coachAccountNumber.textContent = "Please ask coach";
          }
          
          // QR code if available
          if (paymentInfo.qr_code_url) {
            const coachQrCode = document.getElementById('coach-qr-code');
            const qrPaymentDetails = document.getElementById('qr-payment-details');
            
            if (coachQrCode) {
              coachQrCode.innerHTML = `<img src="${paymentInfo.qr_code_url}" alt="Payment QR Code" class="w-full h-full object-contain">`;
            }
            if (qrPaymentDetails) {
              qrPaymentDetails.classList.remove('hidden');
            }
          }
        } else {
          // Fallback values if no payment info
          const coachBankName = document.getElementById('coach-bank-name');
          const coachAccountName = document.getElementById('coach-account-name');
          const coachAccountNumber = document.getElementById('coach-account-number');
          
          if (coachBankName) coachBankName.textContent = "Example Bank";
          if (coachAccountName) coachAccountName.textContent = `${coachData.first_name} ${coachData.last_name}`;
          if (coachAccountNumber) coachAccountNumber.textContent = "Please ask coach";
        }
      }

      // Add this function to handle booking submissions with payment proofs
      async function submitBooking(userData = null) {
        try {
          // Show loading overlay
          loadingOverlay.classList.remove('hidden');
          
          if (!reservationToken) {
              alert('Your session has expired. Please go back and select time slots again.');
              return;
          }

          // Prepare the FormData object for file uploads
          const formData = new FormData();
          formData.append('reservation_token', reservationToken);

          // Get the file inputs
          const coachPaymentProofFile = document.getElementById('coach-payment-proof').files[0];
          const courtBookingProofFile = document.getElementById('court-booking-proof')?.files[0];
          
          // Append files if available
          if (coachPaymentProofFile) {
            formData.append('coach_payment_proof', coachPaymentProofFile);
          } else {
            throw new Error('Coach payment proof is required');
          }
          
          // Check if court booking proof is required and provided
          const courtBookingSection = document.getElementById('court-booking-section');
          const courtBookingRequired = !courtBookingSection.classList.contains('hidden');
          
          if (courtBookingRequired && !courtBookingProofFile) {
            throw new Error('Court booking proof is required');
          } else if (courtBookingRequired && courtBookingProofFile) {
            formData.append('court_booking_proof', courtBookingProofFile);
          }
          
          // Group availabilities by court
          const courtAvailabilities = {};
          
          selectedSlots.forEach(slot => {
            if (!courtAvailabilities[slot.courtId]) {
              courtAvailabilities[slot.courtId] = [];
            }
            courtAvailabilities[slot.courtId].push(slot.availabilityId);
          });
          
          // Prepare the bookings data
          const bookingsData = Object.keys(courtAvailabilities).map(courtId => ({
            coach_id: coachData.id,
            court_id: parseInt(courtId),
            availability_ids: courtAvailabilities[courtId],
            pricing_plan_id: selectedPricingPlan ? selectedPricingPlan.id : null,
            package_id: selectedPackage ? selectedPackage.id : null
          }));
          
          // Add the bookings data to the form
          formData.append('bookings', JSON.stringify(bookingsData));
          
          // Add user data if provided (for guest booking)
          if (userData) {
            formData.append('user_data', JSON.stringify(userData));
          }
          
          // Send the booking request to a new endpoint that handles file uploads
          const response = await fetch('/booking/api/bookings/create-with-proofs', {
            method: 'POST',
            body: formData
          });
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          if (!response.ok) {
              // Handle specific error codes
              if (result.code === 'RESERVATION_EXPIRED') {
                  alert('Your reservation has expired. Please go back and select time slots again.');
                  hideAllModals();
                  showModal(scheduleModal);
              } else if (result.code === 'SLOT_UNAVAILABLE') {
                  alert('One or more selected slots are no longer available. Please choose different times.');
                  hideAllModals();
                  showModal(scheduleModal);
                  
                  // Refresh availability
                  await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
                  if (selectedDate.dataset.date) {
                      populateAvailabilityGrid(selectedDate.dataset.date);
                  }
              } else {
                  alert(result.error || 'Booking failed. Please try again.');
              }
              
              loadingOverlay.classList.add('hidden');
              return;
          }
          
          const result = await response.json();
          
          // Store the booking ID for reference
          successfulBookingId = result.bookings && result.bookings.length > 0 
            ? result.bookings[0].id 
            : null;
          
          // Clear countdown timer
          if (countdownInterval) {
              clearInterval(countdownInterval);
          }

          // Show success message
          hideAllModals();
          
          // Update confirmation number in success modal
          document.getElementById('confirmation-number').textContent = result.confirmation_number;
          
          // Show success modal
          showModal(successModal);
          
          // Reset state
          selectedSlots = [];
          selectedPricingPlan = null;
          selectedPackage = null;
          selectedCourtId = null;
          bookingResponsibilities = {};
          reservationToken = null;
          reservationExpiry = null;
          updateSelectedTimeslotsUI();
          updateTotalPrice();
          
          return result;
          
        } catch (error) {
          console.error('Error creating booking:', error);
          loadingOverlay.classList.add('hidden');
          alert(`Booking failed: ${error.message}`);
          throw error;
        }
      }
      
      // Add function to handle package purchase submission
      async function submitPackagePurchase(event) {
        event.preventDefault();
        
        if (!isUserLoggedIn) {
          alert('Please log in to purchase packages.');
          return;
        }
        
        try {
          // Show loading overlay
          loadingOverlay.classList.remove('hidden');
          
          // Get form data
          const formData = new FormData(packagePurchaseForm);
          
          // Verify payment proof is uploaded
          if (!packagePaymentProof.files[0]) {
            alert('Please upload payment proof for the package.');
            loadingOverlay.classList.add('hidden');
            return;
          }
          
          // Send the package purchase request
          const response = await fetch('/api/packages/purchase', {
            method: 'POST',
            body: formData
          });
          
          // Hide loading overlay
          loadingOverlay.classList.add('hidden');
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to purchase package');
          }
          
          const result = await response.json();
          
          // Show success message
          hideAllModals();
          
          // Show package success modal
          showModal(packageSuccessModal);
          
          // Reset form
          packagePurchaseForm.reset();
          packagePaymentPreview.innerHTML = '';
          
          fetchStudentPackages();
          return result;
          
        } catch (error) {
          console.error('Error purchasing package:', error);
          loadingOverlay.classList.add('hidden');
          alert(`Package purchase failed: ${error.message}`);
        }
      }

      // Event Listeners

      // Court selection change
      courtSelect.addEventListener('change', async function () {
        const newCourtId = parseInt(this.value);
        
        if (selectedSlots.length >= 1) {
          if (window.confirm("You can only book sessions at one court at a time. Your previous selected bookings will be removed. Continue?")) {
            // Reset state
            selectedSlots = [];
            selectedPricingPlan = null;
            selectedPackage = null;
            bookingResponsibilities = {};
            updateSelectedTimeslotsUI();
            updateTotalPrice();
            
            // Set the new court ID
            selectedCourtId = newCourtId;
            
            // Store the new selection
            previousCourtId = newCourtId;
          } else {
            // User canceled, revert to previous selection
            this.value = previousCourtId || "";
            return; // Exit the function
          }
        } else {
          // No slots selected, just update the court ID
          selectedCourtId = newCourtId;
          previousCourtId = newCourtId;
        }

        if (selectedCourtId) {
          // Update court booking link if available
          const selectedCourt = coachData.courts.find(court => court.id === selectedCourtId);

          // Show loading animations for each section that will update
          animateElementUpdate(document.getElementById('calendar-container'), true);
          animateElementUpdate(document.getElementById('court-fee-info'), true);
          animateElementUpdate(document.getElementById('availability-grid'), true);

          // Wait for availability data to be fetched
          await fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
          availabilityGrid.innerHTML = "";
          selectedDate.textContent = "";

          const sessionCount = document.getElementById('session-count');
          sessionCount.textContent = 0;

          // Update the UI components
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
          updateCourtFeeInfo();

          // Remove loading animations
          animateElementUpdate(document.getElementById('calendar-container'), false);
          animateElementUpdate(document.getElementById('court-fee-info'), false);
          animateElementUpdate(document.getElementById('availability-grid'), false);
          
          // Add completion animation
          animateCompletion();

        } else {
          allAvailabilities = {};

          // Show loading animations
          animateElementUpdate(document.getElementById('calendar-container'), true);
          animateElementUpdate(document.getElementById('court-fee-info'), true);
          animateElementUpdate(document.getElementById('availability-grid'), true);

          // Update UI
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

          // Clear availability grid
          availabilityGrid.innerHTML = "";
          selectedDate.textContent = "";
          updateCourtFeeInfo();

          // Remove loading animations
          animateElementUpdate(document.getElementById('calendar-container'), false);
          animateElementUpdate(document.getElementById('court-fee-info'), false);
          animateElementUpdate(document.getElementById('availability-grid'), false);
        }
      });

      // Animation helper functions
      function animateElementUpdate(element, isLoading) {
        if (!element) return;

        if (isLoading) {
          // Apply loading state
          element.classList.add('animate-pulse', 'opacity-60');

          // Optional: add a subtle background flash
          element.classList.add('transition-colors', 'duration-500');
          element.dataset.originalBg = element.style.backgroundColor || 'transparent';
          element.style.backgroundColor = 'rgba(219, 234, 254, 0.4)'; // light blue background
        } else {
          // Remove loading state
          element.classList.remove('animate-pulse', 'opacity-60');

          // Restore original background
          if (element.dataset.originalBg) {
            element.style.backgroundColor = element.dataset.originalBg;
          }
        }
      }

      function animateCompletion() {
        // Create a completion notification
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg transform translate-y-20 opacity-0 transition-all duration-500';
        notification.innerHTML = `
  <div class="z-50 flex items-center">
    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    <span>Court information updated</span>
  </div>
`;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove('translate-y-20', 'opacity-0');
        }, 100);

        // Animate out and remove
        setTimeout(() => {
          notification.classList.add('translate-y-20', 'opacity-0');
          setTimeout(() => {
            notification.remove();
          }, 500);
        }, 3000);
      }

      // Previous month button
      document.getElementById('prev-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        if (selectedCourtId) {
          fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
        } else {
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
      });

      // Next month button
      document.getElementById('next-month').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        if (selectedCourtId) {
          fetchAvailability(selectedCourtId, currentDate.getFullYear(), currentDate.getMonth());
        } else {
          generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
      });

      // Schedule button
      scheduleBtn.addEventListener('click', () => {
        showModal(scheduleModal);
        // Initialize calendar for the current month
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
      });

      // Continue to booking button
      scheduleButton.addEventListener('click', async function() {
        if (selectedSlots.length === 0) {
          alert('Please select at least one time slot to continue.');
          return;
        }

        await reserveSelectedSlots();
      });

      // Cancel button
      document.getElementById('cancel-button').addEventListener('click', () => {
        hideAllModals();
      });

      // Confirm button
      document.getElementById('confirm-button').addEventListener('click', () => {
        if (isUserLoggedIn) {
          // User is logged in, proceed with booking
          submitBooking();
        } else {
          // User is not logged in, show guest info modal
          showModal(guestInfoModal);
        }
      });

      // Success modal done button
      document.getElementById('success-done-btn').addEventListener('click', () => {
        hideAllModals();
      });
      
      // Package purchase form submission
      if (packagePurchaseForm) {
        packagePurchaseForm.addEventListener('submit', submitPackagePurchase);
      }
      
      // Close package modal buttons
      if (closePackageModal) {
        closePackageModal.addEventListener('click', () => {
          hideAllModals();
        });
      }
      
      if (packageCancelButton) {
        packageCancelButton.addEventListener('click', () => {
          hideAllModals();
        });
      }
      
      // Package success done button
      if (packageSuccessDoneBtn) {
        packageSuccessDoneBtn.addEventListener('click', () => {
          hideAllModals();
        });
      }

      // Scroll animations
      const scrollSections = document.querySelectorAll('.scroll-section');

      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
          }
        });
      }, { threshold: 0.1 });

      scrollSections.forEach(section => {
        observer.observe(section);
      });

      // Add this function to periodically refresh availability data
      function setupAvailabilityRefresh() {
          // Refresh availability data every 30 seconds
          setInterval(async function() {
              if (selectedCourtId && selectedDate.dataset.date) {
                  // Only refresh if court and date are selected
                  const currentDateObj = new Date(selectedDate.dataset.date);
                  
                  // Store previously available slots for comparison
                  const previouslyAvailable = allAvailabilities[selectedDate.dataset.date]?.available || [];
                  
                  // Fetch updated availability data
                  await fetchAvailability(selectedCourtId, currentDateObj.getFullYear(), currentDateObj.getMonth());
                  
                  // Update grid without clearing selection
                  populateAvailabilityGrid(selectedDate.dataset.date);
                  
                  // Check if any selected slots are no longer available
                  const newlyAvailable = allAvailabilities[selectedDate.dataset.date]?.available || [];
                  const newAvailIds = newlyAvailable.map(a => a.id);
                  
                  // Filter out any selected slots that are no longer available
                  selectedSlots = selectedSlots.filter(slot => {
                      // Skip slots from other dates or courts
                      if (slot.date !== selectedDate.dataset.date || slot.courtId !== selectedCourtId) {
                          return true;
                      }
                      
                      // Check if the availability ID is still present in the updated data
                      if (!newAvailIds.includes(slot.availabilityId)) {
                          // No longer available - remove it
                          return false;
                      }
                      
                      return true;
                  });
                  
                  // Update UI to reflect any changes
                  updateSelectedTimeslotsUI();
                  updateTotalPrice();
              }
          }, 30000); // Every 30 seconds
      }

      // Initialize
      // Extract coach id from URL
      const coachId =  {{ coach.id }}  || 1; // Default to 1 if no ID is provided
      fetchCoachData(coachId);
      setupAvailabilityRefresh();
//   });
  </script>
{% endblock %}